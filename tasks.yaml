name: merge-review-drawer
summary: >
  3 tasks completing test coverage and visual documentation for the merge review drawer
  feature. Phase 1 adds comprehensive server action unit tests (1 task, ~150 lines).
  Phase 2 adds missing Storybook story variants (1 task, ~45 lines). Phase 3 validates
  the complete implementation (1 task, full test suite + E2E smoke test).

relatedFeatures: []
technologies: []
relatedLinks: []

tasks:
  # ── Phase 1: Server Action Testing Foundation ─────────────────────────────

  - id: task-1
    phaseId: phase-1
    title: 'Write comprehensive unit tests for get-merge-review-data server action'
    description: >
      Create tests/unit/presentation/web/app/actions/get-merge-review-data.test.ts following
      the TDD principle. Write tests for all conditional branches: input validation (empty/
      whitespace featureId), feature not found error, successful data mapping (PR metadata,
      branch construction, plan phases, diff summary), plan loading failure (graceful
      degradation), diff summary failure (graceful fallback), missing PR scenario, and
      missing worktree scenario. Use vi.mock('@/lib/server-container') for DI token mocking
      following the pattern in approve-feature.test.ts and reject-feature.test.ts.
    state: Todo
    dependencies: []
    acceptanceCriteria:
      - 'Test file exists at tests/unit/presentation/web/app/actions/get-merge-review-data.test.ts'
      - 'Mocks resolve() via vi.mock with token-based resolution for IFeatureRepository, IGitPrService, GetPlanArtifactUseCase'
      - 'beforeEach clears all mocks with vi.clearAllMocks()'
      - 'Test: empty featureId returns { error: "Feature id is required" }'
      - 'Test: whitespace-only featureId (e.g., "   ") returns { error: "Feature id is required" }'
      - 'Test: feature not found (findById returns null) returns { error: "Feature not found" }'
      - 'Test: complete happy path returns MergeReviewData with pr, diffSummary, phases, branch'
      - 'Test: PR metadata correctly extracted (url, number, status, commitHash, ciStatus) from Feature.pr'
      - 'Test: branch info constructed with source=feature.branch, target="main"'
      - 'Test: plan loading throws → phases undefined, no overall error, data still returns'
      - 'Test: worktreePath undefined → skips diff entirely, returns data without diffSummary, no warning if PR exists'
      - 'Test: worktreePath exists but getPrDiffSummary throws → returns data with warning "Diff statistics unavailable"'
      - 'Test: no PR (feature.pr is undefined) and no worktreePath → returns warning "No PR or diff data available"'
      - 'Test: outer try/catch for unexpected errors → returns { error: string }'
      - 'Uses expectTypeOf() to validate discriminated union return type'
      - 'All tests pass with pnpm test:unit'
      - '100% branch coverage for server action (all conditional paths tested)'
    tdd:
      red:
        - >
          Write all test cases in describe blocks: "Input Validation" (empty/whitespace featureId),
          "Error Handling" (feature not found, DI errors), "Data Mapping" (PR extraction, branch
          construction), "Graceful Degradation" (plan failure, worktree missing, diff failure,
          combined failures), "Happy Path" (complete data with all fields). Mock resolve() to
          return repository, service, and use case mocks. Each test configures mocks for specific
          scenarios (e.g., findById returns null, getPrDiffSummary throws). Run tests, verify they
          fail because production code behavior is being tested.
      green:
        - >
          The server action is already implemented (get-merge-review-data.ts exists from spec).
          Run tests against the actual implementation. If tests fail unexpectedly, investigate
          whether the test setup is incorrect (e.g., mock configuration) or if there's a bug
          in the production code. Fix the production code or test as appropriate to achieve green.
      refactor:
        - >
          Extract shared mock factory functions (e.g., mockFeatureRepository(), mockGitPrService(),
          mockPlanArtifactUseCase()) to reduce duplication. Add helper function makeFeatureWithPr()
          to build test Feature objects with different field combinations. Ensure test descriptions
          clearly communicate what behavior is being verified. Add comments for complex mock
          configurations (e.g., nested try/catch scenarios).
    estimatedEffort: '2h'

  # ── Phase 2: Storybook Documentation Enhancement ───────────────────────────

  - id: task-2
    phaseId: phase-2
    title: 'Add merge review story variants to feature node and control center'
    description: >
      Add MergeReviewActionRequired story variant to feature-node.stories.tsx (~15 lines)
      showing emerald badge with GitMerge icon, lifecycle='review', state='action-required'.
      Add merge review feature nodes to control-center.stories.tsx multi-feature variants
      (~30 lines across 3 existing stories like MultipleFeatures, FullWorkflowStates).
      This completes visual documentation coverage for the merge review visualization,
      matching the comprehensive standards already established in merge-review.stories.tsx
      (11 variants).
    state: Todo
    dependencies:
      - task-1
    acceptanceCriteria:
      - 'feature-node.stories.tsx has MergeReviewActionRequired story variant'
      - 'Story shows emerald badge (bg-emerald-50, text-emerald-700) with GitMerge icon'
      - 'Story data: lifecycle="review", state="action-required", name="User Authentication", other required fields'
      - 'control-center.stories.tsx MultipleFeatures variant includes merge review node'
      - 'control-center.stories.tsx FullWorkflowStates variant includes merge review node'
      - 'Merge review nodes have descriptive name/description (e.g., "Merge Review", "PR ready for merge approval")'
      - 'Merge review nodes positioned in canvas to avoid overlap with existing nodes'
      - 'Stories render without errors in Storybook (pnpm dev:storybook)'
      - 'Visual verification: emerald badge displays correctly on canvas'
    tdd:
      red:
        - >
          Review existing feature-node.stories.tsx and control-center.stories.tsx structure.
          Identify where to add new story variants. Verify that merge review node does not
          already exist in control center stories. The "failing" step is confirming the absence
          of these story variants.
      green:
        - >
          Add MergeReviewActionRequired export to feature-node.stories.tsx with args matching
          the spec pattern (lifecycle: 'review', state: 'action-required'). Add merge review
          feature nodes to the featureNodes arrays in MultipleFeatures and FullWorkflowStates
          control center stories, positioned appropriately in the canvas (e.g., x: 800, y: 400).
          Run Storybook locally to verify stories render correctly.
      refactor:
        - >
          Ensure consistent positioning and sizing with other feature nodes in multi-feature stories.
          Verify merge review node descriptions are clear and concise. Extract shared merge review
          node data to a const if used in multiple stories (DRY principle).
    estimatedEffort: '1h'

  # ── Phase 3: Integration Validation & Quality Assurance ────────────────────

  - id: task-3
    phaseId: phase-3
    title: 'Run full validation suite and verify all success criteria'
    description: >
      Execute the complete validation workflow: pnpm test (unit tests including new server
      action tests from task-1), pnpm validate (lint + format + typecheck + tsp compile),
      visual regression testing in Storybook (review all merge review story variants), and
      E2E smoke test (create feature → implement → merge phase → approve → verify agent resumes).
      Verify all 12 success criteria from the spec are met. Document any remaining issues or
      follow-up work needed. This is the final quality gate before shipping.
    state: Todo
    dependencies:
      - task-2
    acceptanceCriteria:
      - 'pnpm test passes with all tests green (including task-1 server action tests)'
      - 'pnpm validate passes (lint, format, typecheck, tsp compile)'
      - 'No new TypeScript errors related to merge review feature'
      - 'No new ESLint warnings related to merge review feature'
      - 'Storybook builds successfully (pnpm build-storybook or visual check with pnpm dev:storybook)'
      - 'Visual verification: all 11+ merge-review.stories.tsx variants render correctly'
      - 'Visual verification: MergeReviewActionRequired feature node story shows emerald badge'
      - 'Visual verification: control center stories show merge review nodes integrated with other lifecycle phases'
      - 'Manual smoke test: create feature → advance to merge phase → click merge review node → drawer opens with PR data → approve button works → agent resumes'
      - 'All 12 spec success criteria verified (FR-1 emerald badge, FR-3 drawer opens, FR-4 PR metadata, FR-5 diff summary, FR-6 CI status, FR-7 phases, FR-8 branch direction, FR-9 approve button, FR-10 reject button, FR-13 input validation, FR-18 graceful degradation, FR-15 test coverage)'
      - 'Document any known limitations or follow-up work in commit message or spec'
    tdd:
      red:
        - >
          Run pnpm test to establish baseline. Identify any failing tests not related to
          this feature (pre-existing failures). Run pnpm validate to identify any lint/format/
          typecheck errors. Start Storybook and review all merge review stories for visual issues.
      green:
        - >
          Fix any validation failures found. If tests fail, debug and fix. If lint errors exist,
          run pnpm lint:fix. If typecheck errors exist, resolve type issues. If stories have
          visual bugs, adjust component styling or story data. For E2E smoke test, either run
          automated Playwright test if available, or manually verify the workflow end-to-end
          using pnpm dev:cli and pnpm dev:web.
      refactor:
        - >
          Final cleanup pass: remove any TODO comments added during implementation, verify all
          files follow established conventions (no console.logs, consistent naming, proper
          JSDoc comments). Update CLAUDE.md or feature spec with any lessons learned or
          architectural notes for future maintainers. Prepare concise commit message summarizing
          the work (tests + stories completion for merge review drawer).
    estimatedEffort: '2h'

totalEstimate: '5h'
openQuestions: []

content: |
  ## Summary

  The implementation completes the remaining 5% of the merge review drawer feature by adding
  comprehensive test coverage and visual documentation.

  **Phase 1 (Server Action Tests)** writes ~150 lines of unit tests for get-merge-review-data.ts,
  covering all conditional branches: input validation (empty/whitespace featureId), feature not
  found error, successful data mapping (PR metadata, branch, phases, diff), plan loading failure
  (best-effort degradation), diff summary failure (graceful fallback), missing PR scenario, and
  missing worktree scenario. Tests follow the established pattern from approve-feature.test.ts
  and reject-feature.test.ts using vi.mock('@/lib/server-container') for DI token mocking. This
  achieves 100% branch coverage for the server action, meeting the mandatory TDD requirement
  from CLAUDE.md.

  **Phase 2 (Storybook Stories)** adds ~45 lines across feature-node.stories.tsx and
  control-center.stories.tsx. The MergeReviewActionRequired story variant shows the emerald
  badge with GitMerge icon for the review lifecycle. Multi-feature control center stories
  (MultipleFeatures, FullWorkflowStates) gain merge review nodes positioned in the canvas
  to document how the merge approval gate appears alongside other lifecycle phases. This
  maintains consistency with the comprehensive coverage standards already established in
  merge-review.stories.tsx (11 variants).

  **Phase 3 (Validation)** runs the full quality gate: pnpm test (unit tests pass), pnpm validate
  (lint/format/typecheck pass), Storybook visual regression (all stories render correctly), and
  E2E smoke test (create feature → merge phase → approve → agent resumes). Verifies all 12
  success criteria from the spec are met. Documents any remaining issues or follow-up work.

  The feature is 95% complete at the start of this plan. The remaining work focuses exclusively
  on closing test coverage gaps (mandatory TDD compliance) and adding story variants (visual
  documentation). All core functionality (components, server actions, control center integration,
  feature node badge) is already implemented and working, as confirmed in the spec's
  "Already Implemented" section.
