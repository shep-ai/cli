name: merge-review-drawer
summary: >
  11 tasks across 4 phases implementing the merge review drawer feature. Phases progress
  from feature node badge updates (2 tasks), through server action and data types (2 tasks),
  to the merge review component suite (4 tasks), and finally control center integration
  with story updates (3 tasks).

relatedFeatures: []
technologies: []
relatedLinks: []

tasks:
  # ── Phase 1: Feature Node Badge Updates ──────────────────────────────────

  - id: task-1
    phaseId: phase-1
    title: 'Add merge node to lifecycle phase mapping in page.tsx'
    description: >
      Add the entry `merge: 'review'` to the `nodeToLifecyclePhase` map in page.tsx so that
      when the agent graph is at the merge node, the UI lifecycle resolves to 'review'. Without
      this mapping, features at the merge node would fall through to the domain lifecycleMap
      and may not reflect the correct phase for badge rendering.
    state: Todo
    dependencies: []
    acceptanceCriteria:
      - 'nodeToLifecyclePhase contains `merge: "review"` entry'
      - 'A feature with agentNode="merge" resolves lifecycle to "review" in the page data flow'
      - 'TypeScript compiles without errors (pnpm typecheck:web)'
    tdd:
      red:
        - >
          Write a unit test that imports nodeToLifecyclePhase (or tests the lifecycle derivation
          logic) and asserts that the key "merge" maps to "review". The test should fail because
          the mapping doesn't exist yet.
      green:
        - >
          Add `merge: 'review'` to the nodeToLifecyclePhase record in page.tsx (single line
          addition at line 34).
      refactor:
        - 'No refactoring needed — single line addition.'
    estimatedEffort: '15min'

  - id: task-2
    phaseId: phase-1
    title: 'Add review lifecycle badge to feature node'
    description: >
      Add the review lifecycle case to three functions in feature-node.tsx: getBadgeIcon()
      returns GitMerge, getActionRequiredBadgeClasses() returns emerald colors, and getBadgeText()
      returns "Review Merge Request". These three additions make the feature node visually
      distinct for the merge review state.
    state: Todo
    dependencies:
      - task-1
    acceptanceCriteria:
      - 'getBadgeIcon returns GitMerge when lifecycle="review" and state="action-required"'
      - 'getActionRequiredBadgeClasses returns { badgeClass: "text-emerald-700", badgeBgClass: "bg-emerald-50" } for review lifecycle'
      - 'getBadgeText returns "Review Merge Request" when lifecycle="review" and state="action-required"'
      - 'GitMerge is imported from lucide-react'
      - 'TypeScript compiles without errors'
      - 'No changes to other lifecycle cases'
    tdd:
      red:
        - >
          Write tests for getBadgeIcon, getActionRequiredBadgeClasses, and getBadgeText
          that assert the expected return values when data.lifecycle="review" and
          data.state="action-required". Tests fail because the review cases don't exist.
      green:
        - >
          Add `import { GitMerge } from 'lucide-react'` to feature-node.tsx. Add
          `if (data.lifecycle === 'review') return GitMerge;` to getBadgeIcon. Add
          `if (data.lifecycle === 'review') return { badgeClass: 'text-emerald-700', badgeBgClass: 'bg-emerald-50' };`
          to getActionRequiredBadgeClasses. Add `if (data.lifecycle === 'review') return 'Review Merge Request';`
          to getBadgeText's action-required case.
      refactor:
        - 'Verify consistent ordering of lifecycle checks across the three functions (requirements → implementation → review).'
    estimatedEffort: '30min'

  # ── Phase 2: Server Action & Data Types ──────────────────────────────────

  - id: task-3
    phaseId: phase-2
    title: 'Define MergeReviewData interface in merge-review-config.ts'
    description: >
      Create the merge-review-config.ts file with MergeReviewData (combining PullRequest
      fields and optional DiffSummary), MergeReviewProps (content component props), and
      MergeReviewDrawerProps (extending with drawer shell props). This establishes the data
      contract before building the server action or components.
    state: Todo
    dependencies: []
    acceptanceCriteria:
      - 'MergeReviewData interface includes pr (with url, number, status, commitHash?, ciStatus?) and optional diffSummary (filesChanged, additions, deletions, commitCount)'
      - 'MergeReviewData includes optional warning string for degraded state messaging'
      - 'MergeReviewProps includes data, onApprove callback, and optional isProcessing flag'
      - 'MergeReviewDrawerProps extends MergeReviewProps with open, onClose, featureName, featureId, repositoryPath, branch, specPath, onDelete, isDeleting'
      - 'Uses PrStatus and CiStatus enums from @shepai/core/domain/generated/output'
      - 'File lives at components/common/merge-review/merge-review-config.ts'
      - 'TypeScript compiles without errors'
    tdd:
      red:
        - >
          Write a type-level test (or compile-time check) that creates a MergeReviewData
          literal with all required fields and asserts it satisfies the interface. Fails
          because the file and interfaces don't exist yet.
      green:
        - >
          Create merge-review-config.ts with the three interfaces. Import PrStatus and
          CiStatus from @shepai/core/domain/generated/output. Structure MergeReviewData
          with a pr object containing url, number, status, commitHash?, ciStatus?, plus
          optional diffSummary and warning fields.
      refactor:
        - 'Add JSDoc comments to each interface and key fields, following the pattern in tech-decisions-review-config.ts.'
    estimatedEffort: '20min'

  - id: task-4
    phaseId: phase-2
    title: 'Create getMergeReviewData server action'
    description: >
      Create the server action at app/actions/get-merge-review-data.ts that validates the
      featureId input, resolves IFeatureRepository to read Feature.pr, and calls
      IGitPrService.getPrDiffSummary() with graceful fallback. Returns MergeReviewData on
      success or { error } on failure. Follows the exact pattern of get-research-artifact.ts.
    state: Todo
    dependencies:
      - task-3
    acceptanceCriteria:
      - "Server action has 'use server' directive"
      - 'Validates featureId is non-empty string, returns { error } if empty'
      - 'Resolves IFeatureRepository via resolve() and calls findById(featureId)'
      - 'Returns { error } if feature not found or feature.pr is null'
      - 'Extracts pr metadata (url, number, status, commitHash, ciStatus) from Feature.pr'
      - 'Attempts IGitPrService.getPrDiffSummary(feature.worktreePath, "main") in nested try/catch'
      - 'If diff fails, returns MergeReviewData with diffSummary omitted and warning message set'
      - 'If diff succeeds, returns MergeReviewData with diffSummary populated'
      - 'Returns { error } with descriptive message on outer catch'
      - 'TypeScript compiles without errors'
    tdd:
      red:
        - >
          Write tests mocking IFeatureRepository and IGitPrService that assert: (1) empty
          featureId returns error, (2) missing feature returns error, (3) feature without PR
          returns error, (4) successful PR + diff returns full data, (5) successful PR but
          failed diff returns data with warning and no diffSummary. All tests fail because
          the server action doesn't exist.
      green:
        - >
          Create get-merge-review-data.ts with 'use server' directive. Validate featureId,
          resolve IFeatureRepository, read feature.pr, attempt diff summary in nested
          try/catch, return MergeReviewData or { error }. Import MergeReviewData from the
          config file.
      refactor:
        - 'Extract the pr field mapping to a helper function if it improves readability. Ensure error messages are descriptive and user-facing.'
    estimatedEffort: '45min'

  # ── Phase 3: Merge Review Component Suite ────────────────────────────────

  - id: task-5
    phaseId: phase-3
    title: 'Build MergeReview content component'
    description: >
      Create merge-review.tsx — the read-only content component displaying PR metadata,
      diff summary statistics, CI status badge, commit hash, and an "Approve Merge" button.
      Renders graceful fallback when diff summary is unavailable. No chat input, no multi-step
      flow. Uses shadcn/ui Badge for CI status with Lucide icons.
    state: Todo
    dependencies:
      - task-3
    acceptanceCriteria:
      - 'Displays PR number as clickable external link (target="_blank" rel="noopener noreferrer") with ExternalLink icon'
      - 'Displays PR status text (Open/Merged/Closed)'
      - 'Displays CI status as color-coded badge: green/CheckCircle2 for Success, yellow/Loader2 (animate-spin) for Pending, red/XCircle for Failure'
      - 'CI status badge includes text label alongside icon (accessibility)'
      - 'Omits CI section entirely when ciStatus is undefined'
      - 'Displays diff summary when available: files changed, "+N" additions, "-N" deletions, commit count'
      - 'Shows warning message instead of diff section when warning prop is set and diffSummary is absent'
      - 'Displays truncated commit hash (7 chars) when commitHash is available'
      - 'Renders "Approve Merge" button that calls onApprove callback'
      - 'Approve button shows disabled/processing state when isProcessing is true'
      - 'Component accepts MergeReviewProps from config'
      - 'TypeScript compiles without errors'
      - 'ESLint passes (pnpm lint:web)'
    tdd:
      red:
        - >
          Write rendering tests that assert: (1) PR link renders with correct href and
          target attributes, (2) CI badge renders correct colors and icons for each CiStatus,
          (3) diff stats render with correct formatting, (4) warning message renders when
          diffSummary is absent, (5) approve button calls onApprove, (6) approve button
          disabled when isProcessing. Tests fail because the component doesn't exist.
      green:
        - >
          Create merge-review.tsx with the content layout. Import Badge from shadcn/ui,
          Lucide icons, and MergeReviewProps. Build sections: PR header with link, status
          indicators, diff stats grid, and approve button footer.
      refactor:
        - >
          Extract CI status badge rendering to a small helper function if it improves
          readability. Ensure consistent spacing and layout with tech-decisions-review.tsx.
    estimatedEffort: '1.5h'

  - id: task-6
    phaseId: phase-3
    title: 'Build MergeReviewDrawer shell wrapper'
    description: >
      Create merge-review-drawer.tsx — a thin wrapper that destructures MergeReviewDrawerProps,
      passes shell props to ReviewDrawerShell, and renders MergeReview as children. Follows
      the exact pattern of tech-decisions-drawer.tsx (35 lines).
    state: Todo
    dependencies:
      - task-5
    acceptanceCriteria:
      - 'Destructures open, onClose, featureName, featureId, repositoryPath, branch, specPath, onDelete, isDeleting from props'
      - 'Spreads remaining props (...reviewProps) to MergeReview content component'
      - 'Wraps MergeReview in ReviewDrawerShell with all shell props'
      - 'Exports MergeReviewDrawer as named export'
      - 'TypeScript compiles without errors'
    tdd:
      red:
        - >
          Write a render test asserting MergeReviewDrawer renders ReviewDrawerShell with the
          correct feature metadata props and MergeReview as child content. Fails because the
          component doesn't exist.
      green:
        - >
          Create merge-review-drawer.tsx following the tech-decisions-drawer.tsx pattern
          exactly. Import ReviewDrawerShell, MergeReview, and MergeReviewDrawerProps.
      refactor:
        - 'No refactoring needed — simple wrapper following established pattern.'
    estimatedEffort: '15min'

  - id: task-7
    phaseId: phase-3
    title: 'Create barrel export and Storybook stories for merge review'
    description: >
      Create index.ts barrel export and merge-review.stories.tsx with comprehensive variant
      coverage. Stories test the content component directly (not through the drawer) following
      the pattern where stories don't invoke server actions. Variants cover all data states
      and edge cases.
    state: Todo
    dependencies:
      - task-6
    acceptanceCriteria:
      - 'index.ts exports MergeReview, MergeReviewDrawer, MergeReviewProps, MergeReviewDrawerProps, MergeReviewData'
      - 'Stories file is colocated at merge-review.stories.tsx'
      - 'Story variant: Default — all data present (PR metadata + diff summary + CI success)'
      - 'Story variant: CIPending — CI status is Pending with Loader2 animation'
      - 'Story variant: CIFailure — CI status is Failure with red XCircle'
      - 'Story variant: NoDiffSummary — diff unavailable, shows warning message'
      - 'Story variant: NoCIStatus — ciStatus undefined, CI section omitted'
      - 'Story variant: Processing — isProcessing=true, approve button disabled'
      - 'Story variant: InDrawer — rendered inside MergeReviewDrawer with shell'
      - 'All stories render without Storybook errors'
      - 'ESLint passes (pnpm lint:web)'
    tdd:
      red:
        - >
          Write a smoke test importing the barrel export and asserting all expected exports
          are defined. Fails because index.ts doesn't exist. Also verify stories file
          compiles and exports the expected story names.
      green:
        - >
          Create index.ts with named exports. Create merge-review.stories.tsx with meta
          configuration (title: 'Common/MergeReview'), story data fixtures for each variant,
          and render functions. Use the content component directly for most stories, drawer
          wrapper for the InDrawer variant.
      refactor:
        - 'Extract shared story data fixtures to a const at the top of the stories file for DRY variant definitions.'
    estimatedEffort: '1h'

  - id: task-8
    phaseId: phase-3
    title: 'Verify merge review component suite builds and renders'
    description: >
      Run typecheck, lint, and Storybook build to verify the entire merge review component
      suite compiles and renders correctly. Fix any issues found. This is a quality gate
      before integration.
    state: Todo
    dependencies:
      - task-7
    acceptanceCriteria:
      - 'pnpm typecheck:web passes with no errors'
      - 'pnpm lint:web passes with no new warnings'
      - 'pnpm build:storybook completes successfully'
      - 'All merge review stories render in Storybook without errors'
    tdd:
      red:
        - 'Run pnpm typecheck:web — expect pass (or identify type errors to fix).'
        - 'Run pnpm lint:web — expect pass (or identify lint issues to fix).'
      green:
        - 'Fix any type errors or lint warnings found during verification.'
      refactor:
        - 'Clean up any temporary workarounds used during development.'
    estimatedEffort: '20min'

  # ── Phase 4: Control Center Integration & Story Updates ──────────────────

  - id: task-9
    phaseId: phase-4
    title: 'Integrate merge review drawer into control center'
    description: >
      Add the merge review drawer integration to control-center-inner.tsx following the exact
      same pattern as PRD and Tech Decision drawers: state declarations (mergeReviewData,
      isLoadingMergeReview), visibility boolean (showMergeReviewDrawer), useEffect with
      cancellation for data fetching, handleMergeApprove callback, conditional rendering
      of MergeReviewDrawer, and FeatureDrawer suppression extension.
    state: Todo
    dependencies:
      - task-8
      - task-4
    acceptanceCriteria:
      - 'State: mergeReviewData (MergeReviewData | null), isLoadingMergeReview (boolean)'
      - 'showMergeReviewDrawer derived as lifecycle === "review" && state === "action-required"'
      - 'useEffect keyed on mergeFeatureId with cancellation pattern fetches getMergeReviewData'
      - 'useEffect resets mergeReviewData to null when featureId changes'
      - 'Error from server action shows toast.error'
      - 'handleMergeApprove calls approveFeature(featureId), shows success toast "Merge approved — agent resuming", calls clearSelection on success'
      - 'handleMergeApprove shows error toast on failure without clearing selection'
      - 'MergeReviewDrawer rendered conditionally when mergeReviewData is not null'
      - 'MergeReviewDrawer receives all required props: open, onClose, featureName, featureId, repositoryPath, branch, specPath, data, onApprove, onDelete, isDeleting, isProcessing'
      - 'FeatureDrawer suppression condition extended to include showMergeReviewDrawer'
      - 'Import getMergeReviewData and MergeReviewDrawer added to file imports'
      - 'TypeScript compiles without errors'
    tdd:
      red:
        - >
          Write tests that assert: (1) showMergeReviewDrawer is true when lifecycle="review"
          and state="action-required", (2) getMergeReviewData is called when showMergeReviewDrawer
          becomes true, (3) MergeReviewDrawer renders when mergeReviewData is loaded,
          (4) FeatureDrawer receives null when showMergeReviewDrawer is true,
          (5) handleMergeApprove calls approveFeature and shows correct toast. Tests fail
          because the integration doesn't exist.
      green:
        - >
          Add imports for getMergeReviewData and MergeReviewDrawer. Add state declarations.
          Add showMergeReviewDrawer boolean. Add useEffect with cancellation. Add
          handleMergeApprove callback. Add conditional MergeReviewDrawer render. Extend
          FeatureDrawer suppression condition.
      refactor:
        - >
          Consider extracting the FeatureDrawer suppression condition to a named boolean
          (isSpecialDrawerActive) for readability now that there are three drawer types.
    estimatedEffort: '1h'

  - id: task-10
    phaseId: phase-4
    title: 'Add feature node story variant for review + action-required'
    description: >
      Add a story variant to feature-node.stories.tsx showing the feature node with
      lifecycle="review" and state="action-required" to visually verify the emerald badge
      with GitMerge icon and "Review Merge Request" text.
    state: Todo
    dependencies:
      - task-2
    acceptanceCriteria:
      - 'New story data entry with lifecycle="review", state="action-required", meaningful name and description'
      - 'Story renders node with emerald badge background, emerald text, GitMerge icon, and "Review Merge Request" text'
      - 'Story is visible in Storybook under the FeatureNode story group'
      - 'Existing stories are unmodified'
    tdd:
      red:
        - >
          Verify that no existing story variant covers lifecycle="review" + state="action-required".
          Write a story that uses this data combination — the rendering should show the
          emerald badge (depends on task-2 being complete).
      green:
        - >
          Add a FeatureNodeData entry to the stories file with lifecycle="review",
          state="action-required", and a descriptive name like "Merge Review". Include it
          in the AllStates grid or as a standalone story.
      refactor:
        - 'Ensure the new variant is positioned logically among existing variants (e.g., after the implementation action-required variant).'
    estimatedEffort: '15min'

  - id: task-11
    phaseId: phase-4
    title: 'Add control center story variant for merge review drawer and run final validation'
    description: >
      Add a story variant to control-center.stories.tsx showing a feature node in
      review + action-required state. Run the full validation suite (typecheck, lint, test,
      Storybook build) to ensure everything works end-to-end.
    state: Todo
    dependencies:
      - task-9
      - task-10
    acceptanceCriteria:
      - 'Control center story includes a feature node with lifecycle="review" and state="action-required"'
      - 'Story renders in Storybook without errors'
      - 'pnpm typecheck:web passes'
      - 'pnpm lint:web passes'
      - 'pnpm test passes (all existing tests continue to pass)'
      - 'pnpm build:storybook succeeds'
    tdd:
      red:
        - 'Run pnpm typecheck:web, pnpm lint:web, and pnpm test to establish baseline.'
      green:
        - >
          Add a feature node entry to control-center.stories.tsx with lifecycle="review",
          state="action-required" in the featureNodes array. Fix any validation failures.
      refactor:
        - 'Final pass: verify all acceptance criteria from the spec are met. Clean up any TODO comments left during development.'
    estimatedEffort: '30min'

totalEstimate: '6h'
openQuestions: []

content: |
  ## Summary

  The implementation follows a bottom-up dependency chain across 11 tasks in 4 phases.

  First, the feature node gets updated with the merge lifecycle mapping and emerald badge
  styling (Phase 1, tasks 1-2). This is the simplest change and establishes the visual
  foundation.

  Next, the data layer is built: the MergeReviewData interface and the getMergeReviewData
  server action (Phase 2, tasks 3-4). The server action follows the get-research-artifact.ts
  pattern exactly, with a nested try/catch for graceful diff summary degradation.

  Then the component suite is built following the established 5-file pattern: config types,
  content component, drawer wrapper, stories, and barrel export (Phase 3, tasks 5-8). The
  content component is simpler than both existing drawers — read-only display with a single
  approve button, no chat input, no multi-step stepper.

  Finally, the control center wires everything together by adding state, useEffect,
  approval handler, and conditional rendering following the exact inline pattern used by
  PRD and Tech Decision drawers (Phase 4, tasks 9-11). Story variants are added to both
  feature-node and control-center stories for visual verification.

  Every task is scoped to produce a testable, independently verifiable increment. The total
  estimate of 6 hours accounts for TDD overhead (~30%) on a feature that is well-understood
  and follows proven patterns throughout.
