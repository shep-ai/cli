name: merge-review-drawer
summary: >
  12 tasks across 4 phases implementing the merge review drawer feature. Phase 1 establishes
  the data foundation (types + server action with TDD, 3 tasks). Phase 2 adds feature node
  badge visualization (1 task). Phase 3 builds the 5-file component suite with stories and
  tests (4 tasks). Phase 4 wires everything into the control center and adds story variants
  (4 tasks). Total estimated effort: 7.5 hours.

relatedFeatures: []
technologies: []
relatedLinks: []

tasks:
  # ── Phase 1: Foundation — Types, Server Action & Unit Tests ───────────

  - id: task-1
    phaseId: phase-1
    title: 'Define MergeReviewData interfaces in merge-review-config.ts'
    description: >
      Create merge-review-config.ts with 7 interfaces: MergeReviewDiffSummary (filesChanged,
      additions, deletions, commitCount), MergeReviewPr (url, number, status, commitHash?,
      ciStatus?), MergeReviewPhase (id, name, description?), MergeReviewBranch (source, target),
      MergeReviewData (pr?, diffSummary?, phases?, branch?, warning?), MergeReviewProps (data,
      onApprove, onReject?, isProcessing?, isRejecting?), MergeReviewDrawerProps (extends with
      shell props). This establishes the data contract before any server action or component work.
    state: Todo
    dependencies: []
    acceptanceCriteria:
      - 'File lives at components/common/merge-review/merge-review-config.ts'
      - 'MergeReviewDiffSummary has filesChanged, additions, deletions, commitCount (all number)'
      - 'MergeReviewPr has url (string), number (number), status (PrStatus), commitHash? (string), ciStatus? (CiStatus)'
      - 'MergeReviewPhase has id (string), name (string), description? (string)'
      - 'MergeReviewBranch has source (string), target (string)'
      - 'MergeReviewData has pr?, diffSummary?, phases?, branch?, warning? (all optional)'
      - 'MergeReviewProps has data (MergeReviewData), onApprove (() => void), onReject? ((feedback: string) => void), isProcessing? (boolean), isRejecting? (boolean)'
      - 'MergeReviewDrawerProps extends Omit<MergeReviewProps, "data"> with data (MergeReviewData | null), open, onClose, featureName, featureId?, repositoryPath?, branch?, specPath?, onDelete?, isDeleting?'
      - 'PrStatus and CiStatus imported from @shepai/core/domain/generated/output'
      - 'JSDoc comments on each interface and key fields'
      - 'TypeScript compiles without errors'
    tdd:
      red:
        - >
          Write a type-level test that creates MergeReviewData and MergeReviewDrawerProps
          literals with all fields and asserts type compatibility. Test imports from the
          config file — fails because the file does not exist yet.
      green:
        - >
          Create merge-review-config.ts with all 7 interfaces. Import PrStatus and CiStatus
          from generated output. Add JSDoc comments following the pattern in
          tech-decisions-review-config.ts.
      refactor:
        - 'Verify field naming consistency with domain types (PullRequest, DiffSummary). Ensure JSDoc is concise and useful.'
    estimatedEffort: '25min'

  - id: task-2
    phaseId: phase-1
    title: 'Create getMergeReviewData server action'
    description: >
      Create the server action at app/actions/get-merge-review-data.ts that validates featureId,
      resolves IFeatureRepository to read Feature, extracts PR metadata from Feature.pr,
      constructs branch direction from Feature.branch, loads plan phases from
      GetPlanArtifactUseCase (best-effort), and calls IGitPrService.getPrDiffSummary() with
      graceful fallback. Returns MergeReviewData | { error: string } discriminated union.
      Follows the pattern of get-feature-artifact.ts and get-research-artifact.ts.
    state: Todo
    dependencies:
      - task-1
    acceptanceCriteria:
      - "Server action has 'use server' directive"
      - 'Validates featureId is non-empty string, returns { error: "Feature id is required" } if empty/whitespace'
      - 'Resolves IFeatureRepository via resolve() and calls findById(featureId)'
      - 'Returns { error: "Feature not found" } if feature is null'
      - 'Extracts pr = { url, number, status, commitHash, ciStatus } from Feature.pr when present, undefined when absent'
      - 'Constructs branch = { source: feature.branch, target: "main" } when feature.branch is present, undefined when absent'
      - 'Resolves GetPlanArtifactUseCase and calls execute(featureId) in inner try/catch — maps phases to MergeReviewPhase[], undefined on failure'
      - 'Checks feature.worktreePath: if undefined, returns result without diff call (no warning when PR exists, warning when no PR)'
      - 'Resolves IGitPrService and calls getPrDiffSummary(feature.worktreePath, "main") in inner try/catch'
      - 'If diff succeeds, returns full MergeReviewData with diffSummary'
      - 'If diff fails, returns MergeReviewData without diffSummary, with warning "Diff statistics unavailable"'
      - 'Outer catch returns { error: message } for Error instances, generic message for non-Error throws'
      - 'Imports MergeReviewData and MergeReviewPhase from merge-review-config.ts'
      - 'TypeScript compiles without errors'
    tdd:
      red:
        - >
          Write tests with mocked DI container (IFeatureRepository, IGitPrService,
          GetPlanArtifactUseCase) asserting: (1) empty featureId returns error, (2) whitespace
          featureId returns error, (3) feature not found returns error, (4) no PR + no worktree
          returns warning, (5) full data with PR + diff returns complete MergeReviewData,
          (6) diff failure returns data with warning, (7) worktreePath undefined skips diff call,
          (8) minimal PR without optional fields, (9) phases available returns phases array,
          (10) phases unavailable returns undefined phases, (11) branch from feature.branch,
          (12) no branch when feature.branch is undefined, (13) repository throws returns error,
          (14) non-Error throw returns generic message. All tests fail because action doesn't exist.
      green:
        - >
          Create get-merge-review-data.ts with 'use server' directive. Implement validation,
          DI resolution, PR extraction, branch construction, plan phase loading (best-effort),
          diff summary (graceful fallback), and error handling. ~65 lines.
      refactor:
        - 'Ensure error messages are consistent and user-facing. Verify import paths are correct.'
    estimatedEffort: '1h'

  - id: task-3
    phaseId: phase-1
    title: 'Create barrel export for merge-review directory'
    description: >
      Create index.ts barrel export for the merge-review directory. Initially exports only
      config types since the components are not yet built. Will be updated in Phase 3 when
      components are created.
    state: Todo
    dependencies:
      - task-1
    acceptanceCriteria:
      - 'File lives at components/common/merge-review/index.ts'
      - 'Exports MergeReviewData, MergeReviewProps, MergeReviewDrawerProps types from config'
      - 'TypeScript compiles without errors'
    tdd:
      red:
        - >
          Write a test importing from the barrel export path and asserting the type exports
          are available. Fails because index.ts doesn't exist.
      green:
        - 'Create index.ts with type re-exports from merge-review-config.'
      refactor:
        - 'No refactoring needed — simple barrel file.'
    estimatedEffort: '5min'

  # ── Phase 2: Feature Node Badge — Emerald/GitMerge Visualization ──────

  - id: task-4
    phaseId: phase-2
    title: 'Add review lifecycle badge to feature node'
    description: >
      Add the review lifecycle case to three functions in feature-node.tsx: getBadgeIcon()
      returns GitMerge when lifecycle='review', getActionRequiredBadgeClasses() returns
      emerald colors (text-emerald-700, bg-emerald-50), and getBadgeText() returns
      "Review Merge Request". Import GitMerge from lucide-react. These additions create the
      amber → indigo → emerald visual progression for review states on the canvas.
    state: Todo
    dependencies: []
    acceptanceCriteria:
      - 'getBadgeIcon returns GitMerge when lifecycle="review" and state="action-required"'
      - 'getActionRequiredBadgeClasses returns { badgeClass: "text-emerald-700", badgeBgClass: "bg-emerald-50" } for lifecycle="review"'
      - 'getBadgeText returns "Review Merge Request" when lifecycle="review" and state="action-required"'
      - 'GitMerge is imported from lucide-react'
      - 'Existing lifecycle cases (requirements, implementation) are unchanged'
      - 'Review cases are ordered after implementation in each function (consistent ordering)'
      - 'TypeScript compiles without errors'
      - 'Existing feature-node tests continue to pass'
    tdd:
      red:
        - >
          Write unit tests asserting: (1) getBadgeIcon returns GitMerge for
          { state: 'action-required', lifecycle: 'review' }, (2) getActionRequiredBadgeClasses
          returns emerald classes for lifecycle='review', (3) getBadgeText returns
          'Review Merge Request' for { state: 'action-required', lifecycle: 'review' }.
          Tests fail because the review cases don't exist in the functions.
      green:
        - >
          Add GitMerge to lucide-react imports. Add review case to getBadgeIcon (1 line),
          getActionRequiredBadgeClasses (2 lines), getBadgeText (1 line). Each addition
          mirrors the existing implementation case pattern.
      refactor:
        - 'Verify consistent ordering: requirements → implementation → review in all three functions.'
    estimatedEffort: '30min'

  # ── Phase 3: Merge Review Component — Content, Drawer Shell & Stories ──

  - id: task-5
    phaseId: phase-3
    title: 'Build MergeReview content component'
    description: >
      Create merge-review.tsx — the content component displaying: (1) emerald status dot
      header with title and contextual description, (2) branch direction pill (source → target
      with GitBranch and ArrowRight icons), (3) PR metadata card (number as external link,
      status badge, CI status via CiStatusBadge, commit hash truncated to 7 chars), (4) diff
      summary 4-column grid (files, +additions green, -deletions red, commits), (5) warning
      with AlertTriangle when diff unavailable, (6) implementation phases numbered list via
      PhaseList sub-component, (7) DrawerActionBar with "Approve Merge" button (GitMerge icon)
      and optional reject. ~196 lines.
    state: Todo
    dependencies:
      - task-1
    acceptanceCriteria:
      - 'Component accepts MergeReviewProps from config'
      - 'Renders emerald status dot header with "Merge Review" title'
      - 'Shows contextual description: "Review the pull request details..." when PR exists, "Review the changes..." when no PR'
      - 'Renders branch direction pill when branch data provided: source Badge → ArrowRight → target Badge with GitBranch icon'
      - 'Renders PR number as clickable external link with target="_blank" rel="noopener noreferrer" and ExternalLink icon'
      - 'Renders PR status as outline Badge'
      - 'Renders CI status via existing CiStatusBadge component when pr.ciStatus exists'
      - 'Omits CI section when ciStatus is undefined'
      - 'Renders commit hash truncated to 7 chars with GitCommitHorizontal icon when commitHash exists'
      - 'Renders diff summary 4-column grid: files changed, +additions (green-600), -deletions (red-600), commits'
      - 'Shows AlertTriangle warning when diffSummary absent and warning string provided'
      - 'Renders PhaseList sub-component with numbered implementation phases when phases array is non-empty'
      - 'Renders DrawerActionBar with approveLabel="Approve Merge", GitMerge icon (or Loader2 when processing)'
      - 'Approve button calls onApprove callback'
      - 'Approve button disabled when isProcessing'
      - 'Omits PR card entirely when data.pr is undefined (no crash)'
      - 'Omits branch section when data.branch is undefined'
      - 'Omits phases section when data.phases is undefined or empty'
    tdd:
      red:
        - >
          Write rendering tests asserting: (1) PR link renders with correct href and target
          attributes, (2) PR status text displayed, (3) CiStatusBadge renders correct text
          for each CiStatus variant (Passing/Pending/Failing), (4) CI section omitted when
          ciStatus undefined, (5) diff stats render with correct formatting (+N/-N),
          (6) warning renders when diffSummary absent, (7) commit hash truncated to 7 chars,
          (8) branch names displayed when branch provided, (9) branch section omitted when
          undefined, (10) phases rendered when provided, (11) phases section omitted when
          undefined, (12) approve button calls onApprove, (13) approve button disabled when
          processing, (14) PR card omitted when pr undefined, (15) chat input rendered with
          correct placeholder, (16) onReject called with trimmed text. Tests fail because
          component doesn't exist.
      green:
        - >
          Create merge-review.tsx with PhaseList sub-component and MergeReview main component.
          Import Lucide icons, Badge, CiStatusBadge, DrawerActionBar. Build conditional
          sections for each data field. Wire DrawerActionBar with approve/reject props.
      refactor:
        - >
          Verify consistent spacing and layout with existing review drawers. Ensure conditional
          rendering handles all undefined combinations gracefully.
    estimatedEffort: '1.5h'

  - id: task-6
    phaseId: phase-3
    title: 'Build MergeReviewDrawer shell wrapper'
    description: >
      Create merge-review-drawer.tsx — a thin wrapper (~43 lines) that destructures
      MergeReviewDrawerProps, passes shell props to ReviewDrawerShell, and renders MergeReview
      content when data is non-null or a centered Loader2 spinner when data is null (loading).
      Follows the exact pattern of tech-decisions-drawer.tsx.
    state: Todo
    dependencies:
      - task-5
    acceptanceCriteria:
      - 'Has "use client" directive'
      - 'Destructures open, onClose, featureName, featureId, repositoryPath, branch, specPath, onDelete, isDeleting, data from props'
      - 'Spreads remaining props (...reviewProps) to MergeReview content component'
      - 'Wraps content in ReviewDrawerShell with all shell props'
      - 'Shows centered Loader2 spinner with animate-spin when data is null'
      - 'Renders MergeReview with data when data is non-null'
      - 'Exports MergeReviewDrawer as named export'
      - 'TypeScript compiles without errors'
    tdd:
      red:
        - >
          Write a render test asserting MergeReviewDrawer renders ReviewDrawerShell with
          correct feature metadata and MergeReview as child content. Verify feature name in
          header, PR link in content, and approve button are all present. Fails because
          component doesn't exist.
      green:
        - >
          Create merge-review-drawer.tsx following tech-decisions-drawer.tsx pattern exactly.
          Import ReviewDrawerShell, MergeReview, MergeReviewDrawerProps, Loader2.
      refactor:
        - 'No refactoring needed — simple wrapper following established pattern.'
    estimatedEffort: '15min'

  - id: task-7
    phaseId: phase-3
    title: 'Update barrel export and create Storybook stories'
    description: >
      Update index.ts to export MergeReview and MergeReviewDrawer components alongside types.
      Create merge-review.stories.tsx with comprehensive variant coverage for both standalone
      content and drawer wrapper. Stories use the content component directly (no server action
      calls) following the established pattern.
    state: Todo
    dependencies:
      - task-6
    acceptanceCriteria:
      - 'index.ts exports MergeReview, MergeReviewDrawer, and type exports for MergeReviewProps, MergeReviewDrawerProps, MergeReviewData'
      - 'Stories file colocated at merge-review.stories.tsx'
      - 'Story: Default — all data present (PR + diff + branch + phases + CI success)'
      - 'Story: CIPending — CI status Pending with Loader2 animation'
      - 'Story: CIFailure — CI status Failure with red XCircle'
      - 'Story: NoDiffSummary — diff unavailable, shows warning message'
      - 'Story: NoCIStatus — ciStatus undefined, CI section omitted'
      - 'Story: Processing — isProcessing=true, approve button disabled with spinner'
      - 'Story: NoPrWithDiff — no PR but has branch + diff + phases'
      - 'Story: NoPrNoDiff — no PR, no diff, just branch + warning'
      - 'Story: WithPhases — phases displayed with numbered list'
      - 'Story: InDrawer — rendered inside MergeReviewDrawer with shell'
      - 'Story: WithDeleteButton — drawer variant with onDelete callback'
      - 'Story: InDrawerNoPr — drawer variant without PR data'
      - 'Meta configuration: title "Common/MergeReview", layout "fullscreen", decorator with sized container'
      - 'Shared fixtures (fullPr, samplePhases, sampleBranch, fullData) defined at top of file'
      - 'All stories render without errors'
    tdd:
      red:
        - >
          Write a smoke test importing barrel exports and asserting MergeReview and
          MergeReviewDrawer are defined functions. Fails because components weren't in
          index.ts yet.
      green:
        - >
          Update index.ts with component exports. Create stories file with meta config,
          shared data fixtures, standalone story variants, DrawerTemplate helper, and
          drawer story variants.
      refactor:
        - 'Ensure story data fixtures are minimal but representative. Verify drawer stories use DrawerTemplate pattern with open state management.'
    estimatedEffort: '1h'

  - id: task-8
    phaseId: phase-3
    title: 'Verify merge review component suite builds cleanly'
    description: >
      Run typecheck, lint, and unit tests to verify the entire merge review component suite
      compiles and passes. This is a quality gate before control center integration.
    state: Todo
    dependencies:
      - task-7
      - task-2
    acceptanceCriteria:
      - 'pnpm typecheck passes with no errors related to merge-review files'
      - 'pnpm lint:fix passes with no new warnings'
      - 'Unit tests for merge-review content component pass'
      - 'Unit tests for merge-review-drawer pass'
      - 'Unit tests for get-merge-review-data server action pass'
    tdd:
      red:
        - 'Run pnpm typecheck — identify any type errors to fix.'
        - 'Run pnpm lint:fix — identify any lint issues.'
        - 'Run unit tests for merge-review files — all should pass.'
      green:
        - 'Fix any type errors, lint warnings, or test failures found during verification.'
      refactor:
        - 'Clean up any temporary workarounds. Ensure all imports use path aliases (@/) consistently.'
    estimatedEffort: '20min'

  # ── Phase 4: Control Center Integration & Page Verification ───────────

  - id: task-9
    phaseId: phase-4
    title: 'Verify merge node lifecycle mapping in page.tsx'
    description: >
      Verify that page.tsx nodeToLifecyclePhase map already contains `merge: 'review'`. This
      mapping was added in a prior commit and must be confirmed present. Without it, features
      at the merge agent node would not resolve lifecycle='review', and the merge review
      drawer would never trigger.
    state: Todo
    dependencies: []
    acceptanceCriteria:
      - "nodeToLifecyclePhase contains `merge: 'review'` entry in page.tsx"
      - 'No code changes needed if already present'
    tdd:
      red:
        - 'Read page.tsx and verify the merge entry exists in nodeToLifecyclePhase map.'
      green:
        - "Add `merge: 'review'` if not present (expected to already be there)."
      refactor:
        - 'No refactoring needed.'
    estimatedEffort: '5min'

  - id: task-10
    phaseId: phase-4
    title: 'Integrate merge review drawer into control center'
    description: >
      Add the merge review drawer integration to control-center-inner.tsx following the exact
      same pattern as PRD and tech decision drawers: import getMergeReviewData and
      MergeReviewDrawer/MergeReviewData, add state declarations (mergeReviewData,
      isLoadingMergeReview), add showMergeReviewDrawer visibility boolean, add useEffect with
      cancellation for data fetching, add handleMergeApprove via handleSimpleApprove('Merge'),
      add handleMergeReject via handleReject('Merge'), add conditional MergeReviewDrawer
      rendering with all props, and extend FeatureDrawer suppression condition.
    state: Todo
    dependencies:
      - task-8
      - task-9
    acceptanceCriteria:
      - 'Imports: getMergeReviewData from actions, MergeReviewDrawer and MergeReviewData from components'
      - 'State: mergeReviewData (MergeReviewData | null, initial null), isLoadingMergeReview (boolean, initial false)'
      - 'showMergeReviewDrawer = lifecycle === "review" && state === "action-required"'
      - 'useEffect keyed on mergeFeatureId (derived from showMergeReviewDrawer ? selectedNode?.featureId : null)'
      - 'useEffect resets mergeReviewData to null on change, uses cancellation flag pattern'
      - 'useEffect checks "error" in result (discriminated union), shows toast.error'
      - 'handleMergeApprove = handleSimpleApprove("Merge")'
      - 'handleMergeReject = handleReject(feedback, "Merge")'
      - 'MergeReviewDrawer rendered conditionally with: open, onClose, featureName, featureId, repositoryPath, branch, specPath, data, onApprove, onReject, isRejecting, onDelete, isDeleting, isProcessing'
      - 'FeatureDrawer suppression: showPrdDrawer || showTechDecisionsDrawer || showMergeReviewDrawer ? null : selectedNode'
      - 'TypeScript compiles without errors'
    tdd:
      red:
        - >
          Write integration tests asserting: (1) MergeReviewDrawer does not render when
          lifecycle is not "review", (2) getMergeReviewData is called when showMergeReviewDrawer
          becomes true, (3) MergeReviewDrawer renders when data loads successfully,
          (4) FeatureDrawer receives null selectedNode when showMergeReviewDrawer is true,
          (5) error from server action shows toast.error without setting data. Tests fail
          because the integration doesn't exist.
      green:
        - >
          Add imports, state declarations, boolean, useEffect, callbacks, conditional rendering,
          and suppression extension. Follow the exact pattern of lines 84-108 (state), 261-291
          (useEffect), 214-219 (callbacks), 416-451 (rendering) in control-center-inner.tsx.
      refactor:
        - 'Verify approve/reject label consistency ("Merge" for both). Ensure new code is positioned consistently relative to existing drawer code.'
    estimatedEffort: '1h'

  - id: task-11
    phaseId: phase-4
    title: 'Add feature node story variant for review + action-required'
    description: >
      Add a story variant to feature-node.stories.tsx showing the feature node with
      lifecycle="review" and state="action-required" to visually verify the emerald badge
      with GitMerge icon and "Review Merge Request" text. Place it in the AllStates story
      grid after the implementation action-required variant.
    state: Todo
    dependencies:
      - task-4
    acceptanceCriteria:
      - 'New story data entry with lifecycle="review", state="action-required", meaningful name and description'
      - 'Story renders node with emerald badge, GitMerge icon, and "Review Merge Request" text'
      - 'Story visible in Storybook under FeatureNode story group'
      - 'Existing stories unmodified'
    tdd:
      red:
        - >
          Verify no existing story variant covers lifecycle="review" + state="action-required".
          Plan the data entry to add.
      green:
        - >
          Add FeatureNodeData entry with lifecycle="review", state="action-required" to the
          AllStates story grid in feature-node.stories.tsx.
      refactor:
        - 'Ensure the variant is positioned logically after implementation action-required variant.'
    estimatedEffort: '15min'

  - id: task-12
    phaseId: phase-4
    title: 'Run final validation suite'
    description: >
      Run the full validation suite to ensure the complete feature works end-to-end: typecheck,
      lint, unit tests, and verify all acceptance criteria from the spec are met.
    state: Todo
    dependencies:
      - task-10
      - task-11
    acceptanceCriteria:
      - 'pnpm validate passes (lint + format + typecheck + tsp)'
      - 'pnpm test:unit passes (all existing + new tests)'
      - 'All merge-review component files have colocated stories'
      - 'All success criteria from the spec are met'
      - 'No regressions in existing tests'
    tdd:
      red:
        - 'Run pnpm validate and pnpm test:unit to identify any failures.'
      green:
        - 'Fix any validation or test failures found.'
      refactor:
        - 'Final review: verify all spec acceptance criteria are met. Clean up any TODO comments left during development.'
    estimatedEffort: '20min'

totalEstimate: '7.5h'
openQuestions: []

content: |
  ## Summary

  The implementation follows a bottom-up dependency chain across 12 tasks in 4 phases.

  First, the data foundation is established: type interfaces in merge-review-config.ts and
  the getMergeReviewData server action with comprehensive TDD coverage (Phase 1, tasks 1-3).
  The server action is the most complex new code (~65 lines) with three-level error handling
  for PR metadata, plan phases, and diff summary — each independently fallible.

  Next, the feature node badge gets review-lifecycle support with emerald/GitMerge styling
  (Phase 2, task 4). This is a small, isolated change (4 lines across 3 functions) that
  provides immediate visual feedback on the canvas for merge review state.

  Then the component suite is built following the 5-file pattern: content component with
  PhaseList sub-component, drawer wrapper with ReviewDrawerShell, barrel export, and
  comprehensive Storybook stories covering 12+ variants (Phase 3, tasks 5-8). The content
  component (~196 lines) is simpler than both PRD and tech decisions — read-only display
  with DrawerActionBar, no multi-step flow, no interactive state management.

  Finally, the control center wires everything together using the established inline pattern:
  state declarations, visibility boolean, useEffect with cancellation, approve/reject
  callbacks, conditional rendering, and FeatureDrawer suppression (Phase 4, tasks 9-12).
  Page.tsx lifecycle mapping is verified, story variants are added, and the full validation
  suite confirms no regressions.

  Every task produces a testable, independently verifiable increment. The estimate of 7.5
  hours includes TDD overhead (~30%) on a feature that follows proven patterns throughout.
