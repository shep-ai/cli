# Feature Specification (YAML)
# This is the source of truth. Markdown is auto-generated from this file.

name: merge-review-drawer
number: 036
branch: feat/merge-review-drawer
oneLiner: Add merge review drawer and feature node visualization for the Review lifecycle phase
summary: >
  This feature adds dedicated UI support for the merge review approval gate in the web UI.
  It implements an emerald-badged feature node visualization and a comprehensive merge review
  drawer that displays PR metadata, diff statistics, CI status, implementation phases, and
  branch merge direction, following established review drawer patterns.
phase: Requirements
sizeEstimate: M

relatedFeatures: []

technologies:
  - React 19 (Next.js 16+ App Router)
  - TypeScript 5.3
  - shadcn/ui (Radix primitives + Tailwind CSS v4)
  - React Flow (@xyflow/react v12) for canvas visualization
  - Vaul v1.1 (drawer primitive library)
  - Storybook 8.6 for component development
  - Vitest 4.0 + Testing Library for unit tests
  - Playwright for E2E tests
  - Lucide React (GitMerge, FileDiff, CheckCircle2, XCircle, Loader2, ExternalLink icons)
  - Sonner (toast notifications)
  - tsyringe (DI container for server actions)
  - TypeSpec 0.60 (domain model code generation)
  - LangGraph 1.1 (interrupt/resume flow for approval gates)
  - pnpm 10.30 (monorepo workspace manager)

relatedLinks: []

openQuestions:
  - question: 'Should the merge review drawer display implementation phases when plan.yaml is unavailable?'
    resolved: true
    options:
      - option: 'Show phases when available only'
        description: 'Display phases section only if plan.yaml loads successfully. Best-effort approach minimizes user-facing errors and keeps the UI clean when data is missing. Users can still approve/reject without phase visibility.'
        selected: true
      - option: 'Always show phases section with error state'
        description: 'Display the phases section container even when plan.yaml fails to load, showing an error message. More transparent about data loading issues but adds visual noise for a non-critical feature.'
        selected: false
      - option: 'Block approval when phases missing'
        description: 'Disable approve button if phases cannot be loaded. Ensures complete context but may be overly restrictive since phase visibility is supplementary information only.'
        selected: false
    selectionRationale: 'Best-effort loading is recommended because implementation phases provide supplementary context but are not critical for merge approval decisions. Users primarily need PR metadata, diff summary, and CI status. Showing phases only when available reduces error noise and follows established graceful degradation patterns from other review drawers.'
    answer: 'Show phases when available only'

  - question: 'How should the drawer handle missing diff summary when worktree is unavailable?'
    resolved: true
    options:
      - option: 'Show warning message, allow approval'
        description: 'Display a warning that diff stats are unavailable (e.g., "Diff summary unavailable: worktree not found") but keep approve/reject buttons enabled. Users can still make decisions based on PR metadata and CI status. Balances transparency with usability.'
        selected: true
      - option: 'Block approval until diff is available'
        description: 'Disable approve button when diff summary cannot be computed. Ensures users always have complete context but may prevent legitimate approvals when worktree cleanup has occurred.'
        selected: false
      - option: 'Hide diff section completely'
        description: 'Omit the diff summary section entirely when data is missing. Cleanest UI but less transparent about what information is unavailable.'
        selected: false
    selectionRationale: 'Warning message with approval enabled is recommended because diff stats are important context but worktree unavailability is a transient infrastructure state (e.g., cleanup after merge, concurrent operations). PR metadata and CI status remain available and sufficient for approval decisions. The warning keeps users informed without blocking legitimate workflow progression.'
    answer: 'Show warning message, allow approval'

  - question: 'Should the feature node badge show commit count or just "Review Merge Request"?'
    resolved: true
    options:
      - option: 'Show "Review Merge Request" only'
        description: 'Display static text matching established pattern from existing code. Consistent with PRD and Tech review drawers, which use static labels. Simple implementation with no data fetching required.'
        selected: true
      - option: 'Show commit count dynamically'
        description: 'Display text like "Review 3 commits" to give users immediate context. Requires fetching diff summary for every feature node, adding performance overhead. More informative but breaks consistency with other review gates.'
        selected: false
      - option: 'Show branch name'
        description: 'Display feature branch name (e.g., "Review feat/xyz"). Provides context but branch names may be long/truncated, and this information is already in the PR card inside the drawer.'
        selected: false
    selectionRationale: 'Static "Review Merge Request" text is recommended for consistency with existing review drawer patterns (PRD, Tech). The badge serves as a visual indicator and click target, while detailed metadata belongs inside the drawer. Adding dynamic data to the badge would require additional server calls for all feature nodes, degrading performance for marginal UX benefit.'
    answer: 'Show "Review Merge Request" only'

  - question: 'Should Storybook stories cover all CI status combinations?'
    resolved: true
    options:
      - option: 'Cover all CI status states'
        description: 'Create story variants for Pending, Success, Failure CI statuses to document all visual states. Comprehensive documentation helps future maintainers understand edge cases. Estimated 3 additional stories (~45 lines total).'
        selected: true
      - option: 'Cover only Success and Failure'
        description: 'Document just the two most common terminal states, skipping Pending since it is transient. Reduces story maintenance burden but leaves a gap in visual documentation.'
        selected: false
      - option: 'Cover only default state'
        description: 'Minimal story coverage focusing on happy path. Faster to implement but provides poor documentation for edge cases and regression testing.'
        selected: false
    selectionRationale: 'Comprehensive CI status coverage is recommended because CI state directly affects user approval decisions (green check vs red X). Storybook stories serve as visual regression tests and living documentation. The existing merge-review.stories.tsx already has 11 variants, indicating a pattern of thorough coverage. Adding 3 CI-specific variants aligns with project quality standards.'
    answer: 'Cover all CI status states'

  - question: 'What testing strategy should be used for the get-merge-review-data server action?'
    resolved: true
    options:
      - option: 'TDD with comprehensive unit tests'
        description: 'Write failing tests first covering all paths: input validation, feature not found, successful data mapping, plan loading failure, diff summary failure, missing PR, missing worktree. Aligns with mandatory TDD requirement from CLAUDE.md. Estimated ~150 lines of tests.'
        selected: true
      - option: 'Integration tests only'
        description: 'Test the server action via component integration tests, relying on existing merge-review.test.tsx. Faster to implement but violates TDD mandate and provides less granular failure diagnosis.'
        selected: false
      - option: 'Manual testing in Storybook'
        description: 'Rely on visual testing in Storybook with mocked responses. Adequate for UI verification but provides no automated regression coverage for server-side logic.'
        selected: false
    selectionRationale: 'TDD with comprehensive unit tests is mandatory per CLAUDE.md: "MANDATORY — TDD: Write failing tests FIRST (RED → GREEN → REFACTOR). Every plan phase must define explicit TDD cycles." The server action has multiple conditional branches (validation, data fetching, graceful degradation) that require isolated testing. Unit tests provide fast feedback, clear failure messages, and serve as executable documentation of expected behavior.'
    answer: 'TDD with comprehensive unit tests'

content: |
  ## Problem Statement

  The Shep AI CLI platform uses a multi-phase agent workflow with approval gates at key decision points.
  When a feature reaches the merge phase (lifecycle=Review, state=action-required), the LangGraph agent
  interrupts and waits for user approval before merging the PR to the main branch.

  Prior to this feature, the web UI lacked dedicated visualization and interaction patterns for the merge
  review approval gate:

  1. **Incomplete feature node badge**: The `getBadgeText()` function returned "Review Merge Request" for
     `lifecycle === 'review'`, but badge color/icon fell through to generic amber/FileText instead of a
     distinct emerald/GitMerge identity matching other action-required states.

  2. **No merge review drawer**: The control center had `showPrdDrawer` and `showTechDecisionsDrawer`
     conditions but no `showMergeReviewDrawer` logic to display merge-specific context.

  3. **Missing merge UI components**: While `merge-review/` directory scaffolding existed, components were
     not integrated into the control center workflow.

  4. **Data access architecture gap**: The merge interrupt payload (diff summary, PR metadata) is stored in
     the LangGraph checkpoint, but persistent access requires retrieving data from the Feature entity's `pr`
     field and regenerating diff stats on-demand from the git worktree.

  This feature completes the merge review flow following established patterns from `prd-questionnaire/` and
  `tech-decisions-review/` drawers, enabling users to review PR metadata, diff statistics, CI status, and
  implementation phases before approving or rejecting the merge.

  ## Success Criteria

  - [ ] Feature node displays emerald badge with GitMerge icon and "Review Merge Request" text when lifecycle='review' and state='action-required'
  - [ ] Clicking merge review feature node opens merge review drawer with PR metadata, diff summary, CI status, phases, and branch direction
  - [ ] Merge review drawer approve button triggers LangGraph agent resume with approved=true
  - [ ] Merge review drawer reject button opens feedback dialog and triggers agent resume with revision feedback
  - [ ] Server action getMergeReviewData() validates input, loads Feature.pr, regenerates diff summary, loads plan phases (best-effort)
  - [ ] Server action gracefully degrades when plan.yaml or worktree is unavailable (shows warning, keeps approve enabled)
  - [ ] All unit tests pass including new get-merge-review-data.test.ts with 100% branch coverage
  - [ ] Storybook stories exist for feature node merge review state and control center with merge review node
  - [ ] Storybook stories cover all CI status states (Pending, Success, Failure) for merge review drawer
  - [ ] Full test suite passes (pnpm test) with no regressions
  - [ ] Lint and format checks pass (pnpm validate)
  - [ ] E2E smoke test verifies end-to-end flow: create feature → implement → merge phase → approve → agent resumes

  ## Functional Requirements

  - **FR-1**: Feature node MUST display emerald badge with GitMerge icon when feature has lifecycle='review' and state='action-required'
  - **FR-2**: Feature node badge text MUST read "Review Merge Request" for merge review state
  - **FR-3**: Clicking feature node in merge review state MUST open merge review drawer
  - **FR-4**: Merge review drawer MUST display PR metadata card showing PR number, URL, status (Open/Merged/Closed), commit hash
  - **FR-5**: Merge review drawer MUST display diff summary showing files changed, additions, deletions, commit count
  - **FR-6**: Merge review drawer MUST display CI status badge (Pending/Success/Failure) when ciStatus is available on PR
  - **FR-7**: Merge review drawer MUST display implementation phases section showing phase names and completion status when plan.yaml is available
  - **FR-8**: Merge review drawer MUST display branch merge direction indicator (e.g., "feat/xyz → main")
  - **FR-9**: Merge review drawer MUST provide approve button that calls approveFeature() server action with featureId
  - **FR-10**: Merge review drawer MUST provide reject button that opens feedback dialog for revision instructions
  - **FR-11**: Approve action MUST trigger ApproveAgentRunUseCase to resume LangGraph agent with approved=true
  - **FR-12**: Reject action MUST trigger RejectAgentRunUseCase to resume LangGraph agent with user feedback and increment iteration counter
  - **FR-13**: getMergeReviewData() server action MUST validate featureId input and return error object for empty/invalid input
  - **FR-14**: getMergeReviewData() server action MUST return error object when feature is not found in repository
  - **FR-15**: getMergeReviewData() server action MUST extract PR metadata from Feature.pr field (url, number, status, commitHash, ciStatus)
  - **FR-16**: getMergeReviewData() server action MUST call gitPrService.getPrDiffSummary() to regenerate diff stats from worktree
  - **FR-17**: getMergeReviewData() server action MUST call GetPlanArtifactUseCase to load plan.yaml phases (best-effort, non-blocking)
  - **FR-18**: getMergeReviewData() server action MUST gracefully degrade when plan.yaml is unavailable (phases undefined, no error thrown)
  - **FR-19**: getMergeReviewData() server action MUST gracefully degrade when worktree is unavailable (diffSummary undefined, warning message)
  - **FR-20**: getMergeReviewData() server action MUST return structured data object with pr, diffSummary, phases, baseBranch, featureBranch, and optional warning field
  - **FR-21**: Control center MUST derive showMergeReviewDrawer flag from selected node state (lifecycle='review', state='action-required')
  - **FR-22**: Control center MUST load merge review data via getMergeReviewData() when merge review node is selected
  - **FR-23**: Control center MUST handle approve/reject interactions via shared approveFeature() and rejectFeature() flows
  - **FR-24**: Control center MUST conditionally render MergeReviewDrawer when showMergeReviewDrawer is true
  - **FR-25**: Page.tsx MUST map 'merge' agent node to 'review' lifecycle phase in nodeToLifecyclePhase configuration

  ## Non-Functional Requirements

  - **NFR-1**: Performance - Merge review drawer MUST open within 500ms for features with available worktree
  - **NFR-2**: Performance - Feature node badge rendering MUST not trigger additional server calls beyond existing control center data loading
  - **NFR-3**: Reliability - Server action MUST handle missing worktree gracefully without throwing unhandled exceptions
  - **NFR-4**: Reliability - Approve action MUST work even when diff summary or phases are unavailable
  - **NFR-5**: Usability - Warning messages for missing data MUST be displayed inline in the relevant drawer section (e.g., "Diff summary unavailable: worktree not found")
  - **NFR-6**: Usability - Drawer MUST show loading skeleton while merge review data is being fetched
  - **NFR-7**: Usability - PR URL link MUST open in new tab with external link icon indicator
  - **NFR-8**: Accessibility - Approve button MUST have aria-label describing the action (e.g., "Approve merge request")
  - **NFR-9**: Accessibility - Reject button MUST have aria-label describing the action (e.g., "Reject merge request")
  - **NFR-10**: Accessibility - CI status badge MUST have semantic color indicators (green=success, red=failure, yellow=pending) and text label
  - **NFR-11**: Type Safety - All TypeScript interfaces MUST have explicit types with no `any` usage
  - **NFR-12**: Type Safety - Server action return types MUST be discriminated unions for success/error cases
  - **NFR-13**: Maintainability - Component structure MUST follow established review drawer pattern (config, content, drawer wrapper, stories, barrel export)
  - **NFR-14**: Maintainability - Server action MUST use DI container for dependency resolution (featureRepository, gitPrService, planArtifactUseCase)
  - **NFR-15**: Testability - All conditional branches in server action MUST have corresponding unit test cases
  - **NFR-16**: Testability - Storybook stories MUST cover default state, loading state, error state, and all CI status variants
  - **NFR-17**: Code Quality - Implementation MUST pass pnpm validate (lint, format, typecheck, tsp compile)
  - **NFR-18**: Code Quality - Test coverage for server action MUST achieve 100% branch coverage
  - **NFR-19**: Architecture Compliance - Server action MUST only depend on application layer ports (IFeatureRepository, IGitPrService), not infrastructure implementations
  - **NFR-20**: Architecture Compliance - No changes to domain layer or TypeSpec models (Feature, PullRequest types are read-only)

  ## Product Questions & AI Recommendations

  | # | Question | AI Recommendation | Rationale |
  | - | -------- | ----------------- | --------- |
  | 1 | Should the merge review drawer display implementation phases when plan.yaml is unavailable? | Show phases when available only | Best-effort loading minimizes error noise. Phases provide supplementary context but are not critical for merge approval since PR metadata and CI status are sufficient. |
  | 2 | How should the drawer handle missing diff summary when worktree is unavailable? | Show warning message, allow approval | Worktree unavailability is transient (cleanup, concurrent ops). PR metadata and CI status remain available. Warning keeps users informed without blocking legitimate workflow progression. |
  | 3 | Should the feature node badge show commit count or just "Review Merge Request"? | Show "Review Merge Request" only | Consistency with PRD/Tech review patterns. Badge serves as click target while detailed metadata belongs in drawer. Dynamic data would require extra server calls, degrading performance. |
  | 4 | Should Storybook stories cover all CI status combinations? | Cover all CI status states | CI state affects approval decisions. Stories serve as visual regression tests and documentation. Existing merge-review.stories.tsx has 11 variants, indicating thorough coverage standard. |
  | 5 | What testing strategy should be used for the get-merge-review-data server action? | TDD with comprehensive unit tests | MANDATORY per CLAUDE.md. Server action has multiple conditional branches requiring isolated testing. Unit tests provide fast feedback and serve as executable documentation. |

  ## Affected Areas

  | Area | Impact | Reasoning |
  | ---- | ------ | --------- |
  | `components/common/feature-node/feature-node.tsx` (246 lines) | **Low** | Already has `review` lifecycle case in `getBadgeText()` (line 58). Badge color/icon logic already implemented (lines 19-42). Zero changes needed — feature was pre-implemented. |
  | `components/common/merge-review/` (5 files) | **High** | **ALREADY IMPLEMENTED**: All 5 files exist with complete implementation: `merge-review-config.ts` (86 lines, TypeScript interfaces), `merge-review.tsx` (223 lines, full UI with PR card, diff summary, phases, branch direction, DrawerActionBar), `merge-review-drawer.tsx` (39 lines, ReviewDrawerShell wrapper with loading), `merge-review.stories.tsx` (184 lines, 11 story variants), `index.ts` (5 lines, barrel export). The implementation follows the established pattern exactly. |
  | `components/features/control-center/control-center-inner.tsx` (463 lines) | **Medium** | **ALREADY IMPLEMENTED**: Lines 16, 18, 26, 98-99, 107-108 show merge review data loading, `showMergeReviewDrawer` flag, and drawer integration. Server action fetch with cancellation pattern exists (lines 227-246). Approve/reject handlers integrated (lines 264-296). MergeReviewDrawer conditionally rendered (lines 400-413). Full integration complete. |
  | `app/actions/get-merge-review-data.ts` (64 lines) | **Low** | **ALREADY IMPLEMENTED**: Complete server action with input validation, DI container usage, Feature.pr extraction, plan phase loading (best-effort), diff summary regeneration via `gitPrService.getPrDiffSummary()`, graceful fallback when worktree unavailable, structured error handling. Follows established pattern from `get-feature-artifact.ts` and `get-research-artifact.ts`. |
  | `app/page.tsx` (167 lines) | **Low** | **ALREADY IMPLEMENTED**: Line 35 shows `merge: 'review'` entry in `nodeToLifecyclePhase` map. Feature nodes at merge agent node are correctly mapped to `review` lifecycle phase. |
  | `components/common/feature-node/feature-node.stories.tsx` (436 lines) | **Low** | Needs `MergeReviewActionRequired` story variant (estimated 15 lines). Should show emerald badge with GitMerge icon, "Review Merge Request" text, lifecycle: 'review', state: 'action-required'. |
  | `components/features/control-center/control-center.stories.tsx` (317 lines) | **Low** | Needs merge review feature node in multi-feature story variants. Add to existing stories like `MultipleFeatures`, `FullWorkflowStates`, etc. Each addition ~5-10 lines. |
  | `tests/unit/presentation/web/components/common/merge-review/` | **Medium** | **ALREADY IMPLEMENTED**: 4 test files exist: `merge-review-barrel.test.ts` (17 lines), `merge-review-config.test.ts` (148 lines, interface validation), `merge-review-drawer.test.tsx` (76 lines, drawer wrapper tests), `merge-review.test.tsx` (265 lines, component rendering, interactions, edge cases). Comprehensive coverage of all scenarios. |
  | `tests/unit/presentation/web/app/actions/get-merge-review-data.test.ts` | **Low** | Needs unit tests for server action: input validation, feature not found, data mapping, plan loading failure, diff summary failure, no PR scenario, no worktree scenario. Estimated ~150 lines. |
  | `.storybook/mocks/app/actions/get-merge-review-data.ts` | **None** | **ALREADY IMPLEMENTED**: Mock exists (30 lines) returning sample merge review data for Storybook. |
  | `packages/core/src/domain/generated/output.ts` (43,141 lines) | **None** | TypeSpec-generated file. Contains PullRequest, PrStatus, CiStatus, SdlcLifecycle enums. Never edited directly. No changes needed. |
  | `packages/core/src/application/ports/output/repositories/feature-repository.interface.ts` | **None** | IFeatureRepository.findById() already returns Feature with populated `pr` field. No interface changes needed. |
  | `packages/core/src/application/ports/output/services/git-pr-service.interface.ts` | **None** | IGitPrService.getPrDiffSummary() already exists. Returns `DiffSummary { filesChanged, additions, deletions, commitCount }`. No changes needed. |
  | `packages/core/src/application/use-cases/features/get-plan-artifact.use-case.ts` | **None** | GetPlanArtifactUseCase.execute() already exists. Loads plan.yaml with phases array. Used by server action for best-effort phase loading. No changes needed. |
  | `packages/core/src/infrastructure/services/agents/feature-agent/nodes/merge.node.ts` | **None** | Populates Feature.pr before interrupt (lines 144-158). Passes diffSummary in interrupt payload. No changes needed — backend already prepared. |
  | `packages/core/src/application/use-cases/agents/approve-agent-run.use-case.ts` | **None** | ApproveAgentRunUseCase resumes LangGraph agent from interrupt. Works for all approval gates. No changes needed. |

  ## Dependencies

  ### Existing Shared Components (No Modifications Required)

  - **ReviewDrawerShell** (143 lines): Drawer container with header, delete button, feature actions menu (IDE/shell/folder).
    Provides consistent drawer UX across all review drawers (PRD, Tech, Merge).

  - **DrawerActionBar** (65 lines): Action bar with approve button, reject button, inline revision input, reject feedback dialog.
    Handles disabled states during processing/rejecting. Fully customizable via props (labels, icons, placeholders).

  - **CiStatusBadge**: Color-coded badge component for CI status (Success/Pending/Failure).
    Used by merge-review.tsx to display PR CI status.

  - **DrawerRevisionInput**: Inline text input with send button for quick rejection feedback.
    Integrated into DrawerActionBar, used by merge-review drawer.

  - **RejectFeedbackDialog**: AlertDialog with textarea for detailed rejection feedback.
    Provides structured rejection flow with cancel/confirm buttons.

  - **useFeatureActions** hook (139 lines): Provides IDE/shell/folder action handlers.
    Used by ReviewDrawerShell to populate feature actions menu.

  ### Server Actions (Existing)

  - **approveFeature()** (38 lines): Calls ApproveAgentRunUseCase, works for all approval gates (PRD, Tech, Merge).
    Returns `{ approved: boolean, error?: string }`.

  - **rejectFeature()**: Sends rejection feedback to agent via RejectAgentRunUseCase.
    Returns `{ rejected: boolean, iteration: number, iterationWarning?: string, error?: string }`.

  - **getMergeReviewData()** (64 lines): **ALREADY IMPLEMENTED** — Loads merge review data with graceful degradation.

  ### Domain Types (TypeSpec-Generated, Read-Only)

  From `packages/core/src/domain/generated/output.ts`:

  - **Feature**: Main entity with fields: `id`, `name`, `description`, `lifecycle` (SdlcLifecycle), `branch`, `worktreePath`, `pr?` (PullRequest), `parentId?`, `agentRunId?`, etc.

  - **PullRequest**: `{ url: string, number: number, status: PrStatus, commitHash?: string, ciStatus?: CiStatus }`

  - **PrStatus** enum: `Open | Merged | Closed`

  - **CiStatus** enum: `Pending | Success | Failure`

  - **SdlcLifecycle** enum: `Requirements | Research | Implementation | Review | Deploy & QA | Maintain`

  - **AgentRunStatus** enum: includes `waitingApproval` variant

  - **ApprovalGates**: `{ allowPrd: boolean, allowPlan: boolean, allowMerge: boolean }`

  ### Service Interfaces (Application Ports, Read-Only)

  - **IFeatureRepository**: `findById(id: string): Promise<Feature | null>` — Loads feature with populated `pr` field

  - **IGitPrService**: `getPrDiffSummary(cwd: string, baseBranch: string): Promise<DiffSummary>` — Computes diff stats

  - **GetPlanArtifactUseCase**: `execute(featureId: string): Promise<PlanArtifact>` — Loads plan.yaml with phases

  ### Infrastructure (No Changes Needed)

  - **merge.node.ts** (LangGraph agent node): Sets Feature.pr before interrupt, passes diffSummary in payload.
    Interrupt triggers when `allowMerge: false` in approval gates.

  - **feature-agent-worker.ts**: Sets AgentRunStatus to `waitingApproval` on interrupt.

  - **ApproveAgentRunUseCase**: Resumes LangGraph agent, setting interrupt response to `{ approved: true }`.

  - **RejectAgentRunUseCase**: Resumes LangGraph agent with rejection feedback, increments iteration counter.

  ### Build Tools

  - **pnpm**: Workspace manager, links `@shepai/core` to `@shepai/web` via `workspace:*` protocol

  - **TypeScript**: Strict mode, path aliases (`@/` for web, `@shepai/core/` for core package)

  - **Next.js 16**: App Router (server components, server actions, `force-dynamic` for runtime DI)

  - **Vitest**: Test runner (`pnpm test:unit` for unit tests, `pnpm test:watch` for TDD workflow)

  - **Storybook**: Component dev environment (`pnpm dev:storybook` → localhost:6006)

  ## Size Estimate

  **M (2-3 days)** — **Feature is 95% implemented**

  ### Already Implemented (Complete)

  ✅ **merge-review/** components (5 files, ~537 lines):
    - Config with TypeScript interfaces
    - Content component with PR card, diff summary, CI status, phases, branch direction
    - Drawer wrapper with ReviewDrawerShell composition and loading state
    - 11 Storybook story variants covering all states
    - Barrel export

  ✅ **Server action** `get-merge-review-data.ts` (64 lines):
    - Input validation
    - DI container resolution
    - Feature.pr extraction
    - Plan phase loading (best-effort)
    - Diff summary regeneration with graceful fallback
    - Structured error handling

  ✅ **Feature node** badge logic (feature-node.tsx):
    - `getBadgeText()` returns "Review Merge Request" for review lifecycle
    - `getBadgeIcon()` returns GitMerge icon for review action-required
    - `getActionRequiredBadgeClasses()` returns emerald colors for review

  ✅ **Control center integration** (control-center-inner.tsx):
    - `showMergeReviewDrawer` flag derived from selected node state
    - Merge review data loading with cancellation pattern
    - Approve/reject handlers integrated with shared flow
    - MergeReviewDrawer conditionally rendered

  ✅ **Page mapping** (page.tsx):
    - `merge: 'review'` entry in `nodeToLifecyclePhase` map

  ✅ **Component tests** (4 test files, ~506 lines):
    - merge-review-barrel.test.ts
    - merge-review-config.test.ts
    - merge-review-drawer.test.tsx
    - merge-review.test.tsx

  ✅ **Storybook mock** for server action

  ### Remaining Work (Est. 4-6 hours)

  **1. Server action tests** (Est. 2 hours):
    - Create `tests/unit/presentation/web/app/actions/get-merge-review-data.test.ts`
    - Test input validation (empty featureId returns error)
    - Test feature not found (returns error)
    - Test successful data mapping (PR, diff, phases, branch)
    - Test plan loading failure (phases undefined, no overall failure)
    - Test diff summary failure (warning message, approve still works)
    - Test no PR scenario (pr undefined, warning if no worktree)
    - Test no worktree scenario (diffSummary undefined, warning message)
    - ~150 lines, TDD cycle (RED → GREEN → REFACTOR)

  **2. Story additions** (Est. 1 hour):
    - Add `MergeReviewActionRequired` variant to `feature-node.stories.tsx` (~15 lines)
    - Add merge review nodes to `control-center.stories.tsx` multi-feature variants (~3 additions × 10 lines)

  **3. Validation & Polish** (Est. 1-2 hours):
    - Run full test suite (`pnpm test`)
    - Visual regression testing in Storybook (`pnpm dev:storybook`)
    - E2E smoke test (create feature → merge phase → approve)
    - Lint/format (`pnpm validate`)

  ### Why M-Sized Despite Implementation

  - **Test coverage gap**: Server action lacks unit tests (TDD principle requires tests first)
  - **Story gap**: Feature node and control center stories need merge variants for documentation
  - **Validation required**: New feature needs smoke testing across the full workflow
  - **Low risk**: All patterns proven, no domain changes, no breaking changes
  - **Well-scoped**: Clear boundaries, known dependencies, established conventions
