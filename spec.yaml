# Feature Specification (YAML)
# This is the source of truth. Markdown is auto-generated from this file.

name: merge-review-drawer
number: 036
branch: feat/merge-review-drawer
oneLiner: Add merge review drawer and feature node visualization for the Review lifecycle phase
summary: >
  When a feature reaches the merge approval gate (lifecycle=Review, state=action-required),
  the feature node displays a distinct emerald/GitMerge badge and a dedicated merge review
  drawer shows PR metadata, diff summary statistics, CI status, and an "Approve Merge" action.
  The drawer follows the ReviewDrawerShell composition pattern, reads data from Feature.pr
  with on-demand diff regeneration via a server action, and gracefully degrades when diff
  stats are unavailable.
phase: Requirements
sizeEstimate: M

# Relationships
relatedFeatures: []

technologies:
  - React 19 (Next.js 16+ App Router)
  - shadcn/ui (Radix + Tailwind CSS v4)
  - React Flow (@xyflow/react)
  - Storybook
  - Vaul (drawer primitive)
  - LangGraph (interrupt/resume for approval gates)
  - Lucide React (GitMerge / GitPullRequest / CheckCircle2 / XCircle / Loader2 icons)
  - sonner (toast notifications)
  - tsyringe (DI container for server actions)
  - Tailwind CSS v4 (emerald color palette for merge badge)

relatedLinks: []

openQuestions:
  - question: >
      The merge interrupt payload (diffSummary, prUrl, prNumber) is stored only in the
      LangGraph checkpoint, not persisted to the Feature or AgentRun entity. Should we
      (A) add an interruptPayload field to AgentRun and persist it when status becomes
      waitingApproval, or (B) create a use case that reads the checkpoint directly, or
      (C) read the Feature.pr field (which is populated before the interrupt in merge.node.ts
      lines 144-158) and generate the diff summary on demand via a new server action?
    impact: Determines the data access architecture for the merge drawer content.
    resolved: true
    options:
      - option: 'Persist interruptPayload on AgentRun'
        description: >
          Add a new interruptPayload JSON field to AgentRun and persist the merge interrupt
          data when status becomes waitingApproval. Pros: single source of truth, no
          recomputation. Cons: requires TypeSpec model change, migration, and changes to
          the worker persistence layer — high blast radius for a display-only feature.
        selected: false
      - option: 'Read LangGraph checkpoint directly'
        description: >
          Create a use case that reads the LangGraph checkpoint to extract the interrupt
          payload. Pros: no model changes. Cons: couples the UI data layer to LangGraph
          internals, checkpoint format may change, adds complexity to the read path.
        selected: false
      - option: 'Read Feature.pr + regenerate diff summary'
        description: >
          Create a new server action that reads Feature.pr for PR metadata (url, number,
          status, commitHash, ciStatus) and calls gitPrService.getPrDiffSummary() for
          diff statistics. Pros: uses already-persisted data, no model changes, follows
          existing server action patterns, diff summary is always fresh. Cons: requires
          the worktree to still exist for diff computation (which it does during review).
        selected: true
    selectionRationale: >
      Option C is recommended because Feature.pr is already populated before the interrupt
      (merge.node.ts:144-158) and contains all PR metadata. The diff summary can be
      regenerated on demand via the existing IGitPrService.getPrDiffSummary() method.
      This avoids any domain model changes, follows the established server action pattern
      (like get-feature-artifact.ts and get-research-artifact.ts), and keeps the diff
      data fresh. The worktree is guaranteed to exist during the Review lifecycle phase.
    answer: 'Read Feature.pr + regenerate diff summary'

  - question: >
      What color scheme and icon should the merge review badge use on the feature node
      to distinguish it from requirements (amber/FileText) and implementation (indigo/Wrench)?
    impact: Determines the visual identity of the merge review state in the canvas.
    resolved: true
    options:
      - option: 'Green with GitMerge icon'
        description: >
          Use green (emerald) color scheme with the GitMerge icon from Lucide React.
          Green conveys "ready to merge / success", GitMerge directly represents the
          action. Consistent with GitHub's merge button color. Distinct from amber
          (requirements) and indigo (implementation).
        selected: true
      - option: 'Purple with GitPullRequest icon'
        description: >
          Use purple/violet color scheme with GitPullRequest icon. Purple is visually
          distinct but doesn't carry semantic meaning related to merging. GitPullRequest
          represents the PR itself rather than the merge action.
        selected: false
      - option: 'Teal with GitMerge icon'
        description: >
          Use teal/cyan color scheme with GitMerge icon. Teal is distinct from existing
          colors but less semantically meaningful than green for a merge action.
        selected: false
    selectionRationale: >
      Green (emerald) with GitMerge is recommended because it creates an intuitive visual
      language: green = ready to proceed/merge, matching GitHub's merge button convention.
      The GitMerge icon directly communicates the action being reviewed. The three review
      states form a clear progression: amber (requirements) → indigo (implementation) →
      green (merge), each visually distinct and semantically meaningful.
    answer: 'Green with GitMerge icon'

  - question: >
      Should the merge review drawer include a reject/request-changes action in addition
      to approve, and if so what should happen on rejection?
    impact: Determines the drawer action buttons and the rejection flow.
    resolved: true
    options:
      - option: 'Approve only (with delete as escape hatch)'
        description: >
          Only show an Approve button. Users who don't want to merge can delete the
          feature or close the drawer and leave it pending. Simple, matches the existing
          PRD/Tech drawer pattern which only has approve. The ReviewDrawerShell already
          provides a delete button for abandoning features.
        selected: true
      - option: 'Approve + Reject with agent feedback loop'
        description: >
          Add a Reject button that sends feedback to the agent, which would then revise
          the PR. Requires new LangGraph interrupt response handling, new domain model
          fields, and significant backend work. More complete UX but high implementation
          cost and out of scope for an M-sized feature.
        selected: false
    selectionRationale: >
      Approve-only is recommended to match the established pattern used by PRD and Tech
      Decision drawers. The ReviewDrawerShell already provides delete as an escape hatch
      for abandoning a feature. Adding rejection would require significant backend changes
      to the LangGraph interrupt/resume flow, which is out of scope. A reject flow can be
      added as a separate feature if needed.
    answer: 'Approve only (with delete as escape hatch)'

  - question: >
      Should the merge review drawer content include a chat input for refinement feedback
      (like PRD and Tech drawers) or only display read-only PR information with an approve action?
    impact: Determines whether the drawer supports conversational refinement before approval.
    resolved: true
    options:
      - option: 'Read-only display with approve action'
        description: >
          Show PR metadata, diff summary, and CI status as read-only content with an
          approve button. No chat input. Merge review is a binary decision (approve or
          not) — there's nothing to "refine" like requirements or tech decisions. Simpler
          to implement and matches the nature of the merge gate.
        selected: true
      - option: 'Include chat input for feedback'
        description: >
          Include a chat input like the other drawers for consistency. Users could send
          feedback that gets passed to the agent. However, the merge node doesn't currently
          support feedback-based revision, so the chat input would be non-functional or
          require backend changes.
        selected: false
    selectionRationale: >
      Read-only is recommended because merge review is fundamentally a binary approval
      decision, unlike requirements (where users select options) or tech decisions (where
      users can request plan revisions). The merge node's interrupt flow doesn't support
      feedback-based revision. Adding a non-functional chat input would be misleading.
      The PR link provides an escape hatch for users who want to review code in detail
      on GitHub.
    answer: 'Read-only display with approve action'

  - question: >
      How should the drawer handle the case where the worktree has been deleted or the
      git repository is unavailable, making diff summary regeneration impossible?
    impact: Determines error handling and fallback behavior for the merge drawer.
    resolved: true
    options:
      - option: 'Graceful degradation with PR-only fallback'
        description: >
          If diff summary fails, show PR metadata from Feature.pr (URL, number, status,
          CI status) without diff stats. Display a subtle warning that diff stats are
          unavailable. The approve action still works since it only needs the agentRunId.
          Low implementation cost, good UX.
        selected: true
      - option: 'Block drawer with error state'
        description: >
          Show a full error state in the drawer when diff summary fails. Prevents users
          from seeing partial data. However, blocking approval because of a display issue
          would be frustrating — the user can always review the PR on GitHub.
        selected: false
    selectionRationale: >
      Graceful degradation is recommended because the diff summary is supplementary
      information — the core action (approve merge) doesn't depend on it. Feature.pr
      data is already persisted and always available. Blocking the entire drawer because
      of a transient git error would frustrate users unnecessarily. The PR URL provides
      a direct link to review changes on GitHub regardless.
    answer: 'Graceful degradation with PR-only fallback'

  - question: >
      Should the diff summary section display file-level change details (list of changed files
      with per-file additions/deletions) or only aggregate statistics?
    impact: Determines the granularity of diff information shown in the drawer and server action complexity.
    resolved: true
    options:
      - option: 'Aggregate statistics only'
        description: >
          Show total files changed, total additions, total deletions, and commit count.
          Matches the DiffSummary interface already returned by IGitPrService.getPrDiffSummary().
          No additional API calls or interface changes needed. Users who want file-level
          details can click the PR link to view on GitHub.
        selected: true
      - option: 'File-level details with per-file stats'
        description: >
          Show a list of each changed file with individual addition/deletion counts.
          Richer information but requires extending IGitPrService with a new method or
          modifying getPrDiffSummary() to return per-file data. Increases server action
          complexity and drawer layout complexity.
        selected: false
    selectionRationale: >
      Aggregate statistics are recommended because the existing IGitPrService.getPrDiffSummary()
      already returns exactly this data shape (filesChanged, additions, deletions, commitCount).
      No interface changes needed. The merge drawer's purpose is to provide a quick approval
      decision, not a full code review — GitHub serves that purpose and is linked from the PR URL.
    answer: 'Aggregate statistics only'

  - question: >
      How should CI status be visually represented in the merge review drawer?
    impact: Determines the CI status display pattern and how users assess merge readiness.
    resolved: true
    options:
      - option: 'Color-coded badge with icon'
        description: >
          Display CI status as a colored badge: green/CheckCircle for Success, yellow/Loader
          for Pending, red/XCircle for Failure. Follows GitHub's visual language for CI
          status. Compact and immediately scannable. Uses existing shadcn/ui Badge component
          with Lucide icons.
        selected: true
      - option: 'Text-only status line'
        description: >
          Display CI status as plain text ("CI: Passing", "CI: Pending", "CI: Failing")
          without color coding. Simpler but loses the visual immediacy of color-coded
          indicators. Less consistent with GitHub's UI patterns.
        selected: false
    selectionRationale: >
      Color-coded badges with icons are recommended because they provide instant visual
      feedback on merge readiness. Success (green), Pending (yellow), and Failure (red)
      follow universal CI/CD conventions. This matches GitHub's own status indicator pattern
      which users are already familiar with.
    answer: 'Color-coded badge with icon'

  - question: >
      Should the drawer display the branch merge direction (source → target) and
      implementation phases from the plan artifact?
    impact: Determines additional contextual information shown in the merge review drawer.
    resolved: true
    options:
      - option: 'Show branch direction and phases'
        description: >
          Display a visual indicator showing the source branch merging into the target
          branch (e.g., "feat/my-feature → main") using GitBranch and ArrowRight icons
          in a GitHub-like pill layout. Also show implementation phases from the plan
          artifact via GetPlanArtifactUseCase (best-effort). Provides valuable context
          for the merge decision — users see what branch is merging where and what phases
          were completed. Low additional complexity since branch data comes from Feature
          and phases from an existing use case.
        selected: true
      - option: 'PR metadata and diff only'
        description: >
          Only show the PR card (URL, number, CI, commit hash) and diff summary grid.
          Simpler layout, but missing branch context that helps users understand the merge
          scope. Users would need to click through to GitHub to see branch names.
        selected: false
    selectionRationale: >
      Showing branch direction and phases is recommended because it provides essential
      context for the merge approval decision without significant implementation cost.
      The branch data is already available on the Feature entity (feature.branch for source,
      'main' as target). Phases come from GetPlanArtifactUseCase which is already used by
      other server actions (best-effort, so it won't block if unavailable). This makes
      the merge drawer a self-contained decision surface — users can approve without
      leaving the app.
    answer: 'Show branch direction and phases'

content: |
  ## Problem Statement

  When a feature's agent reaches the merge phase and requires approval (`allowMerge=false`),
  the agent interrupts and sets the feature to `lifecycle=Review` with
  `agentRun.status=waiting_approval`. The web UI currently has no dedicated handling for
  this state — users see a generic feature drawer with no PR context, no diff summary,
  and no merge-specific actions.

  This feature adds:

  1. **Feature node badge**: An emerald/GitMerge badge on the canvas node displaying
     "Review Merge Request", visually distinct from requirements (amber/FileText) and
     implementation (indigo/Wrench).

  2. **Merge review drawer**: A read-only drawer (following ReviewDrawerShell composition)
     displaying PR metadata, branch merge direction, diff summary statistics, CI status,
     implementation phases, and an "Approve Merge" action button.

  3. **Control center integration**: Lifecycle-aware drawer routing so that
     `review + action-required` opens the merge review drawer instead of the generic
     FeatureDrawer, with proper data fetching and loading states.

  4. **Server action**: A `getMergeReviewData(featureId)` server action that reads
     Feature.pr for PR metadata, fetches plan phases (best-effort), and calls
     IGitPrService.getPrDiffSummary() for diff statistics with graceful fallback.

  ## Success Criteria

  - [ ] Feature node in `review + action-required` state displays emerald badge with GitMerge icon and "Review Merge Request" text
  - [ ] Badge color (emerald) is visually distinct from requirements (amber) and implementation (indigo) badges
  - [ ] Clicking a feature node in `review + action-required` opens the merge review drawer (not the generic FeatureDrawer)
  - [ ] Merge review drawer displays PR URL as an external link (opens in new tab)
  - [ ] Merge review drawer displays PR number (e.g., "#42")
  - [ ] Merge review drawer displays CI status using the existing CiStatusBadge component (green/yellow/red)
  - [ ] Merge review drawer displays commit hash truncated to 7 characters
  - [ ] Merge review drawer displays branch merge direction (source → target) with GitBranch icons
  - [ ] Merge review drawer displays aggregate diff summary: files changed, additions (green), deletions (red), commit count
  - [ ] Merge review drawer displays implementation phases list when plan artifact is available
  - [ ] "Approve Merge" button triggers the shared approveFeature() server action and shows a success toast
  - [ ] Drawer includes delete action via ReviewDrawerShell for abandoning features
  - [ ] When diff summary is unavailable (worktree deleted), drawer shows PR metadata with a warning and approve still works
  - [ ] When Feature.pr is undefined, drawer shows appropriate empty state without crashing
  - [ ] Server action validates featureId input (non-empty string)
  - [ ] Server action returns structured error on failure (not unhandled exception)
  - [ ] Loading spinner shown while server action is in flight
  - [ ] All merge-review component files have colocated Storybook stories
  - [ ] Stories cover: default state, CI pending, CI failure, no diff summary, no PR, processing state, with phases
  - [ ] Unit tests cover the merge review content component rendering logic
  - [ ] Unit tests cover the getMergeReviewData server action (success, fallback, error paths)

  ## Functional Requirements

  ### Feature Node Badge (FR-1 through FR-3)

  - **FR-1**: `getBadgeIcon()` MUST return the `GitMerge` icon from Lucide React when
    `state === 'action-required'` and `lifecycle === 'review'`.

  - **FR-2**: `getBadgeText()` MUST return `"Review Merge Request"` when
    `state === 'action-required'` and `lifecycle === 'review'`.

  - **FR-3**: `getActionRequiredBadgeClasses()` MUST return emerald color classes
    (`text-emerald-700`, `bg-emerald-50`, `border-emerald-200`) when
    `lifecycle === 'review'`, distinct from amber (requirements) and indigo (implementation).

  ### Merge Review Drawer Component (FR-4 through FR-12)

  - **FR-4**: The merge review drawer MUST follow the established 5-file directory pattern:
    `merge-review-config.ts` (interfaces), `merge-review.tsx` (content component),
    `merge-review-drawer.tsx` (shell wrapper), `merge-review.stories.tsx` (stories),
    `index.ts` (barrel exports).

  - **FR-5**: The content component MUST display a PR metadata card containing:
    PR URL as an external link (`target="_blank"`, `rel="noopener noreferrer"`),
    PR number, PR status, commit hash (truncated to 7 chars), and CI status via the
    existing `CiStatusBadge` component.

  - **FR-6**: The content component MUST display branch merge direction showing
    `source branch → target branch` using GitBranch and ArrowRight icons in a pill layout,
    where source is `Feature.branch` and target is `'main'`.

  - **FR-7**: The content component MUST display aggregate diff summary statistics in a
    grid layout: files changed (with FileDiff icon), additions (green text with `+` prefix),
    deletions (red text with `-` prefix), and commit count (with GitCommitHorizontal icon).

  - **FR-8**: The content component MUST display implementation phases from the plan artifact
    when available, listed with a Layers icon header. Phases are best-effort and the section
    is omitted when the plan artifact is unavailable.

  - **FR-9**: The content component MUST render a `DrawerActionBar` with an "Approve Merge"
    button that triggers the `onApprove` callback. The approve icon MUST be `GitMerge`.

  - **FR-10**: When `MergeReviewData.diffSummary` is undefined, the diff summary grid MUST
    be hidden and a warning message MUST be displayed (from `MergeReviewData.warning`)
    using an AlertTriangle icon. The approve action MUST remain functional.

  - **FR-11**: When `MergeReviewData.pr` is undefined, the PR metadata card and CI badge
    MUST be omitted. The drawer MUST NOT crash — it should show whatever data is available.

  - **FR-12**: The `MergeReviewDrawer` wrapper MUST use `ReviewDrawerShell` with the
    standard header (feature name, description) and show a centered `Loader2` spinner
    when `data` is null (loading state).

  ### Control Center Integration (FR-13 through FR-17)

  - **FR-13**: The control center MUST compute `showMergeReviewDrawer` as
    `selectedNode?.lifecycle === 'review' && selectedNode?.state === 'action-required'`.

  - **FR-14**: When `showMergeReviewDrawer` is true, the control center MUST fetch data via
    `getMergeReviewData(featureId)` in a `useEffect` with a cancellation flag pattern
    (matching PRD and Tech Decision drawer data fetching).

  - **FR-15**: When `showMergeReviewDrawer` is true, the control center MUST render
    `MergeReviewDrawer` instead of the generic `FeatureDrawer`.

  - **FR-16**: The `handleMergeApprove` callback MUST invoke the shared
    `handleSimpleApprove('Merge')` function and display a success toast via sonner.

  - **FR-17**: If the `getMergeReviewData` server action returns `{ error: string }`,
    the control center MUST display an error toast and not set merge review data.

  ### Server Action (FR-18 through FR-22)

  - **FR-18**: The `getMergeReviewData` server action MUST be defined with `'use server'`
    directive and accept a single `featureId: string` parameter.

  - **FR-19**: The server action MUST validate that `featureId` is a non-empty string and
    return `{ error: 'Feature ID is required' }` if validation fails.

  - **FR-20**: The server action MUST resolve `IFeatureRepository` via `resolve<T>(token)`
    DI pattern and fetch the Feature by ID. If the feature is not found, return
    `{ error: string }`.

  - **FR-21**: The server action MUST extract PR metadata from `Feature.pr` (url, number,
    status, commitHash, ciStatus) and construct branch data from `Feature.branch` (source)
    and `'main'` (target). It MUST also attempt to load plan phases from
    `GetPlanArtifactUseCase` as best-effort (catch and continue on failure).

  - **FR-22**: The server action MUST call `IGitPrService.getPrDiffSummary(worktreePath, 'main')`
    for diff statistics. If the call fails or `worktreePath` is undefined, the action MUST
    return the result without `diffSummary` and include a `warning` string explaining that
    diff statistics are unavailable.

  ### Page.tsx Lifecycle Mapping (FR-23)

  - **FR-23**: The `nodeToLifecyclePhase` map in `page.tsx` MUST include
    `merge: 'review'` so that features in the merge agent node resolve to the `review`
    lifecycle phase, triggering the merge review drawer.

  ## Non-Functional Requirements

  - **NFR-1 — Pattern Consistency**: All new components MUST follow the established
    ReviewDrawerShell composition pattern (3 layers: shell, content, action bar) and the
    5-file directory convention used by PRD and Tech Decision review drawers.

  - **NFR-2 — Type Safety**: The `MergeReviewData`, `MergeReviewPr`, `MergeReviewDiffSummary`,
    `MergeReviewPhase`, and `MergeReviewBranch` interfaces MUST be defined in a dedicated
    `merge-review-config.ts` file. Domain types (`PrStatus`, `CiStatus`) MUST be imported
    from generated output, not redefined.

  - **NFR-3 — Loading Performance**: The merge review drawer MUST show a loading spinner
    immediately on open and render content once the server action completes. The server
    action MUST NOT block on optional data — plan phases and diff summary fetch failures
    MUST NOT prevent the drawer from rendering available data.

  - **NFR-4 — Graceful Degradation**: The drawer MUST render correctly with any combination
    of missing optional data: no PR, no diff summary, no phases, no CI status, no commit
    hash. Each section MUST independently handle its data being undefined.

  - **NFR-5 — Accessibility**: PR URL MUST open in a new tab with `rel="noopener noreferrer"`.
    All interactive elements (approve button, external link) MUST be keyboard-accessible.
    Color-coded CI badges MUST include text labels (not color-only).

  - **NFR-6 — Storybook Coverage**: Every component in the `merge-review/` directory MUST
    have colocated `.stories.tsx` files covering: default state, each CI status variant
    (success, pending, failure), missing diff summary with warning, missing PR data,
    processing/loading state, and with implementation phases.

  - **NFR-7 — Test Coverage**: Unit tests MUST cover: (a) merge review content rendering
    for all data combinations, (b) server action success path, (c) server action graceful
    fallback when diff summary fails, (d) server action error path (missing feature,
    invalid input).

  - **NFR-8 — No Domain Model Changes**: This feature MUST NOT require changes to TypeSpec
    models, generated domain types, database migrations, or backend agent nodes. All data
    MUST be sourced from existing persisted fields (Feature.pr) and existing service
    interfaces (IGitPrService.getPrDiffSummary).

  - **NFR-9 — Visual Consistency**: The emerald color palette for the merge badge MUST
    use Tailwind CSS v4 emerald utilities (emerald-50, emerald-200, emerald-700) consistent
    with how amber and indigo are used for requirements and implementation badges respectively.

  - **NFR-10 — Error Isolation**: A failure in the `getMergeReviewData` server action MUST
    NOT crash the control center or prevent navigation. Errors MUST be caught, displayed
    via toast, and the drawer MUST remain closable.

  ## Product Questions & AI Recommendations

  | # | Question | AI Recommendation | Rationale |
  | - | -------- | ----------------- | --------- |
  | 1 | Data access architecture for merge drawer content? | Read Feature.pr + regenerate diff summary | Avoids domain model changes, uses existing persisted data and server action patterns, keeps diff data fresh |
  | 2 | Badge color scheme and icon? | Emerald with GitMerge icon | Matches GitHub's merge button convention, creates clear visual progression: amber → indigo → emerald |
  | 3 | Reject/request-changes action? | Approve only (with delete as escape hatch) | Matches PRD/Tech pattern, rejection would require significant backend LangGraph changes out of scope |
  | 4 | Chat input for refinement? | Read-only display with approve action | Merge is a binary decision, no backend support for feedback-based revision, PR link is escape hatch |
  | 5 | Worktree unavailable handling? | Graceful degradation with PR-only fallback | Diff summary is supplementary, approve doesn't depend on it, blocking on display error frustrates users |
  | 6 | Diff summary granularity? | Aggregate statistics only | Matches existing DiffSummary interface, no API changes needed, GitHub linked for full review |
  | 7 | CI status display? | Color-coded badge with icon | Uses existing CiStatusBadge component, follows GitHub's visual language, instantly scannable |
  | 8 | Branch direction and phases? | Show both | Low cost (data already available), provides essential merge context, makes drawer self-contained |

  ## Affected Areas

  | Area | Impact | Reasoning |
  | ---- | ------ | --------- |
  | `components/common/feature-node/feature-node.tsx` (304 lines) | Medium | `getBadgeText()`, `getBadgeIcon()`, and `getActionRequiredBadgeClasses()` need `review` lifecycle cases for emerald/GitMerge badge |
  | `components/common/merge-review/` (5 files, ~340 lines total) | High | New directory with complete 5-file pattern: config, content component, drawer wrapper, stories, barrel exports |
  | `components/features/control-center/control-center-inner.tsx` (464 lines) | Medium | `showMergeReviewDrawer` boolean, merge data state, useEffect data fetch with cancellation, approve/reject callbacks, conditional MergeReviewDrawer rendering, FeatureDrawer suppression |
  | `app/actions/get-merge-review-data.ts` (65 lines) | Medium | New server action resolving Feature via DI, extracting Feature.pr, calling GetPlanArtifactUseCase for phases (best-effort), calling IGitPrService.getPrDiffSummary() with graceful fallback |
  | `app/page.tsx` (168 lines) | Low | Already has `merge: 'review'` in `nodeToLifecyclePhase` map — verify present |
  | `components/common/feature-node/feature-node.stories.tsx` | Low | AllStates story needs review + action-required variant with emerald badge |
  | `components/features/control-center/control-center.stories.tsx` | Low | Needs merge review node variant showing drawer integration |
  | `components/common/feature-node/feature-node-state-config.ts` (152 lines) | None | `review` lifecycle phase already defined in types and config maps — no changes needed |
  | `components/common/feature-node/derive-feature-state.ts` (131 lines) | None | State derivation already handles review, `phaseNameToLifecycle` already has `merge: 'review'` — no changes needed |
  | `components/common/ci-status-badge/ci-status-badge.tsx` (30 lines) | None | Reused by merge-review.tsx as-is — no changes needed |
  | `components/common/review-drawer-shell/` (142 lines) | None | Reused as wrapper — no changes needed |
  | `components/common/drawer-action-bar/` (64 lines) | None | Reused for approve/reject footer — no changes needed |

  ## Dependencies

  **Existing components reused (no modifications needed):**
  - `ReviewDrawerShell` (142 lines) — Shared drawer shell with header, feature actions menu, delete action
  - `CiStatusBadge` (30 lines) — Color-coded CI status badge (green/yellow/red)
  - `DrawerActionBar` (64 lines) — Approve/reject action bar with revision input and reject dialog
  - `useFeatureActions` hook — IDE/shell/folder actions, already used by ReviewDrawerShell
  - `approveFeature()` server action (40 lines) — Works for all approval gates including merge
  - `rejectFeature()` server action (52 lines) — Shared reject flow for all drawer types
  - `resolve()` from `lib/server-container.ts` (37 lines) — DI resolution for server actions

  **Domain types from `packages/core/src/domain/generated/output.ts` (auto-generated):**
  - `Feature` — Aggregate root with `.pr?: PullRequest` field
  - `PullRequest` — `{ url, number, status: PrStatus, commitHash?, ciStatus?: CiStatus }`
  - `PrStatus` enum — `Open | Merged | Closed`
  - `CiStatus` enum — `Pending | Success | Failure`
  - `SdlcLifecycle` enum — Includes `Review` value
  - `AgentRunStatus` enum — Includes `waitingApproval`

  **Service interfaces used (read-only, no modifications):**
  - `IFeatureRepository.findById(id)` — Fetch Feature with populated `pr` field
  - `IGitPrService.getPrDiffSummary(cwd, baseBranch)` — Returns `DiffSummary { filesChanged, additions, deletions, commitCount }`
  - `GetPlanArtifactUseCase.execute(featureId)` — Returns plan with phases for the implementation phases list

  **Backend infrastructure (no changes needed):**
  - `merge.node.ts` (300+ lines) — Sets `Feature.pr` before interrupt, passes `diffSummary` in interrupt payload
  - `feature-agent-worker.ts` — Sets `AgentRunStatus.waitingApproval` on interrupt
  - `ApproveAgentRunUseCase` — Resumes the LangGraph agent from interrupt, works for merge gate

  ## Size Estimate

  **M (2-3 days)** — This feature is well-scoped and follows established patterns exactly:

  - **New files (6):** `merge-review-config.ts` (~85 lines), `merge-review.tsx` (~196 lines),
    `merge-review-drawer.tsx` (~43 lines), `merge-review.stories.tsx` (~241 lines),
    `index.ts` (~8 lines), `get-merge-review-data.ts` (~65 lines)
  - **Modified files (3):** `feature-node.tsx` (3 small function additions ~15 lines total),
    `control-center-inner.tsx` (drawer integration following exact PRD/Tech pattern ~60 lines),
    `page.tsx` (1 map entry — verify already present)
  - **Story additions (2):** Feature node review variant in AllStates, control center merge node variant
  - **No domain model changes**, no TypeSpec modifications, no migrations, no backend changes
  - **Risk is low** because every pattern is already proven in PRD and Tech Decision drawers
  - The merge-review content component is simpler than PRD (no multi-step questionnaire) and
    Tech Decisions (no collapsible alternatives) — it's a read-only display with approve action
  - TDD cycles add ~30% overhead but all test boundaries are clear

  **Note:** Analysis of the current branch reveals that this feature appears to be **already
  fully implemented**. All 5 merge-review component files exist with complete implementations,
  the server action is in place, feature-node.tsx has all three review lifecycle cases,
  control-center-inner.tsx has full merge drawer integration, page.tsx has the
  `merge: 'review'` mapping, and stories include merge review variants.

  ---

  _Requirements phase completed — proceed with research_
