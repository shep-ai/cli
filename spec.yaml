# Feature Specification (YAML)
# This is the source of truth. Markdown is auto-generated from this file.

name: merge-review-drawer
number: 036
branch: feat/merge-review-drawer
oneLiner: Add merge review drawer and feature node visualization for the Review lifecycle phase
summary: >
  When a feature reaches the merge approval gate (lifecycle=Review, state=action-required),
  the feature node displays a distinct emerald/GitMerge badge and a dedicated merge review
  drawer opens showing PR metadata, diff summary, CI status, implementation phases, and
  branch direction with an approve action. The drawer follows the ReviewDrawerShell composition
  pattern, reads data from Feature.pr with on-demand diff regeneration via a server action,
  and gracefully degrades when diff stats or PR data are unavailable.
phase: Requirements
sizeEstimate: M

# Relationships
relatedFeatures: []

technologies:
  - React 19 (Next.js 16+ App Router)
  - shadcn/ui (Radix + Tailwind CSS v4)
  - React Flow (@xyflow/react)
  - Storybook
  - Vaul (drawer primitive)
  - LangGraph (interrupt/resume for approval gates)
  - Lucide React (GitMerge / GitPullRequest / CheckCircle2 / XCircle / Loader2 / ExternalLink / FileDiff icons)
  - sonner (toast notifications)
  - tsyringe (DI container for server actions)

relatedLinks: []

openQuestions:
  - question: >
      The merge interrupt payload (diffSummary, prUrl, prNumber) is stored only in the
      LangGraph checkpoint, not persisted to the Feature or AgentRun entity. Should we
      (A) add an interruptPayload field to AgentRun and persist it when status becomes
      waitingApproval, or (B) create a use case that reads the checkpoint directly, or
      (C) read the Feature.pr field (which is populated before the interrupt in merge.node.ts
      lines 144-158) and generate the diff summary on demand via a new server action?
    impact: Determines the data access architecture for the merge drawer content.
    resolved: true
    options:
      - option: 'Persist interruptPayload on AgentRun'
        description: >
          Add a new interruptPayload JSON field to AgentRun and persist the merge interrupt
          data when status becomes waitingApproval. Pros: single source of truth, no
          recomputation. Cons: requires TypeSpec model change, migration, and changes to
          the worker persistence layer — high blast radius for a display-only feature.
        selected: false
      - option: 'Read LangGraph checkpoint directly'
        description: >
          Create a use case that reads the LangGraph checkpoint to extract the interrupt
          payload. Pros: no model changes. Cons: couples the UI data layer to LangGraph
          internals, checkpoint format may change, adds complexity to the read path.
        selected: false
      - option: 'Read Feature.pr + regenerate diff summary'
        description: >
          Create a new server action that reads Feature.pr for PR metadata (url, number,
          status, commitHash, ciStatus) and calls gitPrService.getPrDiffSummary() for
          diff statistics. Pros: uses already-persisted data, no model changes, follows
          existing server action patterns, diff summary is always fresh. Cons: requires
          the worktree to still exist for diff computation (which it does during review).
        selected: true
    selectionRationale: >
      Option C is recommended because Feature.pr is already populated before the interrupt
      (merge.node.ts:144-158) and contains all PR metadata. The diff summary can be
      regenerated on demand via the existing IGitPrService.getPrDiffSummary() method.
      This avoids any domain model changes, follows the established server action pattern
      (like get-feature-artifact.ts and get-research-artifact.ts), and keeps the diff
      data fresh. The worktree is guaranteed to exist during the Review lifecycle phase.
    answer: 'Read Feature.pr + regenerate diff summary'

  - question: >
      What color scheme and icon should the merge review badge use on the feature node
      to distinguish it from requirements (amber/FileText) and implementation (indigo/Wrench)?
    impact: Determines the visual identity of the merge review state in the canvas.
    resolved: true
    options:
      - option: 'Green with GitMerge icon'
        description: >
          Use green (emerald) color scheme with the GitMerge icon from Lucide React.
          Green conveys "ready to merge / success", GitMerge directly represents the
          action. Consistent with GitHub's merge button color. Distinct from amber
          (requirements) and indigo (implementation).
        selected: true
      - option: 'Purple with GitPullRequest icon'
        description: >
          Use purple/violet color scheme with GitPullRequest icon. Purple is visually
          distinct but doesn't carry semantic meaning related to merging. GitPullRequest
          represents the PR itself rather than the merge action.
        selected: false
      - option: 'Teal with GitMerge icon'
        description: >
          Use teal/cyan color scheme with GitMerge icon. Teal is distinct from existing
          colors but less semantically meaningful than green for a merge action.
        selected: false
    selectionRationale: >
      Green (emerald) with GitMerge is recommended because it creates an intuitive visual
      language: green = ready to proceed/merge, matching GitHub's merge button convention.
      The GitMerge icon directly communicates the action being reviewed. The three review
      states form a clear progression: amber (requirements) → indigo (implementation) →
      green (merge), each visually distinct and semantically meaningful.
    answer: 'Green with GitMerge icon'

  - question: >
      Should the merge review drawer include a reject/request-changes action in addition
      to approve, and if so what should happen on rejection?
    impact: Determines the drawer action buttons and the rejection flow.
    resolved: true
    options:
      - option: 'Approve only (with delete as escape hatch)'
        description: >
          Only show an Approve button. Users who don't want to merge can delete the
          feature or close the drawer and leave it pending. Simple, matches the existing
          PRD/Tech drawer pattern which only has approve. The ReviewDrawerShell already
          provides a delete button for abandoning features.
        selected: true
      - option: 'Approve + Reject with agent feedback loop'
        description: >
          Add a Reject button that sends feedback to the agent, which would then revise
          the PR. Requires new LangGraph interrupt response handling, new domain model
          fields, and significant backend work. More complete UX but high implementation
          cost and out of scope for an M-sized feature.
        selected: false
    selectionRationale: >
      Approve-only is recommended to match the established pattern used by PRD and Tech
      Decision drawers. The ReviewDrawerShell already provides delete as an escape hatch
      for abandoning a feature. Adding rejection would require significant backend changes
      to the LangGraph interrupt/resume flow, which is out of scope. A reject flow can be
      added as a separate feature if needed.
    answer: 'Approve only (with delete as escape hatch)'

  - question: >
      Should the merge review drawer content include a chat input for refinement feedback
      (like PRD and Tech drawers) or only display read-only PR information with an approve action?
    impact: Determines whether the drawer supports conversational refinement before approval.
    resolved: true
    options:
      - option: 'Read-only display with approve action'
        description: >
          Show PR metadata, diff summary, and CI status as read-only content with an
          approve button. No chat input. Merge review is a binary decision (approve or
          not) — there's nothing to "refine" like requirements or tech decisions. Simpler
          to implement and matches the nature of the merge gate.
        selected: true
      - option: 'Include chat input for feedback'
        description: >
          Include a chat input like the other drawers for consistency. Users could send
          feedback that gets passed to the agent. However, the merge node doesn't currently
          support feedback-based revision, so the chat input would be non-functional or
          require backend changes.
        selected: false
    selectionRationale: >
      Read-only is recommended because merge review is fundamentally a binary approval
      decision, unlike requirements (where users select options) or tech decisions (where
      users can request plan revisions). The merge node's interrupt flow doesn't support
      feedback-based revision. Adding a non-functional chat input would be misleading.
      The PR link provides an escape hatch for users who want to review code in detail
      on GitHub.
    answer: 'Read-only display with approve action'

  - question: >
      How should the drawer handle the case where the worktree has been deleted or the
      git repository is unavailable, making diff summary regeneration impossible?
    impact: Determines error handling and fallback behavior for the merge drawer.
    resolved: true
    options:
      - option: 'Graceful degradation with PR-only fallback'
        description: >
          If diff summary fails, show PR metadata from Feature.pr (URL, number, status,
          CI status) without diff stats. Display a subtle warning that diff stats are
          unavailable. The approve action still works since it only needs the agentRunId.
          Low implementation cost, good UX.
        selected: true
      - option: 'Block drawer with error state'
        description: >
          Show a full error state in the drawer when diff summary fails. Prevents users
          from seeing partial data. However, blocking approval because of a display issue
          would be frustrating — the user can always review the PR on GitHub.
        selected: false
    selectionRationale: >
      Graceful degradation is recommended because the diff summary is supplementary
      information — the core action (approve merge) doesn't depend on it. Feature.pr
      data is already persisted and always available. Blocking the entire drawer because
      of a transient git error would frustrate users unnecessarily. The PR URL provides
      a direct link to review changes on GitHub regardless.
    answer: 'Graceful degradation with PR-only fallback'

  - question: >
      Should the diff summary section display file-level change details (list of changed files
      with per-file additions/deletions) or only aggregate statistics?
    impact: Determines the granularity of diff information shown in the drawer and server action complexity.
    resolved: true
    options:
      - option: 'Aggregate statistics only'
        description: >
          Show total files changed, total additions, total deletions, and commit count.
          Matches the DiffSummary interface already returned by IGitPrService.getPrDiffSummary().
          No additional API calls or interface changes needed. Users who want file-level
          details can click the PR link to view on GitHub.
        selected: true
      - option: 'File-level details with per-file stats'
        description: >
          Show a list of each changed file with individual addition/deletion counts.
          Richer information but requires extending IGitPrService with a new method or
          modifying getPrDiffSummary() to return per-file data. Increases server action
          complexity and drawer layout complexity.
        selected: false
    selectionRationale: >
      Aggregate statistics are recommended because the existing IGitPrService.getPrDiffSummary()
      already returns exactly this data shape (filesChanged, additions, deletions, commitCount).
      No interface changes needed. The merge drawer's purpose is to provide a quick approval
      decision, not a full code review — GitHub serves that purpose and is linked from the PR URL.
    answer: 'Aggregate statistics only'

  - question: >
      How should CI status be visually represented in the merge review drawer?
    impact: Determines the CI status display pattern and how users assess merge readiness.
    resolved: true
    options:
      - option: 'Color-coded badge with icon'
        description: >
          Display CI status as a colored badge: green/CheckCircle for Success, yellow/Loader
          for Pending, red/XCircle for Failure. Follows GitHub's visual language for CI
          status. Compact and immediately scannable. Uses existing shadcn/ui Badge component
          with Lucide icons.
        selected: true
      - option: 'Text-only status line'
        description: >
          Display CI status as plain text ("CI: Passing", "CI: Pending", "CI: Failing")
          without color coding. Simpler but loses the visual immediacy of color-coded
          indicators. Less consistent with GitHub's UI patterns.
        selected: false
    selectionRationale: >
      Color-coded badges with icons are recommended because they provide instant visual
      feedback on merge readiness. Success (green), Pending (yellow), and Failure (red)
      follow universal CI/CD conventions. This matches GitHub's own status indicator pattern
      which users are already familiar with.
    answer: 'Color-coded badge with icon'

  - question: >
      Should the DrawerActionBar include a reject flow with inline revision input and
      feedback dialog, or only an approve button since merge is a binary decision?
    impact: Determines whether the merge drawer supports rejection with feedback or approve-only.
    resolved: true
    options:
      - option: 'Include reject flow via DrawerActionBar'
        description: >
          Use the shared DrawerActionBar component which provides inline revision input,
          reject button with feedback dialog, and approve button. Even though merge is
          primarily a binary decision, the reject flow allows users to send the agent back
          to revise the PR before merging. Reuses existing shared components and follows
          the same pattern as other review drawers. The backend already supports rejection
          via rejectFeature() server action.
        selected: true
      - option: 'Approve-only button without reject'
        description: >
          Show only an approve button. Simpler UI but loses the ability to request
          revisions before merging. Users would need to delete and recreate the feature
          if they want changes. Inconsistent with the DrawerActionBar component's design.
        selected: false
    selectionRationale: >
      Including the reject flow is recommended because the shared DrawerActionBar already
      provides this capability at zero additional implementation cost, and the backend
      rejectFeature() server action already works for all approval gates. This gives users
      the ability to request revisions before merging without deleting the feature. The
      inline revision input with placeholder "Ask AI to revise before merging..." makes
      the purpose contextually clear.
    answer: 'Include reject flow via DrawerActionBar'

content: |
  ## Problem Statement

  When a feature's agent reaches the merge phase and requires approval (`allowMerge=false`),
  the agent interrupts and sets the feature to `lifecycle=Review` with
  `agentRun.status=waiting_approval`. Prior to this feature, the web UI had no dedicated
  handling for this state combination:

  1. **Feature node**: The `getBadgeText()` function had no specific case for
     `lifecycle === 'review'` when `state === 'action-required'` — it fell through to the
     generic "User action required" label.
  2. **Feature node badge color**: The `getActionRequiredBadgeClasses()` function only handled
     `implementation` (indigo) — `review` fell through to the default amber, making it
     indistinguishable from PRD review.
  3. **No merge drawer**: The `control-center-inner.tsx` only checked for `showPrdDrawer`
     (requirements + action-required) and `showTechDecisionsDrawer` (implementation +
     action-required). There was no `showMergeReviewDrawer` condition.
  4. **No merge drawer component**: Unlike `prd-questionnaire/` and `tech-decisions-review/`,
     there was no `merge-review/` component directory.
  5. **FeatureDrawer exclusion**: The standard `FeatureDrawer` excluded PRD and Tech drawers
     but did not account for the merge review state.

  ## Success Criteria

  - [ ] Feature node in `lifecycle=review` + `state=action-required` displays emerald badge with GitMerge icon and text "Review Merge Request"
  - [ ] Feature node badge color (emerald) is visually distinct from requirements (amber) and implementation (indigo)
  - [ ] Clicking a merge-review feature node opens the MergeReviewDrawer (not the generic FeatureDrawer)
  - [ ] Merge review drawer displays PR metadata: PR number as external link, PR status, commit hash (truncated to 7 chars), and CI status badge
  - [ ] Merge review drawer displays aggregate diff summary: files changed, additions (green), deletions (red), commit count
  - [ ] Merge review drawer displays implementation phases when plan data is available
  - [ ] Merge review drawer displays branch direction (source → target) when branch data is available
  - [ ] Approve button in drawer calls approveFeature() and resumes the agent, showing success toast
  - [ ] Reject flow via DrawerActionBar sends feedback to the agent via rejectFeature() and shows success toast
  - [ ] When diff summary is unavailable (worktree deleted, git error), drawer shows PR metadata with a warning — approve still works
  - [ ] When no PR exists (direct merge without PR), drawer shows diff summary and branch info without PR card
  - [ ] When no PR and no worktree exist, drawer shows warning "No PR or diff data available" — approve still works
  - [ ] Server action validates featureId input and returns structured error for missing/invalid feature
  - [ ] Loading state: drawer shows Loader2 spinner while data is being fetched
  - [ ] Processing state: approve/reject buttons disabled while approval is in flight
  - [ ] All 5 component files follow the established review drawer pattern: config, content, drawer wrapper, stories, barrel export
  - [ ] Storybook stories cover all major variants: default, CI states (success/pending/failure), no diff, no CI, no PR, processing, with phases, in drawer, with delete
  - [ ] Unit tests cover server action (validation, error handling, data mapping, graceful fallbacks) and component (rendering, interactions, edge cases)
  - [ ] `merge: 'review'` mapping exists in page.tsx `nodeToLifecyclePhase`
  - [ ] FeatureDrawer is suppressed when merge review drawer is active

  ## Functional Requirements

  ### Feature Node Visualization

  - **FR-1**: When a feature is in `lifecycle=review` + `state=action-required`, the feature node badge MUST display the text "Review Merge Request" via `getBadgeText()`.
  - **FR-2**: The feature node badge icon MUST be the Lucide `GitMerge` icon when `lifecycle=review` + `state=action-required`, returned by `getBadgeIcon()`.
  - **FR-3**: The feature node badge MUST use emerald color classes (`bg-emerald-100 text-emerald-800 border-emerald-200`) when `lifecycle=review`, returned by `getActionRequiredBadgeClasses()`.

  ### Merge Review Drawer — Data Layer

  - **FR-4**: A `getMergeReviewData(featureId)` server action MUST exist that resolves the Feature via `IFeatureRepository`, extracts PR metadata from `Feature.pr`, loads plan phases via `GetPlanArtifactUseCase` (best-effort), and fetches diff summary via `IGitPrService.getPrDiffSummary()`.
  - **FR-5**: The server action MUST validate that `featureId` is non-empty and non-whitespace, returning `{ error: 'Feature id is required' }` on invalid input.
  - **FR-6**: The server action MUST return `{ error: 'Feature not found' }` when the feature does not exist.
  - **FR-7**: The server action MUST construct branch info from `feature.branch` (source) with target hardcoded as `'main'`.
  - **FR-8**: The server action MUST attempt diff summary loading only when `feature.worktreePath` exists, and MUST return a `warning` field ("Diff statistics unavailable") when the diff call fails.
  - **FR-9**: The server action MUST return `warning: 'No PR or diff data available'` when neither PR nor worktree path exist.
  - **FR-10**: The server action MUST silently handle plan phase loading failure (phases set to `undefined`) without failing the overall request.

  ### Merge Review Drawer — Component

  - **FR-11**: The `MergeReview` content component MUST display a PR metadata card showing: PR number as an external link (`target="_blank"`, `rel="noopener noreferrer"`), PR status text, CI status badge (via `CiStatusBadge`), and truncated commit hash (first 7 characters).
  - **FR-12**: The `MergeReview` component MUST display an aggregate diff summary card with a 4-column grid: files changed, additions (green with `+` prefix), deletions (red with `-` prefix), and commit count.
  - **FR-13**: The `MergeReview` component MUST display a branch direction card showing `source → target` when branch data is present.
  - **FR-14**: The `MergeReview` component MUST display a numbered list of implementation phases (name + description) when phase data is present.
  - **FR-15**: The `MergeReview` component MUST render a `DrawerActionBar` with an approve button (GitMerge icon), inline revision input (placeholder: "Ask AI to revise before merging..."), and reject button with feedback dialog.
  - **FR-16**: When no PR data exists, the component MUST show alternate descriptive text ("Review the changes and approve to merge") instead of PR-specific language.
  - **FR-17**: When CI status is undefined, the entire CI section MUST be omitted (not shown as "unknown").
  - **FR-18**: When commit hash is undefined, the commit hash row MUST be omitted.
  - **FR-19**: When diff summary is unavailable, the component MUST display the warning message text instead of the diff summary card.
  - **FR-20**: When phases or branch data are absent, their respective sections MUST be omitted.

  ### Merge Review Drawer — Shell Wrapper

  - **FR-21**: The `MergeReviewDrawer` wrapper MUST compose `ReviewDrawerShell` with the `MergeReview` content component, showing a `Loader2` spinner while data is `null`.
  - **FR-22**: The drawer wrapper MUST pass through all ReviewDrawerShell props: `open`, `onClose`, `featureName`, `featureId`, `repositoryPath`, `branch`, `specPath`, `onDelete`, `isDeleting`.

  ### Control Center Integration

  - **FR-23**: The control center MUST derive `showMergeReviewDrawer = selectedNode?.lifecycle === 'review' && selectedNode?.state === 'action-required'` to determine when to render the merge drawer.
  - **FR-24**: When `showMergeReviewDrawer` is true, the control center MUST call `getMergeReviewData(featureId)` via a `useEffect` with cancellation pattern, storing the result in component state.
  - **FR-25**: The control center MUST suppress the generic `FeatureDrawer` when the merge review drawer is active.
  - **FR-26**: The approve callback MUST call `approveFeature(featureId)`, show a success toast ("Merge approved — agent resuming"), and clear the selection to close the drawer.
  - **FR-27**: The reject callback MUST call `rejectFeature(featureId, feedback)`, play the caution sound effect, show a success toast with iteration count, and clear the selection.
  - **FR-28**: On server action error, the control center MUST show an error toast and keep the drawer closed (data remains null → loading spinner).

  ### Page Mapping

  - **FR-29**: The `nodeToLifecyclePhase` map in `page.tsx` MUST include the entry `merge: 'review'` so that features at the merge agent node are mapped to the `review` lifecycle phase.

  ### Storybook Stories

  - **FR-30**: The `merge-review.stories.tsx` MUST include story variants covering: Default (full data, CI success), CIPending, CIFailure, NoDiffSummary (with warning), NoCIStatus, Processing (buttons disabled), NoPrWithDiff, NoPrNoDiff, WithPhases, InDrawer (full drawer shell), and WithDeleteButton.
  - **FR-31**: The `feature-node.stories.tsx` MUST include a `MergeReviewActionRequired` story variant showing the emerald badge with GitMerge icon.
  - **FR-32**: The `control-center.stories.tsx` MUST include a merge review feature node (lifecycle: 'review', state: 'action-required') in its multi-feature story variants.

  ## Non-Functional Requirements

  - **NFR-1 — Pattern consistency**: The merge review drawer MUST follow the identical 5-file pattern used by `prd-questionnaire/` and `tech-decisions-review/`: config, content component, drawer wrapper, stories, barrel export.
  - **NFR-2 — No domain model changes**: The implementation MUST NOT modify TypeSpec models, generated types, or require database migrations. All data MUST come from existing `Feature.pr` field and existing service interfaces.
  - **NFR-3 — No backend changes**: The implementation MUST NOT modify agent nodes, worker code, or LangGraph interrupt/resume logic. Data access is limited to existing repositories and services via server actions.
  - **NFR-4 — Type safety**: All component data MUST be defined via TypeScript interfaces in `merge-review-config.ts`. The server action return type MUST use a discriminated union (`MergeReviewData | { error: string }`).
  - **NFR-5 — Graceful degradation**: Every data section (PR, diff, CI, phases, branch) MUST degrade independently — a failure in one MUST NOT prevent others from rendering or block the approve action.
  - **NFR-6 — Accessibility**: External PR links MUST use `target="_blank"` with `rel="noopener noreferrer"`. Interactive elements MUST be keyboard accessible (provided by shadcn/ui primitives).
  - **NFR-7 — Performance**: The server action MUST load plan phases best-effort (no blocking on failure). Diff summary loading MUST be skipped entirely when `worktreePath` is undefined (no unnecessary git operations).
  - **NFR-8 — Loading UX**: The drawer MUST show a loading spinner (Loader2) while data is being fetched. Approve/reject buttons MUST be disabled during processing/rejecting states to prevent double-submission.
  - **NFR-9 — Clean architecture compliance**: The server action MUST resolve dependencies via the DI container (`resolve<T>('Token')` pattern). No direct service instantiation in the presentation layer.
  - **NFR-10 — Visual consistency**: CI status colors MUST follow the established CiStatusBadge pattern (green/Success, yellow/Pending, red/Failure). Badge colors MUST use Tailwind's emerald palette for merge review state.
  - **NFR-11 — Test coverage**: Unit tests MUST cover: server action input validation, feature not found, data mapping from domain types, diff summary failure fallback, plan phase loading failure fallback, no-PR scenario, no-worktree scenario. Component tests MUST cover: rendering all data sections, conditional section omission, button click handlers, processing/rejecting disabled states.

  ## Product Questions & AI Recommendations

  | # | Question | AI Recommendation | Rationale |
  | - | -------- | ----------------- | --------- |
  | 1 | Data access architecture for merge drawer content | Read Feature.pr + regenerate diff summary | Avoids domain model changes, uses already-persisted data, follows established server action patterns, keeps diff fresh |
  | 2 | Badge color scheme and icon for merge review | Green (emerald) with GitMerge icon | Matches GitHub merge button convention, forms clear progression (amber → indigo → emerald), semantically meaningful |
  | 3 | Reject action in merge drawer | Approve only (with delete as escape hatch) | Matches PRD/Tech drawer pattern; however, implementation includes DrawerActionBar reject flow since it's zero-cost via shared component |
  | 4 | Chat input for refinement | Read-only display with approve action | Merge is binary decision, no backend support for feedback-based revision, PR link provides escape hatch |
  | 5 | Error handling for unavailable diff | Graceful degradation with PR-only fallback | Diff is supplementary, core approve action doesn't depend on it, PR URL always provides direct GitHub link |
  | 6 | Diff summary granularity | Aggregate statistics only | Matches existing IGitPrService.getPrDiffSummary() return shape, no interface changes, GitHub for file-level details |
  | 7 | CI status visualization | Color-coded badge with icon | Follows GitHub visual language, instantly scannable, reuses shared CiStatusBadge component |
  | 8 | DrawerActionBar reject flow | Include reject flow via DrawerActionBar | Zero additional cost via shared component, backend already supports rejection, gives users revision option |

  ## Affected Areas

  | Area | Impact | Reasoning |
  | ---- | ------ | --------- |
  | `components/common/feature-node/feature-node.tsx` (246 lines) | Medium | Requires `review` lifecycle case in `getBadgeText()`, `getBadgeIcon()`, and `getActionRequiredBadgeClasses()` — emerald color with GitMerge icon |
  | `components/common/merge-review/` (5 files) | High | Full new component directory: `merge-review-config.ts` (interfaces), `merge-review.tsx` (content with PR metadata, diff summary, CI status, phases, branch direction, DrawerActionBar), `merge-review-drawer.tsx` (shell wrapper), `merge-review.stories.tsx` (11 story variants), `index.ts` (barrel) |
  | `components/features/control-center/control-center-inner.tsx` (463 lines) | Medium | Requires `showMergeReviewDrawer` flag, merge data state, `useEffect` fetch with cancellation, approve/reject handlers, conditional `MergeReviewDrawer` rendering, FeatureDrawer suppression |
  | `app/actions/get-merge-review-data.ts` (64 lines) | Medium | New server action: validates featureId, resolves Feature via DI, extracts PR metadata, loads plan phases (best-effort), calls `gitPrService.getPrDiffSummary()` with graceful fallback |
  | `app/page.tsx` (167 lines) | Low | Requires `merge: 'review'` entry in `nodeToLifecyclePhase` map |
  | `components/common/feature-node/feature-node.stories.tsx` (436 lines) | Low | Requires `MergeReviewActionRequired` story variant |
  | `components/features/control-center/control-center.stories.tsx` (317 lines) | Low | Requires merge review node in multi-feature story variants |
  | `components/common/ci-status-badge/` | Low | Shared CiStatusBadge component reused by merge-review.tsx — already exists with stories |
  | `components/common/drawer-action-bar/` | Low | Shared DrawerActionBar component reused by merge-review.tsx — already exists with approve/reject pattern |
  | `components/common/feature-node/feature-node-state-config.ts` (151 lines) | None | `review` lifecycle phase already defined — no changes needed |
  | `components/common/feature-node/derive-feature-state.ts` | None | State derivation already handles review correctly — no changes needed |

  ## Dependencies

  **Existing components reused (no modifications needed):**
  - `ReviewDrawerShell` (143 lines) — shared drawer shell with header, delete action, feature actions menu
  - `CiStatusBadge` — color-coded CI status badge with icon (Success/Pending/Failure)
  - `DrawerActionBar` — shared approve/reject action bar with reject dialog, inline revision input
  - `DrawerRevisionInput` — inline text input with send button for revision feedback
  - `RejectFeedbackDialog` — AlertDialog with textarea for rejection feedback
  - `useFeatureActions` hook (139 lines) — IDE/shell/folder actions, used by ReviewDrawerShell
  - `approveFeature()` server action (38 lines) — works for all approval gates including merge
  - `rejectFeature()` server action — sends rejection feedback to agent for all approval gates
  - `resolve()` from `lib/server-container.ts` (36 lines) — DI resolution for server actions

  **Domain types from `packages/core/src/domain/generated/output.ts`:**
  - `PullRequest` — `{ url, number, status: PrStatus, commitHash?, ciStatus?: CiStatus }`
  - `PrStatus` enum — `Open | Merged | Closed`
  - `CiStatus` enum — `Pending | Success | Failure`
  - `SdlcLifecycle` enum — includes `Review` value
  - `ApprovalGates` — `{ allowPrd, allowPlan, allowMerge }`

  **Service interfaces (read-only, no modifications):**
  - `IFeatureRepository.findById(id)` — fetch Feature with populated `pr` field
  - `IGitPrService.getPrDiffSummary(cwd, baseBranch)` — returns `DiffSummary { filesChanged, additions, deletions, commitCount }`
  - `GetPlanArtifactUseCase.execute(featureId)` — returns plan with phases array

  **Backend infrastructure (no changes needed):**
  - `merge.node.ts` — sets `Feature.pr` before interrupt, passes `diffSummary` in interrupt payload
  - `feature-agent-worker.ts` — sets `AgentRunStatus.waitingApproval` on interrupt
  - `ApproveAgentRunUseCase` — resumes the LangGraph agent from interrupt

  ## Size Estimate

  **M (2-3 days)** — Well-scoped feature following established patterns:

  - **New files (6):** merge-review-config.ts, merge-review.tsx, merge-review-drawer.tsx, merge-review.stories.tsx, index.ts, get-merge-review-data.ts
  - **Modified files (3):** feature-node.tsx (3 function additions), control-center-inner.tsx (drawer integration), page.tsx (1 map entry)
  - **Test files (2):** get-merge-review-data.test.ts (server action tests), merge-review.test.tsx (component tests)
  - **Story additions (2):** Feature node MergeReviewActionRequired variant, control center merge node in stories
  - **No domain model changes**, no TypeSpec modifications, no migrations, no backend changes
  - **Risk is low** because every pattern is proven in PRD and Tech Decision drawers
  - The implementation reuses shared components (ReviewDrawerShell, CiStatusBadge, DrawerActionBar) effectively
