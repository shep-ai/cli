name: merge-review-drawer
summary: >
  Implementation follows the established ReviewDrawerShell composition pattern — the same
  5-file directory convention used by prd-questionnaire and tech-decisions-review. A new
  server action reads Feature.pr for PR metadata, loads plan phases via GetPlanArtifactUseCase
  (best-effort), constructs branch direction from Feature.branch, and regenerates diff summary
  via IGitPrService.getPrDiffSummary() with graceful degradation. Feature node badge functions
  gain review-lifecycle cases for emerald/GitMerge visualization. The control center integrates
  merge review data fetching and drawer rendering using the identical inline pattern (state,
  useEffect with cancellation, callbacks) established by the PRD and Tech Decision drawers.
  No domain model changes, no backend modifications, no new npm dependencies.

relatedFeatures: []

technologies:
  - React 19 (Next.js 16+ App Router)
  - shadcn/ui (Radix + Tailwind CSS v4)
  - React Flow (@xyflow/react)
  - Storybook 8
  - Vaul (drawer primitive via ReviewDrawerShell)
  - Lucide React (GitMerge, GitBranch, ArrowRight, ExternalLink, FileDiff, GitCommitHorizontal, Layers, AlertTriangle, CheckCircle2, XCircle, Loader2)
  - sonner (toast notifications)
  - tsyringe (DI container for server actions via resolve())

relatedLinks: []

phases:
  - id: phase-1
    name: 'Foundation — Types, Server Action & Unit Tests'
    description: >
      Define the MergeReviewData type system in merge-review-config.ts (7 interfaces:
      MergeReviewDiffSummary, MergeReviewPr, MergeReviewPhase, MergeReviewBranch,
      MergeReviewData, MergeReviewProps, MergeReviewDrawerProps). Create the
      getMergeReviewData server action with three-level DI resolution and graceful
      degradation. Write comprehensive unit tests covering all data paths (validation,
      success, diff fallback, plan fallback, branch construction, error paths). This
      phase establishes the data contract between server and client before any UI work.
    parallel: false

  - id: phase-2
    name: 'Feature Node Badge — Emerald/GitMerge Visualization'
    description: >
      Add review-lifecycle cases to the three badge functions in feature-node.tsx:
      getBadgeIcon (GitMerge), getActionRequiredBadgeClasses (emerald-700/emerald-50),
      getBadgeText ("Review Merge Request"). Update feature-node tests to cover the new
      review lifecycle cases. This phase is independent of the drawer but provides the
      visual entry point that signals merge review state on the canvas.
    parallel: false

  - id: phase-3
    name: 'Merge Review Component — Content, Drawer Shell & Stories'
    description: >
      Build the complete merge-review component suite following the 5-file pattern:
      merge-review.tsx content component (PR card with external link, branch direction
      pill with GitBranch/ArrowRight icons, diff summary 4-column grid, CI status via
      CiStatusBadge, PhaseList sub-component, DrawerActionBar with approve/reject),
      merge-review-drawer.tsx thin wrapper using ReviewDrawerShell with Loader2 spinner,
      barrel exports, comprehensive Storybook stories covering all variants (default,
      CI states, no diff, no PR, processing, with phases, drawer variants), and unit
      tests validating rendering logic for each conditional section.
    parallel: false

  - id: phase-4
    name: 'Control Center Integration & Page Verification'
    description: >
      Wire the merge review drawer into control-center-inner.tsx following the established
      inline pattern: state declarations (mergeReviewData, isLoadingMergeReview), visibility
      boolean (showMergeReviewDrawer), useEffect with cancellation for data fetching via
      getMergeReviewData, approve callback via handleSimpleApprove('Merge'), reject callback
      via handleReject with 'Merge' label, conditional MergeReviewDrawer rendering, and
      FeatureDrawer suppression extension. Verify page.tsx has merge → review in
      nodeToLifecyclePhase. Add feature-node and control-center story variants.
    parallel: false

filesToCreate:
  - src/presentation/web/components/common/merge-review/merge-review-config.ts
  - src/presentation/web/components/common/merge-review/merge-review.tsx
  - src/presentation/web/components/common/merge-review/merge-review-drawer.tsx
  - src/presentation/web/components/common/merge-review/merge-review.stories.tsx
  - src/presentation/web/components/common/merge-review/index.ts
  - src/presentation/web/app/actions/get-merge-review-data.ts
  - tests/unit/presentation/web/actions/merge-review/get-merge-review-data.test.ts
  - tests/unit/presentation/web/components/common/merge-review/merge-review.test.tsx
  - tests/unit/presentation/web/components/common/merge-review/merge-review-drawer.test.tsx

filesToModify:
  - src/presentation/web/components/common/feature-node/feature-node.tsx
  - src/presentation/web/components/features/control-center/control-center-inner.tsx
  - src/presentation/web/app/page.tsx
  - tests/unit/presentation/web/common/feature-node/feature-node.test.tsx
  - src/presentation/web/components/common/feature-node/feature-node.stories.tsx
  - src/presentation/web/components/features/control-center/control-center.stories.tsx

openQuestions: []

content: |
  ## Architecture Overview

  The merge review drawer extends the existing presentation layer architecture at three
  integration points, exactly mirroring the PRD questionnaire and tech decisions review
  drawers:

  1. **Feature Node (canvas visualization)** — Three functions in `feature-node.tsx` dispatch
     on `data.lifecycle` to customize badge icon, color, and text. Adding a `review` case to
     each mirrors the existing `requirements` and `implementation` cases. The `page.tsx`
     `nodeToLifecyclePhase` map has `merge: 'review'` so the agent graph node name resolves
     to the correct UI lifecycle phase.

  2. **Component Suite (common/merge-review/)** — Follows the 5-file pattern established by
     `prd-questionnaire/` and `tech-decisions-review/`. The merge review content component is
     simpler than both: read-only PR display with branch direction, diff summary grid, CI badge,
     implementation phases list, and DrawerActionBar with approve/reject actions. No multi-step
     questionnaire, no collapsible alternatives.

  3. **Control Center (orchestration)** — `control-center-inner.tsx` manages all drawer state
     inline with a repeating pattern: state declarations → visibility boolean → useEffect with
     cancellation → approval/reject callbacks → conditional rendering. The merge drawer adds
     one more instance of this pattern plus extending the FeatureDrawer suppression condition.

  **Data Flow:**
  ```
  page.tsx (server) — nodeToLifecyclePhase: merge → 'review'
    → FeatureNodeData.lifecycle = 'review' when agent is at merge node
    → FeatureNode renders emerald GitMerge badge

  control-center-inner.tsx (client)
    → showMergeReviewDrawer = lifecycle === 'review' && state === 'action-required'
    → useEffect calls getMergeReviewData(featureId) server action
    → Server action:
      1. Resolves Feature via IFeatureRepository.findById
      2. Extracts Feature.pr fields (url, number, status, commitHash, ciStatus)
      3. Constructs branch = { source: feature.branch, target: 'main' }
      4. Loads plan phases via GetPlanArtifactUseCase.execute (best-effort)
      5. Calls IGitPrService.getPrDiffSummary(worktreePath, 'main') (graceful fallback)
    → Returns MergeReviewData { pr, branch, phases, diffSummary, warning }
    → MergeReviewDrawer renders ReviewDrawerShell + MergeReview content
    → Approve button calls approveFeature(featureId) → agent resumes from interrupt
  ```

  **Type Architecture:**
  ```
  Domain types (generated, read-only):
    Feature.pr: PullRequest { url, number, status: PrStatus, commitHash?, ciStatus?: CiStatus }
    PrStatus enum: Open | Merged | Closed
    CiStatus enum: Pending | Success | Failure

  Service interfaces (read-only, no modifications):
    IFeatureRepository.findById(id) → Feature | null
    IGitPrService.getPrDiffSummary(cwd, baseBranch) → DiffSummary
    GetPlanArtifactUseCase.execute(featureId) → TechnicalPlanArtifact

  UI types (merge-review-config.ts):
    MergeReviewPr { url, number, status, commitHash?, ciStatus? }
    MergeReviewDiffSummary { filesChanged, additions, deletions, commitCount }
    MergeReviewPhase { id, name, description? }
    MergeReviewBranch { source, target }
    MergeReviewData { pr?, diffSummary?, phases?, branch?, warning? }
    MergeReviewProps { data, onApprove, onReject?, isProcessing?, isRejecting? }
    MergeReviewDrawerProps extends Omit<MergeReviewProps, 'data'> + shell props
  ```

  ## Key Design Decisions

  ### 1. Read Feature.pr + Regenerate Diff (Not Checkpoint or Persisted)

  Feature.pr is populated in merge.node.ts (lines 226-238) before the interrupt and persisted
  to SQLite. The diff summary is regenerated on demand via IGitPrService.getPrDiffSummary().
  This avoids domain model changes (NFR-8) and follows the existing server action pattern.
  If the worktree is unavailable, the diff is omitted gracefully — PR metadata always works.

  ### 2. Three-Level Error Handling in Server Action

  The action uses nested try/catch: outer for fatal errors (feature not found, DI failure),
  inner for plan phases (best-effort, silent on failure), inner for diff summary (returns
  warning string on failure). Each data source fails independently — plan phase failure
  doesn't block diff summary, diff failure doesn't block PR metadata.

  ### 3. Read-Only Content with DrawerActionBar

  Unlike PRD (option selection with stepper) and tech decisions (plan review with collapsible
  alternatives), merge review is primarily a binary approval decision. The DrawerActionBar
  provides approve button plus optional reject-with-feedback dialog for consistency with the
  shared approval pattern. This pragmatically supports the LangGraph interrupt flow which
  does accept feedback-based revision.

  ### 4. Emerald Badge with GitMerge Icon

  Creates a three-color progression for review states: amber/FileText (requirements) →
  indigo/Wrench (implementation) → emerald/GitMerge (merge). Emerald semantically means
  "ready to proceed", matching GitHub's green merge button. The badge override only affects
  the badge pill classes when state is action-required.

  ### 5. Branch Direction and Phases Display

  The content component shows branch merge direction (source → target) using GitBranch and
  ArrowRight icons with Badge components, and implementation phases from GetPlanArtifactUseCase
  as a numbered list. Both provide essential context for the merge approval decision without
  significant implementation cost — data is already available from Feature.branch and the
  plan artifact.

  ### 6. Hardcoded 'main' as Base Branch

  The server action hardcodes 'main' for getPrDiffSummary rather than dynamically detecting
  via getDefaultBranch(). If wrong, the diff call fails gracefully and PR metadata is still
  shown with a warning. Known inconsistency with merge.node.ts (which uses dynamic detection)
  documented for future improvement.

  ### 7. Inline Control Center Pattern (Not Custom Hook)

  The PRD and tech decision drawers both manage state inline in control-center-inner.tsx.
  Extracting merge drawer logic into a custom hook would break this established pattern.
  The merge drawer adds: state (2 lines), boolean (2 lines), useEffect (28 lines), approve
  callback (1 line), reject callback (3 lines), rendering (17 lines) — all following the
  exact existing pattern.

  ## Implementation Strategy

  Phase ordering follows a bottom-up dependency chain:

  **Phase 1 (Foundation)** establishes the data contract (types + server action) first because
  the type definitions drive both the component props and the server action return type. The
  server action can be fully TDD'd in isolation with mock DI resolution.

  **Phase 2 (Feature Node)** is independent of the drawer but provides the visual signal on
  the canvas. It establishes the `review` lifecycle handling that the control center's
  `showMergeReviewDrawer` boolean depends on. Small, isolated changes with clear behavior.

  **Phase 3 (Components)** depends on Phase 1 for the data types. Building the component suite
  with Storybook stories provides visual verification before wiring into the control center.
  The content component consumes MergeReviewData, making the type contract critical.

  **Phase 4 (Integration)** depends on all previous phases. It wires everything together in
  the control center using the server action (Phase 1), the drawer component (Phase 3), and
  the lifecycle routing that enables visibility (Phase 2).

  ## Risk Mitigation

  | Risk | Mitigation |
  | ---- | ---------- |
  | Worktree deleted during Review phase, blocking diff summary | Graceful degradation: nested try/catch returns PR metadata without diff. Drawer shows AlertTriangle warning. Approve still works. |
  | Feature.pr is undefined (no PR created) | PR card section conditionally rendered. Drawer shows generic description text. Approve still works via agentRunId. |
  | Plan artifact unavailable | Phases section omitted entirely (best-effort try/catch). No error displayed to user. |
  | Base branch is not 'main' | getPrDiffSummary fails, caught by inner try/catch. Warning displayed instead of diff stats. PR metadata still shown. |
  | CiStatus is undefined on PR | CI badge section conditionally omitted. No visual gap or crash. |
  | Server action returns error | Control center shows toast.error. Drawer not rendered. No crash. |
  | Stale data from cancelled useEffect | Cancellation flag pattern prevents setting state after component unmount. |
  | Emerald colors clash with dark mode | Using Tailwind emerald palette (emerald-50, emerald-700) which has built-in dark mode support. Follows existing amber/indigo pattern. |
  | FeatureDrawer suppression condition grows with drawer count | Condition expressed as OR chain matching existing pattern. Can be extracted to named boolean if readability becomes a concern. |
