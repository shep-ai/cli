name: feature-drawer
summary: >
  Complete the feature-drawer integration with 4 remaining tasks across 3 phases.
  The core FeatureDrawer component (143 lines), Tier 0 drawer primitive (153 lines),
  state management hook, and 25 unit tests are already built. Remaining work is
  barrel export wiring, ControlCenterInner integration (3-line change), Storybook
  stories (all 5 states x lifecycle phases), and integration tests for open/close/switch
  behavior. No new dependencies, no architectural changes, no data model updates.

relatedFeatures: []
technologies:
  - Vaul ^1.1.2 (already installed)
  - shadcn/ui Drawer primitive (Tier 0, already built)
  - React 19 (useState/useCallback)
  - Next.js 16 (App Router, 'use client')
  - Tailwind CSS v4
  - ReactFlow @xyflow/react
  - Vitest + React Testing Library
  - Storybook 8
relatedLinks: []

phases:
  - id: phase-1
    name: 'Barrel Export & Integration Wiring'
    description: >
      Wire the existing FeatureDrawer component into the application. This comes first
      because subsequent phases (stories, integration tests) depend on the component being
      importable from the common barrel and rendered in ControlCenterInner. Two small changes:
      (1) add FeatureDrawer export to common/index.ts, (2) render FeatureDrawer in
      ControlCenterInner as a sibling to FeaturesCanvas. Both are low-risk, minimal-diff changes.
    parallel: false

  - id: phase-2
    name: 'Storybook Documentation'
    description: >
      Create comprehensive Storybook stories for the FeatureDrawer component. This is a
      MANDATORY project requirement (CLAUDE.md). Stories cover all 5 states (running,
      action-required, done, blocked, error) with representative lifecycle phases, plus
      edge cases (minimal data, all fields populated). Uses controlled component pattern
      (explicit selectedNode props, no DrawerTrigger) following the feature-node.stories.tsx
      convention. Must pass pnpm build:storybook.
    parallel: false

  - id: phase-3
    name: 'Integration Testing'
    description: >
      Write integration tests that verify the FeatureDrawer opens/closes/switches correctly
      within the ControlCenterInner composition. Tests render ControlCenterInner with mock
      nodes inside ReactFlowProvider, simulate node clicks and pane clicks, and assert drawer
      content appears/disappears/updates. This phase comes last because it tests the wiring
      done in Phase 1 and validates the complete data flow from node click to drawer render.
    parallel: false

  - id: phase-4
    name: 'FeatureCreateDrawer Storybook Documentation Upgrade'
    description: >
      Upgrade the existing FeatureCreateDrawer stories from 3 basic stories to 9 comprehensive,
      interactive stories with full argTypes, JSDoc, mock file fixtures, play functions for
      pre-filled states, and a form states matrix. This is documentation-only work — no changes
      to the FeatureCreateDrawer component itself. Addresses FR-13 and NFR-9.
    parallel: true

filesToCreate:
  - src/presentation/web/components/common/feature-drawer/feature-drawer.stories.tsx
  - tests/unit/presentation/web/components/features/control-center/control-center-integration.test.tsx

filesToModify:
  - src/presentation/web/components/common/index.ts
  - src/presentation/web/components/features/control-center/control-center-inner.tsx
  - src/presentation/web/components/common/feature-create-drawer/feature-create-drawer.stories.tsx

openQuestions: []

content: |
  ## Architecture Overview

  The feature-drawer follows the project's four-tier component hierarchy:

  ```
  ControlCenterInner (Tier 3: features/)
  ├── FeaturesCanvas (Tier 3: features/)
  │   └── FeatureNode (Tier 1: common/) — compact card on canvas
  └── FeatureDrawer (Tier 1: common/) — detail panel, sibling to canvas
      ├── Drawer (Tier 0: ui/) — Vaul wrapper with direction/modal support
      ├── Separator (Tier 0: ui/) — section dividers
      └── CometSpinner (Tier 0: ui/) — running state animation
  ```

  Data flows through `useControlCenterState`:
  - `handleNodeClick` → `setSelectedNode(data)` → drawer opens
  - `clearSelection` → `setSelectedNode(null)` → drawer closes
  - `createFeatureNode` → `setSelectedNode(newData)` → drawer opens for new feature
  - Clicking a different node → `setSelectedNode(newData)` → drawer switches in-place

  The drawer's open state is derived (`open={selectedNode !== null}`), eliminating
  sync bugs from separate boolean state.

  ## Key Design Decisions

  **1. Non-modal inspector panel (modal={false})**
  Canvas stays interactive behind the drawer. Users can click other nodes to switch
  drawer content without close/reopen animation. Matches Figma/Miro/VS Code inspector
  pattern. Already implemented.

  **2. Derived open state from selectedNode**
  No separate `isDrawerOpen` boolean — open is derived from `selectedNode !== null`.
  Single source of truth eliminates an entire class of sync bugs. Already implemented
  in useControlCenterState.

  **3. Sibling composition in ControlCenterInner**
  FeatureDrawer renders as a sibling to FeaturesCanvas, not nested inside it. Vaul
  uses portal rendering (fixed positioning to document.body), so DOM position doesn't
  affect visual output. This keeps component responsibilities clean.

  **4. Controlled stories without DrawerTrigger**
  FeatureDrawer is externally controlled (open when selectedNode is non-null). Stories
  render with explicit selectedNode data — already open, no trigger button needed.
  Matches how the component works in production.

  **5. Fixed w-96 (384px) drawer width**
  Consistent detail readability regardless of viewport. Tier 0 DrawerContent provides
  responsive w-3/4 base class as natural fallback for narrow viewports.

  ## Implementation Strategy

  Phase ordering follows dependency order:

  1. **Phase 1 (Wiring)** comes first because integration tests and manual verification
     require the component to be importable from the barrel and rendered in the app.
     Two minimal-diff changes with no risk.

  2. **Phase 2 (Stories)** comes second because it's a mandatory project requirement
     and provides visual documentation for manual QA. Stories can be written and verified
     independently of integration tests.

  3. **Phase 3 (Integration Tests)** comes last because it tests the wiring from Phase 1.
     Tests verify the complete data flow: click node → drawer opens with correct data →
     click pane → drawer closes → click different node → drawer switches content.

  ## Risk Mitigation

  | Risk | Mitigation |
  | ---- | ---------- |
  | ReactFlow provider not available in integration tests | Wrap test renders in ReactFlowProvider with dimension mocks, following existing canvas test patterns |
  | Vaul portal rendering breaks test assertions | Query for drawer content via data-testid attributes already present on the component, not DOM position |
  | Storybook build fails with new stories | Run `pnpm build:storybook` as acceptance criterion for Phase 2 |
  | Escape key handler conflicts between Vaul and useControlCenterState | No conflict — non-modal Vaul doesn't register Escape handler. The hook's document-level keydown listener is the sole handler. Already verified in research. |
  | Drawer obscures canvas nodes in right edge | Expected inspector panel behavior. Same as VS Code/Figma. Not a bug. |
