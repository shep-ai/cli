# Building Guide

Guide to building Shep AI CLI for development and distribution.

## Build System

Shep uses the **TypeScript compiler (`tsc`)** with `tsc-alias` for building:

- Standard TypeScript compilation via `tsconfig.build.json`
- Path alias resolution via `tsc-alias`
- Web UI built separately with Next.js and copied to `web/` for distribution

## Build Commands

### Development Build

```bash
# Watch mode with hot reload
pnpm dev
```

This starts the CLI in development mode with hot reload.

### Production Build

```bash
pnpm build
```

Output goes to `dist/` (mirroring `src/` structure with compiled `.js` files).

### Type Checking

```bash
# Check types without emitting
pnpm typecheck

# Watch mode
pnpm typecheck:watch
```

### Full CI Build

```bash
pnpm build:ci
```

Runs: typecheck → lint → test → build

## Build Pipeline

The CLI build command (`pnpm build`) runs:

```bash
tsc -p tsconfig.build.json && tsc-alias -p tsconfig.build.json && pnpm build:web:prod
```

1. **`tsc -p tsconfig.build.json`** - Compiles TypeScript to JavaScript in `dist/`
2. **`tsc-alias -p tsconfig.build.json`** - Resolves `@/` path aliases to relative paths
3. **`pnpm build:web:prod`** - Builds the Next.js web UI and copies output to `web/`

## TypeScript Configuration

```json
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "lib": ["ES2022"],
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "outDir": "dist",
    "rootDir": "src",
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "tests"]
}
```

## Build Outputs

### ESM Bundle

```javascript
// dist/index.js
export { Feature } from './domain/entities/feature.js';
export { CreatePlanUseCase } from './application/use-cases/create-plan.js';
// ...
```

### CommonJS Bundle

```javascript
// dist/index.cjs
const { Feature } = require('./domain/entities/feature.cjs');
// ...
```

### Type Declarations

```typescript
// dist/index.d.ts
export declare class Feature {
  readonly id: string;
  readonly name: string;
  // ...
}
```

## CLI Executable

The CLI entry point includes a shebang:

```javascript
#!/usr/bin/env node
// dist/cli.js
import { program } from './presentation/cli/index.js';
program.parse();
```

Package.json bin configuration:

```json
{
  "bin": {
    "shep": "./dist/cli.js"
  }
}
```

## Dependencies

### Runtime Dependencies

Only essential dependencies for production:

```json
{
  "dependencies": {
    "commander": "^12.0.0",
    "better-sqlite3": "^9.0.0"
  }
}
```

### Build Dependencies

Development-only:

```json
{
  "devDependencies": {
    "typescript": "^5.3.0",
    "tsc-alias": "^1.8.0",
    "@types/node": "^20.0.0",
    "@types/better-sqlite3": "^7.0.0"
  }
}
```

## Native Modules

`better-sqlite3` requires native compilation:

```bash
# Rebuild for current platform
npm rebuild better-sqlite3

# Or during install
npm install --build-from-source
```

For distribution, we use `prebuild`:

```json
{
  "scripts": {
    "install": "prebuild-install || node-gyp rebuild"
  }
}
```

## Build Scripts

### Clean Build

```bash
pnpm clean && pnpm build
```

Clean script:

```json
{
  "scripts": {
    "clean": "rimraf dist coverage"
  }
}
```

### Package for npm

```bash
pnpm build
npm pack
```

Creates `shep-ai-cli-x.x.x.tgz`.

### Publish

```bash
pnpm build
npm publish --access public
```

## Build Optimization

### Source Maps

Source maps are generated by `tsc` when `sourceMap: true` is set in `tsconfig.build.json`.

## Debugging Builds

### Check Output Size

```bash
pnpm build
du -sh dist/*
```

## Continuous Integration

### Build Matrix

```yaml
# .github/workflows/build.yml
jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node: [18, 20]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
      - run: npm ci
      - run: pnpm build
```

### Release Build

```yaml
# .github/workflows/release.yml
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          registry-url: 'https://registry.npmjs.org'
      - run: npm ci
      - run: pnpm build:ci
      - run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

---

## Maintaining This Document

**Update when:**

- Build tooling changes
- TypeScript configuration changes
- New build targets added
- Dependency requirements change

**Related docs:**

- [setup.md](./setup.md) - Development setup
- [CONTRIBUTING.md](../../CONTRIBUTING.md) - Release process
