# Feature Specification (YAML)
# This is the source of truth. Markdown is auto-generated from this file.

name: agent-session-listing
number: 041
branch: feat/041-agent-session-listing
oneLiner: Add 'shep session ls/show' commands to list and inspect agent provider CLI sessions
userQuery: >
  Feature: agent cli sessions

  i want to implement 'shep session ls' which will show list of current default agent provider tool sessions. For example sessions of claude-code, cursror-cli,gemini-cli , like list of conversation capturing most important data (probably without FULL messages conversation, only few first). Each agent implementation must provide its own implementation how to fetch those, and we need some flag with supporting this (we have supported feature in agent executors). lets start with claude code only for now! but provide foundation for all other. also add shep session show SID , also shep session ls --cursor-cli and other flags need to be supported.
  Clean Arch, UseCases and Tsp schemas is a must!
summary: >
  Implements 'shep session ls' and 'shep session show <id>' CLI commands to list and inspect
  conversations from agent provider CLIs (Claude Code, Cursor, Gemini CLI). Each executor
  declares session-listing capability via a new AgentFeature flag and provides its own
  IAgentSessionRepository implementation to read sessions from the agent's local storage.
  Starts with Claude Code implementation only (reading ~/.claude/projects/ JSON files), with
  extensible foundation for other providers via stub implementations that return empty results.
phase: Requirements
sizeEstimate: M

# Relationships
relatedFeatures: []

technologies:
  - TypeScript
  - Commander.js
  - TypeSpec
  - tsyringe (DI)
  - better-sqlite3 (SQLite)
  - Clean Architecture
  - Node.js fs (reading Claude Code's local session files)

relatedLinks: []

# Open questions (must be resolved before implementation)
openQuestions:
  - question: "How should 'shep session ls' behave when no provider flag is given — query the configured default agent only, or query all agents that support session-listing?"
    resolved: true
    options:
      - option: 'Default agent only'
        description: 'Query only the agent type configured in settings (getSettings().agent.type). Consistent with the settings-driven pattern already enforced in the codebase. Users who want another provider use an explicit flag. Simple and predictable.'
        selected: true
      - option: 'All capable agents'
        description: 'Iterate every AgentType that supportsFeature(sessionListing) and merge results. More data upfront, but requires multiple I/O paths, could be slow, and may confuse users who only use one provider.'
        selected: false
    selectionRationale: 'The codebase mandates the settings-driven agent resolution pattern — executor resolution always flows through IAgentExecutorProvider.getExecutor() which reads getSettings().agent.type. Defaulting to the configured agent keeps the command consistent with this invariant and avoids unexpected multi-provider I/O on every invocation. Users needing another provider use --claude-code / --cursor-cli / --gemini-cli.'
    answer: 'Default agent only'

  - question: "How many preview messages should 'shep session ls' include per session in the list view?"
    resolved: true
    options:
      - option: 'First user message only (1)'
        description: 'Show only the first user turn as the session summary. Minimal I/O, clear, analogous to an email subject line. Fast even with hundreds of sessions.'
        selected: true
      - option: 'First 3 messages (3)'
        description: 'Show first user + first assistant + second user turn. More context but more memory per session object and noisier table rows.'
        selected: false
      - option: 'Configurable via --preview-count flag'
        description: 'Let user pass --preview-count N. Adds surface area and complexity for marginal gain; can be added later if needed.'
        selected: false
    selectionRationale: 'The first user message is the best natural summary of what a session is about — analogous to a chat thread title. It is the cheapest to extract, avoids allocating large message arrays in memory for the list view, and mirrors what most chat UIs show in their session list. The detail view (shep session show) serves the need for more content.'
    answer: 'First user message only (1)'

  - question: 'What should stub implementations for Cursor and Gemini do when invoked?'
    resolved: true
    options:
      - option: 'Return empty list with informative warning'
        description: 'list() returns [] and the CLI prints "Session listing not yet implemented for <provider>" as a warning. Non-fatal, composable with future implementation. ls still exits 0.'
        selected: true
      - option: 'Throw NotSupportedError (fatal)'
        description: 'Throw an error that propagates to exit code 1. Consistent with hard capability gating, but bad UX when user accidentally passes --cursor-cli. Requires users to already know which providers are supported.'
        selected: false
      - option: 'Suppress entirely — do not register stubs'
        description: 'Only register ClaudeCodeSessionRepository in the DI container. Other providers have no binding. Simplest but gives no extensibility structure and would require container changes when adding new providers.'
        selected: false
    selectionRationale: 'An empty list with a printed warning is the most user-friendly and forward-compatible approach. It communicates clearly why no results appear without crashing the command, and the exit-0 behaviour allows pipelines to continue. Adding real implementations later is a drop-in replacement with no CLI or contract changes.'
    answer: 'Return empty list with informative warning'

  - question: "How should the session ID used in 'shep session show <id>' be defined?"
    resolved: true
    options:
      - option: 'Filename without extension (Claude Code native ID)'
        description: 'Use the JSONL/JSON filename as the session ID (e.g., "abc123" from "abc123.jsonl"). Zero transformation, stable, and directly maps to the file Claude Code writes. Shown in ls output as the ID column.'
        selected: true
      - option: 'Shep-generated UUID stored in a local index'
        description: 'Generate a UUID for each session and persist a mapping in the Shep SQLite DB. Provides a stable cross-provider ID namespace but adds write-on-read complexity and a sync problem when provider files are deleted.'
        selected: false
    selectionRationale: 'Using the provider-native filename as the session ID keeps the implementation stateless (no write-on-read), avoids index staleness problems, and is immediately human-readable. All providers have a natural file-based or API-based ID that can serve this role. A cross-provider stable ID can be layered on top later if needed.'
    answer: 'Filename without extension (Claude Code native ID)'

  - question: "Should 'shep session ls' support a --limit / -n flag to cap the number of results?"
    resolved: true
    options:
      - option: 'Yes, default 20, configurable'
        description: 'Return the N most-recent sessions sorted by mtime descending. Default 20 keeps output scannable. Users pass --limit 0 for all. Prevents accidental wall of text when hundreds of sessions exist.'
        selected: true
      - option: 'No limit, return all sessions'
        description: 'Return every session. Simple but could produce hundreds of rows — bad UX for power users with large Claude Code session directories.'
        selected: false
    selectionRationale: 'Power users accumulate dozens to hundreds of sessions. A default of 20 matches common CLI list conventions (git log, docker ps) and keeps the output immediately scannable. --limit is simple to implement on top of the sorted list and aligns with the existing ListAgentRunsUseCase limit pattern.'
    answer: 'Yes, default 20, configurable'

  - question: "Should 'shep session show' display the full message history or a truncated view?"
    resolved: true
    options:
      - option: 'All messages, paged through less-style output'
        description: 'Print all messages. Terminal paging (piping to $PAGER or using a built-in pager) handles long output. Most complete and requires no arbitrary truncation decision.'
        selected: false
      - option: 'Configurable with --messages flag, default last 20'
        description: 'Show the last N messages (default 20) with a note showing total message count. Users pass --messages 0 for all. Balances detail and usability out-of-the-box.'
        selected: true
      - option: 'First and last 5 messages only'
        description: 'Show conversation start and end with a divider. Compact but potentially omits important middle context.'
        selected: false
    selectionRationale: 'A default of the last 20 messages mirrors the most useful slice of a conversation — users typically care about what happened recently. Showing the total count gives context, and --messages 0 or a high value provides the escape hatch for full history. This is consistent with --limit on ls and avoids the complexity of shell pager integration.'
    answer: 'Configurable with --messages flag, default last 20'

# Markdown content (the actual spec)
content: |
  ## Problem Statement

  Developers using Shep work with multiple AI agent providers (Claude Code, Cursor, Gemini CLI).
  Each provider maintains its own session/conversation history on disk, but there is no unified
  way to browse, search, or inspect those sessions from the Shep CLI. Users must navigate
  provider-specific storage locations manually.

  This feature adds `shep session ls` and `shep session show <id>` commands to surface agent
  provider sessions in a consistent, clean-architecture-compliant way — starting with Claude
  Code and providing an extensible foundation for all other providers.

  ## Success Criteria

  - [ ] `shep session ls` lists the N most-recent Claude Code sessions (default 20) showing session ID, project path, message count, and first user message preview
  - [ ] `shep session ls --limit <n>` overrides the default result count; `--limit 0` returns all sessions
  - [ ] `shep session ls --claude-code` explicitly targets Claude Code even when another provider is the default
  - [ ] `shep session ls --cursor-cli` prints an empty list with a warning message (not an error) and exits 0
  - [ ] `shep session ls --gemini-cli` prints an empty list with a warning message (not an error) and exits 0
  - [ ] `shep session show <id>` displays full session metadata and the last 20 messages by default
  - [ ] `shep session show <id> --messages <n>` overrides the default message count; `--messages 0` shows all
  - [ ] `shep session show <id>` exits with a non-zero code and clear error when the session ID is not found
  - [ ] Running `shep session ls` with no flags queries the agent type from `getSettings().agent.type`
  - [ ] All new domain types (`AgentSession`, `AgentSessionMessage`) are defined in TypeSpec and compiled to generated output — no hand-edited generated types
  - [ ] `AgentFeature.sessionListing` enum value exists in TypeSpec and `ClaudeCodeExecutorService.supportsFeature('session-listing')` returns `true`
  - [ ] `IAgentSessionRepository` port interface exists in `application/ports/output/agents/` with `list(options)` and `findById(id)` methods
  - [ ] `ListAgentSessionsUseCase` and `GetAgentSessionUseCase` exist as single-class, single-`execute()` use cases registered in the DI container
  - [ ] `ClaudeCodeSessionRepository` reads session files from `~/.claude/projects/` and correctly parses the JSON/JSONL format
  - [ ] Stub implementations exist for Cursor and Gemini session repositories and are registered in the DI container
  - [ ] All new code has corresponding unit tests; `ClaudeCodeSessionRepository` has integration tests with fixture files
  - [ ] `pnpm validate` (lint + typecheck + tsp:compile) passes with no errors
  - [ ] `pnpm test` passes with no regressions

  ## Functional Requirements

  - **FR-1**: The CLI MUST expose a `shep session` command group with two subcommands: `ls` and `show <id>`.
  - **FR-2**: `shep session ls` MUST, by default, query the agent provider configured in `getSettings().agent.type` and return sessions sorted by last-modified time descending.
  - **FR-3**: `shep session ls` MUST accept mutually exclusive provider flags (`--claude-code`, `--cursor-cli`, `--gemini-cli`) that override the default provider selection for that invocation.
  - **FR-4**: `shep session ls` MUST accept a `--limit <n>` / `-n <n>` option (default: 20) that caps the number of sessions returned. `--limit 0` MUST return all sessions.
  - **FR-5**: Each row in `shep session ls` output MUST display: session ID, project path (or context label), total message count, creation/last-modified timestamp, and a truncated first user message as a preview.
  - **FR-6**: When `shep session ls` is invoked with a provider that returns a stub (not yet implemented), it MUST print a user-readable warning such as `"Session listing is not yet implemented for cursor-cli"` to stderr and return an empty list with exit code 0.
  - **FR-7**: `shep session show <id>` MUST display full session metadata (session ID, project path, provider, message count, timestamps) followed by the conversation messages.
  - **FR-8**: `shep session show <id>` MUST accept a `--messages <n>` option (default: 20) controlling how many messages to display (from the end of the conversation). `--messages 0` MUST display all messages.
  - **FR-9**: `shep session show <id>` MUST display a note showing the total message count when the displayed count is less than the total (e.g., `"Showing last 20 of 143 messages"`).
  - **FR-10**: `shep session show <id>` MUST exit with a non-zero exit code and print a descriptive error message when the session ID is not found.
  - **FR-11**: Each agent executor MUST declare support for session listing by implementing `supportsFeature('session-listing')` returning `true` or `false`. Only `ClaudeCodeExecutorService` returns `true` in this iteration.
  - **FR-12**: `IAgentSessionRepository` MUST be the sole interface through which use cases access session data. No use case or CLI command may directly invoke provider-specific storage logic.
  - **FR-13**: Session IDs in all commands MUST use the provider's native file identifier (for Claude Code: filename without extension) to remain stateless with no write-on-read index.
  - **FR-14**: `ClaudeCodeSessionRepository` MUST read session files from `~/.claude/projects/<encoded-path>/` directories, parse the JSON/JSONL content, extract session ID, message count, timestamps, project path from directory name, and the first user-role message as preview text.
  - **FR-15**: New domain types `AgentSession` and `AgentSessionMessage` MUST be defined in TypeSpec (`.tsp` files) and MUST be compiled to `packages/core/src/domain/generated/output.ts` via `pnpm tsp:compile`. Hand-editing generated files is forbidden.
  - **FR-16**: `ListAgentSessionsUseCase` and `GetAgentSessionUseCase` MUST be registered in the tsyringe DI container. The `session ls` and `session show` commands MUST resolve them via `container.resolve()`.
  - **FR-17**: Stub session repository implementations MUST exist for `cursor-cli` and `gemini-cli` and MUST be registered in the DI container so the provider-selection and warning path is exercisable without real provider data.

  ## Non-Functional Requirements

  - **NFR-1 (Performance)**: `shep session ls` with default limit of 20 MUST complete in under 2 seconds even when the `~/.claude/projects/` directory contains 500+ session files. Only the N most-recent files (by mtime) need to be fully parsed.
  - **NFR-2 (Correctness)**: `ClaudeCodeSessionRepository` MUST handle malformed or unreadable session files gracefully — skipping invalid files with a debug-level warning rather than crashing the command.
  - **NFR-3 (Security)**: Session files are read from the user's home directory. The implementation MUST NOT follow symbolic links outside `~/.claude/` and MUST use `fs/promises` with no shell interpolation to avoid path injection.
  - **NFR-4 (Clean Architecture)**: No presentation or infrastructure code may import from a layer it does not own. The dependency rule (domain ← application ← infrastructure ← presentation) MUST be preserved. `IAgentSessionRepository` is defined in application/ports, not infrastructure.
  - **NFR-5 (Extensibility)**: Adding a new provider's session repository in the future MUST require only: (a) implementing `IAgentSessionRepository`, (b) registering it in the DI container, and (c) updating `supportsFeature` on the executor. No changes to use cases or CLI commands should be necessary.
  - **NFR-6 (UX — Output Consistency)**: The `session ls` table and `session show` detail view MUST use the existing CLI UI utilities (`src/presentation/cli/ui/`) — colors, symbols, formatters — and match the visual style of `shep agent ls` and `shep agent show`.
  - **NFR-7 (UX — Error Messages)**: All error messages (session not found, provider not supported, directory unreadable) MUST be human-readable, identify the specific failing item, and suggest a corrective action where possible.
  - **NFR-8 (Testability)**: `ClaudeCodeSessionRepository` MUST accept an injectable base path (defaulting to `~/.claude/projects/`) so integration tests can point to a fixture directory without touching the real filesystem.
  - **NFR-9 (TypeSpec Compliance)**: All new enums and entities MUST follow the project's TypeSpec conventions — one model per file, SRP, placed in the correct `tsp/` subdirectory. TypeSpec compilation MUST succeed without warnings.
  - **NFR-10 (DI Compliance)**: All new classes MUST use `@injectable()` / `@inject()` decorators. No class may be instantiated directly outside the DI container or test setup.

  ## Product Questions & AI Recommendations

  | # | Question | AI Recommendation | Rationale |
  | - | -------- | ----------------- | --------- |
  | 1 | Default provider for `shep session ls` (no flag) | Default agent from settings only | Consistent with mandatory settings-driven agent resolution pattern |
  | 2 | Preview message count in list view | First user message only (1) | Best natural session summary; cheapest to extract; detail view serves deeper inspection |
  | 3 | Stub behaviour for unsupported providers | Empty list + warning (exit 0) | Non-fatal, user-friendly, forward-compatible; no code changes needed when providers are implemented |
  | 4 | Session ID scheme | Provider-native filename without extension | Stateless, no write-on-read index, directly usable in `show` command |
  | 5 | Result count cap | `--limit 20` default, `--limit 0` for all | Matches common CLI conventions; avoids wall of text for power users |
  | 6 | Message count in `show` | `--messages 20` default (last N), `--messages 0` for all | Balances detail and usability; consistent with `--limit` pattern on `ls` |

  ## Affected Areas

  | Area | Impact | Reasoning |
  | ---- | ------ | --------- |
  | `tsp/agents/enums/agent-feature.tsp` | Low | Add `sessionListing: "session-listing"` to AgentFeature enum |
  | `tsp/agents/` | Medium | Add new `AgentSession` and `AgentSessionMessage` TypeSpec models |
  | `packages/core/src/domain/generated/output.ts` | Low | Auto-regenerated after tsp:compile; not edited manually |
  | `packages/core/src/application/ports/output/agents/` | Medium | New `IAgentSessionRepository` port interface |
  | `packages/core/src/application/use-cases/agents/` | Medium | New `ListAgentSessionsUseCase` and `GetAgentSessionUseCase` |
  | `packages/core/src/infrastructure/services/agents/common/executors/claude-code-executor.service.ts` | Low | Add `session-listing` to SUPPORTED_FEATURES set |
  | `packages/core/src/infrastructure/services/agents/` | High | New `sessions/` subdirectory with `IAgentSessionRepository` impls per provider |
  | `packages/core/src/infrastructure/di/container.ts` | Low | Register new use cases and session repository implementations |
  | `src/presentation/cli/commands/` | High | New `session/` command directory with `ls.command.ts`, `show.command.ts`, `index.ts` |
  | `src/presentation/cli/index.ts` | Low | Register new `createSessionCommand()` |
  | `tests/unit/` | Medium | Unit tests for new use cases and domain model |
  | `tests/integration/` | Medium | Integration tests for ClaudeCodeSessionRepository with fixture files |

  ## Dependencies

  - **AgentFeature enum** (existing, `tsp/agents/enums/agent-feature.tsp`): Extended with `sessionListing`
  - **AgentType enum** (existing, `tsp/common/enums/agent-config.tsp`): Used to type-check provider flags
  - **IAgentExecutor interface** (existing): `supportsFeature()` used to discover capable providers
  - **IAgentExecutorFactory** (existing): Used to get executor instances for capability checks
  - **AgentRun.sessionId** (existing field on AgentRun): Optional cross-reference from runs to sessions (read-only, not written by this feature)
  - **CLI UI system** (existing, `src/presentation/cli/ui/`): Colors, symbols, renderListView used as-is
  - **tsyringe container** (existing, `infrastructure/di/container.ts`): Registration point for new services
  - **Node.js `fs/promises`**: For reading Claude Code session files from `~/.claude/projects/`

  ## Size Estimate

  **M** (days) — Justified by:

  1. **TypeSpec models** (~2 new models): `AgentSession` + `AgentSessionMessage` — straightforward
  2. **Port interface**: `IAgentSessionRepository` with `list(options)` and `findById(id)` methods
  3. **Use cases** (2): `ListAgentSessionsUseCase`, `GetAgentSessionUseCase` — simple orchestration
  4. **Claude Code implementation**: Read `~/.claude/projects/` directory, parse JSON session files,
     extract preview messages — the main implementation work, requires understanding Claude's storage format.
     Must handle malformed files gracefully and accept injectable base path for testability.
  5. **Stub implementations** for Cursor and Gemini (return empty + warning) — minimal
  6. **CLI commands** (2): `session ls` with provider flags + `--limit`, `session show <id>` with `--messages` — follows existing agent pattern
  7. **DI wiring**: Register in container — trivial
  8. **TDD**: Unit tests for use cases, integration tests for Claude Code file reading with fixture directory
  9. **TypeSpec compilation** + generated type updates

  The main unknowns (Claude Code's exact session file format and path conventions) are
  resolvable during research/implementation. No new infrastructure dependencies needed.
