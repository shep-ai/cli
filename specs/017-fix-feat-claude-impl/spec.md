## Problem Statement

The feature agent's implement phase (phase-level orchestrator in `implement.node.ts`) spawns
Claude Code subprocesses to execute each implementation phase. When the Anthropic API returns
a 400 error with `tool_use.name: String should have at most 200 characters`, the entire agent
run fails with no recovery mechanism.

**Observed failure chain:**

1. Phases 1-3 complete successfully (~45 minutes of work)
2. Phase 4 spawns a new Claude Code subprocess with an 83K character prompt
3. Claude Code makes its first API call, the model responds with tool_use
4. On the subsequent API call, the API rejects the request: `messages.1.content.1.tool_use.name: String should have at most 200 characters`
5. Claude Code exits with code 1
6. The implement node throws, LangGraph does NOT checkpoint, run is marked failed
7. All 49 minutes of work is effectively lost (though git commits from phases 1-3 survive)

**Root cause:** Known Claude Code bug ([#7370](https://github.com/anthropics/claude-code/issues/7370))
where tool names can exceed the API's 200-character limit. Additionally, MCP tool names using the
`mcp__plugin_{plugin}_{server}__{tool}` pattern can exceed limits
([#23149](https://github.com/anthropics/claude-code/issues/23149)).

**Contributing factors in Shep's code:**

- No retry logic for transient/recoverable API errors
- No phase-level error recovery or resumption
- No `--max-turns` limit on Claude Code subprocess
- No MCP tool restriction (`--strict-mcp-config` or `--tools`)
- No prompt size management (83K char prompts with full spec+research+plan context)
- Single executor.execute() failure = entire phase failure = entire run failure

## Success Criteria

- [ ] Implement retry logic (max 3 attempts per phase) with exponential backoff for transient errors
- [ ] Add error classification to distinguish API errors from implementation errors
- [ ] Pass `--max-turns` to Claude Code subprocesses to prevent runaway sessions
- [ ] Restrict available tools via `--tools` or `--strict-mcp-config` to prevent MCP tool name issues
- [ ] Add prompt size management with configurable threshold and context summarization
- [ ] Ensure phase-level progress survives individual phase failures (phases 1-3 should not be re-executed)
- [ ] All existing tests pass, new tests cover retry and error classification logic

## Affected Areas

| Area                            | Impact | Reasoning                                             |
| ------------------------------- | ------ | ----------------------------------------------------- |
| implement.node.ts               | High   | Add retry logic, error classification, phase recovery |
| claude-code-executor.service.ts | Medium | Pass new CLI flags (--max-turns, --tools, etc.)       |
| agent-executor.interface.ts     | Low    | May need new options for tool restriction and retries |
| node-helpers.ts                 | Low    | Add shared error classification utility               |
| implement.prompt.ts             | Low    | Add prompt size management/truncation                 |

## Dependencies

None — all changes are within the existing agent infrastructure.

## Size Estimate

**Medium** - Core changes are in implement.node.ts (retry logic, error handling) and
claude-code-executor.service.ts (CLI flags). No new external dependencies needed.

---

_Generated by `/shep-kit:new-feature` — proceed with `/shep-kit:research`_
