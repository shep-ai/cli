name: feature-approval-flags
summary: >
  Technical research for adding auto-approve checkbox gates to the Web UI feature creation drawer
  and extending the ApprovalGates domain type with allowMerge. Key design change: replace the previous
  RadioGroup (4 mutually exclusive modes) with 3 independent checkboxes (PRD, Plan, Merge). The
  checkbox model better represents the domain — each gate is an independent boolean, not a progressive
  level. The Merge gate is new scope requiring TypeSpec model update, CLI flag, and backend interrupt
  logic changes.

relatedFeatures: []

technologies:
  - shadcn/ui Checkbox (Radix UI primitive wrapper)
  - Next.js App Router API routes
  - React state (useState)
  - TypeSpec (ApprovalGates model extension)
  - Commander.js (--allow-merge flag)
  - Vitest + React Testing Library (unit tests)
  - Storybook (component stories)

relatedLinks: []

decisions:
  - title: 'UI Component for Auto-Approve Gates'
    chosen: 'shadcn/ui Checkbox — 3 independent checkboxes with label + description'
    rejected:
      - 'RadioGroup with 4 mutually exclusive modes — Forces progressive levels (step-by-step < PRD < Plan < All). This incorrectly models the domain: a user may want to auto-approve PRD and Merge but manually approve Plan. Independent checkboxes allow any combination.'
      - "Select dropdown — Hides options behind a click. With only 3 options, discoverability is poor. Also implies mutually exclusive selection which doesn't match the independent boolean model."
      - 'Toggle group / Switch array — Visually heavier than checkboxes for boolean flags. Switches suggest on/off states for active features rather than opt-in approvals.'
    rationale: >
      The 3 approval gates (PRD, Plan, Merge) are independent boolean flags. Checkboxes are the
      standard UI pattern for independent, non-mutually-exclusive boolean options. Each checkbox maps
      directly to one boolean field in ApprovalGates, with no complex mapping logic needed. The shadcn/ui
      Checkbox component is backed by Radix UI, providing built-in keyboard navigation (Space to toggle)
      and ARIA attributes. The project already uses the bundled `radix-ui` package which includes the
      Checkbox primitive.

  - title: 'Checkbox Component Installation Method'
    chosen: 'Install via shadcn CLI: npx shadcn@latest add checkbox'
    rejected:
      - 'Hand-write from scratch — Inconsistent with other ui/ components generated by the CLI.'
      - 'Copy from shadcn GitHub — Import paths differ (project uses bundled `radix-ui`, not `@radix-ui/*`).'
    rationale: >
      Same approach as all other UI components in the project. The shadcn CLI reads components.json
      and generates a wrapper matching existing patterns (import from "radix-ui", cn() utility).
      If the CLI generates `@radix-ui/react-checkbox` imports, they need manual correction to use
      the bundled `radix-ui` package.

  - title: 'Auto-Approve Data Model in Form State'
    chosen: 'Object with 3 boolean fields: { prd: boolean, plan: boolean, merge: boolean }'
    rejected:
      - 'String literal union ("step-by-step" | "allow-prd" | ...) — This was the previous RadioGroup design. With independent checkboxes, a string enum cannot represent arbitrary combinations like "PRD + Merge but not Plan".'
      - 'ApprovalGates object directly in form state — Couples UI to domain type naming (allowPrd vs prd). Simpler short names in the form, mapped to domain names at submission.'
    rationale: >
      With 3 independent checkboxes, the natural form state is an object with 3 boolean fields
      matching each checkbox. The mapping to ApprovalGates { allowPrd, allowPlan, allowMerge } is
      trivial — just a property rename at submission time. This keeps the form state clean and
      directly bindable to checkbox checked states.

  - title: 'Auto-Approve to ApprovalGates Mapping Location'
    chosen: 'Pure mapping function in or near the drawer component, called at form submission time'
    rejected:
      - 'Map in the API route — The API route should receive the final ApprovalGates object, not UI-specific field names.'
      - 'No mapping needed (use domain names in form) — Coupling UI labels to domain property names reduces flexibility.'
    rationale: >
      The mapping is a trivial pure function: { prd, plan, merge } → { allowPrd: prd, allowPlan: plan,
      allowMerge: merge }. Called by the submission handler before the API fetch. The API route receives
      the domain-typed ApprovalGates object.

  - title: 'API Route Validation Strategy for approvalGates'
    chosen: 'Inline validation in the route handler, matching existing validation pattern'
    rejected:
      - 'Zod schema validation — The project does not use Zod for API route validation. Adding it for one route would be inconsistent.'
      - 'No validation — Malformed gates could cause undefined behavior in the agent pipeline.'
    rationale: >
      The existing create route uses inline validation for name and repositoryPath. Adding similar
      inline checks for approvalGates maintains consistency. Validation: if present, must be an
      object with allowPrd (boolean), allowPlan (boolean), and allowMerge (boolean). If absent,
      default to all false. Backward-compatible: existing consumers sending only allowPrd + allowPlan
      (without allowMerge) should still work — allowMerge defaults to false.

  - title: 'Default Auto-Approve State'
    chosen: 'All checkboxes unchecked (allowPrd: false, allowPlan: false, allowMerge: false)'
    rejected:
      - 'Any checkboxes pre-checked — Risky for users unfamiliar with autonomous modes. Could lead to unintended auto-approval.'
    rationale: >
      Matches the CLI default behavior (no flags = pause after every phase). Safest for new users.
      Backward-compatible. The drawer's existing pattern resets all fields on close, so checkboxes
      reset to unchecked on reopen.

  - title: 'New allowMerge Gate — Domain Model Extension'
    chosen: 'Add allowMerge: boolean to ApprovalGates TypeSpec model'
    rejected:
      - 'Keep only allowPrd + allowPlan, no merge gate — The merge-to-done transition is a distinct approval point that users should control independently.'
    rationale: >
      The merge gate controls whether the transition from implementation/review to Done requires
      human approval. This is a natural extension of the existing gates pattern. The TypeSpec model
      change propagates to generated TypeScript types, and the shouldInterrupt() logic needs a new
      check for the merge phase. The CLI gets a corresponding --allow-merge flag, and --allow-all
      now sets all 3 flags to true.

openQuestions:
  - question: 'Is the Checkbox Radix primitive available in the bundled radix-ui@1.4.3 package?'
    resolved: true
    answer: >
      Yes. The bundled `radix-ui` package includes all Radix primitives including Checkbox.
      The import pattern is `import { Checkbox as CheckboxPrimitive } from "radix-ui"`,
      matching the existing pattern used for Label, Select, and other components.

  - question: 'Does the CreateFeatureInput type already support approvalGates?'
    resolved: true
    answer: >
      Yes. CreateFeatureInput already has an optional `approvalGates?: ApprovalGates` field.
      After the TypeSpec model is updated to include allowMerge, the regenerated type will
      automatically include the new field.

  - question: 'How does the --allow-all CLI flag map with the new allowMerge gate?'
    resolved: true
    answer: >
      --allow-all sets all gates to true: { allowPrd: true, allowPlan: true, allowMerge: true }.
      This maintains the semantic of "fully autonomous — no approval pauses anywhere."

  - question: 'Should existing API consumers that send allowPrd + allowPlan (without allowMerge) break?'
    resolved: true
    answer: >
      No. The API route should default allowMerge to false when not provided. This maintains
      backward compatibility — existing consumers get the same behavior they had before, with
      merge still requiring manual approval.

content: |
  ## Technology Decisions

  ### 1. UI Component: Checkboxes (Not RadioGroup)

  **Chosen:** shadcn/ui Checkbox — 3 independent checkboxes with label + description

  **Rejected:**
  - **RadioGroup** — Previous design. Forces mutually exclusive progressive levels. Doesn't model independent gates correctly.
  - **Select dropdown** — Hides options, implies mutual exclusivity.
  - **Toggle/Switch array** — Visually heavier for simple boolean opt-ins.

  **Rationale:** The 3 gates (PRD, Plan, Merge) are independent booleans. Checkboxes are the standard pattern for this. Each maps directly to one field, no complex mapping needed.

  ### 2. Checkbox Component Installation

  **Chosen:** `npx shadcn@latest add checkbox`

  **Rationale:** Same approach as all other UI components. The CLI generates a wrapper matching existing patterns.

  ### 3. Auto-Approve Data Model

  **Chosen:** `{ prd: boolean, plan: boolean, merge: boolean }` in form state

  **Rejected:**
  - **String literal union** — Cannot represent arbitrary checkbox combinations.
  - **Domain type directly** — Couples UI to domain naming.

  **Rationale:** 3 booleans matching 3 checkboxes. Trivial mapping to ApprovalGates at submission.

  ### 4. New allowMerge Gate

  **Chosen:** Extend ApprovalGates TypeSpec model with `allowMerge: boolean`

  **Rationale:** The merge-to-done transition is a distinct approval point. Fits naturally into the existing gates pattern. Requires: TypeSpec update, type regeneration, shouldInterrupt() update, CLI --allow-merge flag.

  ### 5. API Backward Compatibility

  **Chosen:** Default allowMerge to false when not provided in API request

  **Rationale:** Existing consumers sending only allowPrd + allowPlan continue to work. No breaking changes.

  ## Library Analysis

  | Library | Purpose | Decision | Reasoning |
  | ------- | ------- | -------- | --------- |
  | `radix-ui` (Checkbox primitive) | Accessible checkbox | Use (already installed) | Bundled in existing `radix-ui@^1.4.3` dependency |
  | shadcn/ui checkbox wrapper | Styled Checkbox component | Install via CLI | `npx shadcn@latest add checkbox` generates Tailwind-styled wrapper |
  | Zod | Request body validation | Reject | Not used in existing routes; inline validation is consistent |
  | react-hook-form | Form state management | Reject | Existing drawer uses plain useState; 3 booleans don't need form lib |

  ## Security Considerations

  **Input Validation (FR-9):** The API route must validate `approvalGates` if provided:
  - Must be an object (not array, string, number, null)
  - Must contain `allowPrd` as a boolean
  - Must contain `allowPlan` as a boolean
  - Must contain `allowMerge` as a boolean (or default to false if absent for backward compat)
  - Reject malformed payloads with 400 status

  **No New Attack Surface:** Approval gates only control human-in-the-loop interrupt behavior.
  Worst case for malicious values is skipping pauses, which is already an explicit option.

  ## Architecture Notes

  ### Domain Model Change

  ```
  ApprovalGates (TypeSpec: tsp/agents/approval-gates.tsp)
    allowPrd: boolean     # existing
    allowPlan: boolean    # existing
    allowMerge: boolean   # NEW — controls merge-to-done gate
  ```

  ### Backend Pipeline Updates

  ```
  shouldInterrupt() (node-helpers.ts)
    → existing: checks allowPrd for requirements phase
    → existing: checks allowPlan for plan phase
    → NEW: checks allowMerge for merge/done phase
  ```

  ### CLI Flag Updates

  ```
  shep feat new <description>
    --allow-prd          # existing
    --allow-plan         # existing
    --allow-merge        # NEW
    --allow-all          # existing (now sets all 3 to true)
  ```

  ### Presentation Layer Changes

  ```
  FeatureCreateDrawer
    └── 3 Checkboxes (AUTO APPROVE section between Description and Attachments)
    └── autoApprove state: { prd: boolean, plan: boolean, merge: boolean }
    └── CreateFeatureFormData.autoApprove
    └── onSubmit callback receives autoApprove

  Page/Container (submission handler)
    └── map { prd, plan, merge } → { allowPrd, allowPlan, allowMerge }
    └── fetch('/api/features/create', { ..., approvalGates })

  API Route (POST /api/features/create)
    └── Extract approvalGates from body
    └── Validate 3 boolean fields (allowMerge defaults to false for backward compat)
    └── Pass to createFeature({ userInput, repositoryPath, approvalGates })
  ```

  ### Checkbox UI Layout

  ```
  AUTO APPROVE

  ☐ PRD
    Auto-approve requirements move to planning.

  ☐ Plan
    Auto-approve planning move to implementation.

  ☐ Merge
    Auto-approve merge move to Done.
  ```

  ### Files to Create/Modify

  | File | Action | Description |
  | ---- | ------ | ----------- |
  | `tsp/agents/approval-gates.tsp` | Modify | Add allowMerge: boolean |
  | `src/domain/generated/output.ts` | Regenerate | TypeSpec compilation output |
  | `src/presentation/cli/commands/feat/new.command.ts` | Modify | Add --allow-merge flag, update --allow-all |
  | `src/presentation/web/components/ui/checkbox.tsx` | Create | shadcn/ui Checkbox wrapper (install via CLI) |
  | `src/presentation/web/components/ui/checkbox.stories.tsx` | Create | Storybook stories for Checkbox (mandatory) |
  | `src/presentation/web/components/common/feature-create-drawer/feature-create-drawer.tsx` | Modify | Replace RadioGroup with 3 Checkboxes, update form state and interface |
  | `src/presentation/web/components/common/feature-create-drawer/feature-create-drawer.stories.tsx` | Modify | Update stories for checkbox variants |
  | `src/presentation/web/app/api/features/create/route.ts` | Modify | Accept 3-field approvalGates, validate, forward |
  | `src/presentation/web/components/features/control-center/use-control-center-state.ts` | Modify | Map autoApprove booleans to ApprovalGates |
  | Backend interrupt logic (node-helpers.ts or equivalent) | Modify | Handle allowMerge gate in shouldInterrupt() |
  | Tests (multiple files) | Modify/Create | Cover new allowMerge field and checkbox UI |
