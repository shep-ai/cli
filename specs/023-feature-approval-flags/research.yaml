name: feature-approval-flags
summary: >
  Technical research for replacing the RadioGroup approval mode selector with 3 independent
  auto-approve checkboxes (PRD, Plan, Merge) in the FeatureCreateDrawer. The checkbox model
  correctly represents the domain — each gate is an independent boolean. The ApprovalGates
  TypeSpec model is extended with allowMerge. CLI flags and backend interrupt logic are out of scope.

relatedFeatures: []

technologies:
  - shadcn/ui Checkbox (Radix UI primitive wrapper)
  - Next.js App Router API routes
  - React state (useState)
  - TypeSpec (ApprovalGates model extension)
  - Vitest + React Testing Library (unit tests)
  - Storybook (component stories)

relatedLinks: []

decisions:
  - title: 'UI Component for Auto-Approve Gates'
    chosen: 'shadcn/ui Checkbox — 3 independent checkboxes with label + description'
    rejected:
      - 'RadioGroup with 4 mutually exclusive modes — Forces progressive levels (step-by-step < PRD < Plan < All). This incorrectly models the domain: a user may want to auto-approve PRD and Merge but manually approve Plan. Independent checkboxes allow any combination.'
      - "Select dropdown — Hides options behind a click. With only 3 options, discoverability is poor. Also implies mutually exclusive selection which doesn't match the independent boolean model."
      - 'Toggle group / Switch array — Visually heavier than checkboxes for boolean flags. Switches suggest on/off states for active features rather than opt-in approvals.'
    rationale: >
      The 3 approval gates (PRD, Plan, Merge) are independent boolean flags. Checkboxes are the
      standard UI pattern for independent, non-mutually-exclusive boolean options. Each checkbox maps
      directly to one boolean field in ApprovalGates, with no complex mapping logic needed. The shadcn/ui
      Checkbox component is backed by Radix UI, providing built-in keyboard navigation (Space to toggle)
      and ARIA attributes. The project already uses the bundled `radix-ui` package which includes the
      Checkbox primitive.

  - title: 'Checkbox Component Installation Method'
    chosen: 'Install via shadcn CLI: npx shadcn@latest add checkbox'
    rejected:
      - 'Hand-write from scratch — Inconsistent with other ui/ components generated by the CLI.'
      - 'Copy from shadcn GitHub — Import paths differ (project uses bundled `radix-ui`, not `@radix-ui/*`).'
    rationale: >
      Same approach as all other UI components in the project. The shadcn CLI reads components.json
      and generates a wrapper matching existing patterns (import from "radix-ui", cn() utility).
      If the CLI generates `@radix-ui/react-checkbox` imports, they need manual correction to use
      the bundled `radix-ui` package.

  - title: 'Form State Model for Checkboxes'
    chosen: 'Three independent boolean useStates (or single object useState) mapping directly to ApprovalGates fields'
    rejected:
      - 'String literal union ("step-by-step" | "allow-prd" | ...) — Previous RadioGroup design. Cannot represent arbitrary checkbox combinations like "PRD + Merge but not Plan".'
      - 'Intermediate form type with remapping — Over-engineering. Since the drawer already submits CreateFeatureInput directly, the checkbox states map 1:1 to ApprovalGates fields.'
    rationale: >
      The drawer already uses CreateFeatureInput directly (from previous iteration). The checkbox
      states map directly to allowPrd, allowPlan, allowMerge booleans. No intermediate form data
      type or mapping function needed — the old mapApprovalMode() is replaced by direct boolean
      state. This simplifies the code compared to the RadioGroup approach.

  - title: 'API Route Backward Compatibility for allowMerge'
    chosen: 'Default allowMerge to false when not provided in API request'
    rejected:
      - 'Require allowMerge (breaking change) — Existing consumers sending only allowPrd + allowPlan would break.'
    rationale: >
      The existing API route validates allowPrd and allowPlan. Adding allowMerge as optional
      (defaulting to false) maintains backward compatibility. Existing consumers unaffected.
      The isValidApprovalGates() function is updated to accept allowMerge as an optional boolean.

  - title: 'Default Auto-Approve State'
    chosen: 'All checkboxes unchecked (all false)'
    rejected:
      - 'Any checkboxes pre-checked — Risky for unfamiliar users. Does not match CLI default behavior.'
    rationale: >
      Matches current default behavior (no approval gates = pause after every phase). The drawer
      already resets all state on close, so checkboxes reset to unchecked on reopen.

openQuestions:
  - question: 'Is the Checkbox Radix primitive available in the bundled radix-ui@1.4.3 package?'
    resolved: true
    answer: >
      Yes. The bundled `radix-ui` package includes all Radix primitives including Checkbox.
      The import pattern is `import { Checkbox as CheckboxPrimitive } from "radix-ui"`.

  - question: 'Does adding allowMerge to ApprovalGates break existing code?'
    resolved: true
    answer: >
      Adding a new required field to the TypeSpec model means all existing ApprovalGates object
      literals need updating. However, the only places that construct ApprovalGates are: the CLI
      (out of scope, unchanged), the API route (updated), and the drawer (updated). The TypeSpec
      model change propagates through the generated types and TypeScript will flag any missing
      allowMerge fields at compile time.

  - question: 'Should the submission map checkboxes through an intermediate type?'
    resolved: true
    answer: >
      No. The drawer already submits CreateFeatureInput directly. The checkbox states map 1:1 to
      ApprovalGates fields (prd→allowPrd, plan→allowPlan, merge→allowMerge). The old
      mapApprovalMode() function is removed entirely — replaced by direct state construction:
      `approvalGates: { allowPrd: prd, allowPlan: plan, allowMerge: merge }`.

content: |
  ## Technology Decisions

  ### 1. UI Component: Checkboxes (Replacing RadioGroup)

  **Chosen:** shadcn/ui Checkbox — 3 independent checkboxes with label + description

  **Rejected:**
  - **RadioGroup** — Previous design. Forces mutually exclusive progressive levels.
  - **Select dropdown** — Hides options, implies mutual exclusivity.
  - **Toggle/Switch array** — Visually heavier for simple boolean opt-ins.

  **Rationale:** The 3 gates (PRD, Plan, Merge) are independent booleans. Checkboxes are the standard pattern. Each maps directly to one field, no complex mapping needed.

  ### 2. Form State: Direct Boolean Mapping

  **Chosen:** Checkbox states map 1:1 to ApprovalGates fields

  The drawer already submits `CreateFeatureInput` directly. The old `mapApprovalMode()` switch
  is replaced with direct state: `{ allowPrd: prd, allowPlan: plan, allowMerge: merge }`.

  This is simpler than the RadioGroup approach — no intermediate type, no mapping function.

  ### 3. API Backward Compatibility

  **Chosen:** `allowMerge` defaults to `false` when absent from request

  Existing consumers unaffected. The `isValidApprovalGates()` function accepts `allowMerge`
  as optional.

  ## Current Code State (Important Context)

  The previous iteration already implemented:
  - `radio-group.tsx` + `radio-group.stories.tsx` — to be replaced/removed
  - Drawer uses `CreateFeatureInput` directly (not a separate form data type)
  - Drawer has `composeUserInput()` (stays) and `mapApprovalMode()` (removed)
  - `onSubmit` takes `(data: CreateFeatureInput) => void`
  - `repositoryPath` is a drawer prop
  - API route has `isValidApprovalGates()` checking `allowPrd` + `allowPlan`
  - Stories exist for RadioGroup variants (to be updated for checkboxes)

  ## Library Analysis

  | Library | Purpose | Decision | Reasoning |
  | ------- | ------- | -------- | --------- |
  | `radix-ui` (Checkbox primitive) | Accessible checkbox | Use (already installed) | Bundled in existing `radix-ui@^1.4.3` dependency |
  | shadcn/ui checkbox wrapper | Styled Checkbox component | Install via CLI | `npx shadcn@latest add checkbox` |
  | shadcn/ui radio-group wrapper | Previous approval mode UI | Remove | Replaced by checkboxes |

  ## Architecture Notes

  ### Domain Model Change

  ```
  ApprovalGates (TypeSpec: tsp/agents/approval-gates.tsp)
    allowPrd: boolean     # existing
    allowPlan: boolean    # existing
    allowMerge: boolean   # NEW
  ```

  ### Drawer Data Flow (Simplified vs Previous)

  ```
  Previous (RadioGroup):
    approvalMode string → mapApprovalMode() → ApprovalGates | undefined → CreateFeatureInput

  New (Checkboxes):
    3 boolean states → { allowPrd, allowPlan, allowMerge } → CreateFeatureInput
  ```

  No mapping function needed. Direct construction.

  ### Checkbox UI Layout

  ```
  AUTO APPROVE

  ☐ PRD
    Auto-approve requirements move to planning.

  ☐ Plan
    Auto-approve planning move to implementation.

  ☐ Merge
    Auto-approve merge move to Done.
  ```

  ### Files to Create/Modify/Remove

  | File | Action | Description |
  | ---- | ------ | ----------- |
  | `tsp/agents/approval-gates.tsp` | Modify | Add allowMerge: boolean |
  | `src/domain/generated/output.ts` | Regenerate | TypeSpec output |
  | `src/presentation/web/components/ui/checkbox.tsx` | Create | Install via shadcn CLI |
  | `src/presentation/web/components/ui/checkbox.stories.tsx` | Create | Mandatory Storybook stories |
  | `src/presentation/web/components/ui/radio-group.tsx` | Remove | No longer used |
  | `src/presentation/web/components/ui/radio-group.stories.tsx` | Remove | No longer used |
  | `feature-create-drawer.tsx` | Modify | Replace RadioGroup with 3 Checkboxes |
  | `feature-create-drawer.stories.tsx` | Modify | Update for checkbox variants |
  | `route.ts` (API) | Modify | Add allowMerge to validation |
  | Tests | Modify | Update for checkbox UI and allowMerge |

  ### Out of Scope

  - CLI flags (no --allow-merge, existing flags unchanged)
  - Backend interrupt logic (shouldInterrupt() unchanged)
  - These will be addressed in a follow-up feature if needed
