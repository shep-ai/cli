# Feature Specification (YAML)
# This is the source of truth. Markdown is auto-generated from this file.

name: control-center
number: 016
branch: feat/016-control-center
oneLiner: Control center orchestrator + extract @shepai/core workspace package for clean web-to-CLI data access
summary: >
  Two-part feature: (1) Build a Control Center Tier 3 component wrapping FeaturesCanvas
  with interactive capabilities — node selection, contextual add-feature actions via (+)
  buttons, centralized state management via custom hook. (2) Extract domain/, application/,
  and infrastructure/ into a @shepai/core workspace package. Both @shepai/cli and @shepai/web
  depend on @shepai/core directly, eliminating the Turbopack-incompatible @cli/* path alias
  hack and enabling clean type imports. The globalThis bridge remains for runtime use case
  access only (DI container initialized by CLI/dev-server, not Next.js). FeatureNodeData
  extends the generated Feature type — state/progress derived from Feature.plan.tasks.
  Uses existing ListFeaturesUseCase (no new use cases). No CLI folder changes.
phase: Implementation
sizeEstimate: XL

# Relationships
relatedFeatures:
  - '015-feature-flow-canvas'
  - '013-ui-arch'
  - '014-ui-sidebar'

technologies:
  - React 19
  - Next.js 16
  - '@xyflow/react (React Flow)'
  - Tailwind CSS v4
  - shadcn/ui
  - Storybook 8
  - Lucide React
  - pnpm workspaces (@shepai/core)
  - TypeScript (pre-compiled package with tsc)

relatedLinks:
  - https://reactflow.dev/api-reference/components/panel
  - https://reactflow.dev/learn/advanced-use/interaction

# Open questions (must be resolved before implementation)
openQuestions: []

# Markdown content (the actual spec)
content: |
  ## Problem Statement

  The FeaturesCanvas (015) renders feature nodes on a React Flow graph but is
  purely presentational — it has no selection state, no detail views, no toolbar,
  and no way for users to interact beyond basic pan/zoom. The web UI needs an
  interactive Control Center that wraps the canvas and adds the orchestration
  layer: selecting nodes with visual highlight, toolbar actions for managing
  features, and keyboard shortcuts for power users.

  ## Routing

  The Control Center is the **default homepage** of the web UI, rendered at the `/` route.
  There is no separate `/control-center` route — the root `app/page.tsx` is the Control Center
  server component that fetches features and renders the canvas. The sidebar nav item
  "Control Center" links to `href="/"`.

  ## Architecture

  ```
  Tier 3: features/control-center/     ← NEW orchestrator
              ├── composes FeaturesCanvas (canvas layer)
              ├── adds panels/toolbars (UI overlay layer)
              └── manages state + interactions (logic layer)

  Tier 3: features/features-canvas/    ← EXISTING (stays pure/dumb)
  Tier 1: common/feature-node/         ← EXISTING nodes
  ```

  Key principle: Keep FeaturesCanvas as a pure presentation component. Build the
  Control Center as a new Tier 3 component that wraps it and adds interactivity.

  ### Layout

  ```
  ┌─────────────────────────────────────────┐
  │ [Toolbar Panel - top-left]              │
  ├─────────────────────────────────────────┤
  │                                         │
  │   FeaturesCanvas                        │
  │   (React Flow)                          │
  │                                         │
  └─────────────────────────────────────────┘
  ```

  Toolbar uses React Flow's `<Panel>` component for positioning on top of
  the canvas without interfering with pan/zoom.

  ## Components

  ### File Structure

  ```
  features/control-center/
  ├── control-center.tsx              ← Main orchestrator (ReactFlowProvider wrapper)
  ├── control-center-inner.tsx        ← Inner component (uses hook, wires canvas)
  ├── use-control-center-state.ts     ← Custom hook: selection, keyboard, add handlers
  ├── control-center-empty-state.tsx  ← Empty state CTA ("Add Repository")
  ├── control-center-empty-state.stories.tsx
  ├── control-center.stories.tsx
  └── index.ts
  ```

  ### ControlCenter (orchestrator)

  - Renders FeaturesCanvas inside a ReactFlowProvider
  - Uses `useControlCenterState` hook for all state management
  - Passes interaction callbacks (onNodeClick, onPaneClick, onConnect) to canvas
  - Renders Panel overlays for toolbar and status bar

  ### useControlCenterState (custom hook)

  Owns:
  - Node/edge state (React Flow's `useNodesState`/`useEdgesState`)
  - Selected node tracking
  - Action handlers:
    - `handleAddFeatureToRepo(repoNodeId)` — creates a new FeatureNode connected to the repo
    - `handleAddFeatureToFeature(featureNodeId)` — creates a new FeatureNode connected to the parent feature
    - `handleAddFeature()` — toolbar action, creates an unconnected feature node
    - `handleSelectNode(nodeId)` / `handleDeselectNode()`

  ### Empty State CTA

  - "Add Repository" button shown when canvas has no nodes
  - Replaces the originally-planned toolbar (removed for cleaner canvas-first UX)

  ## Interaction Layers

  | Interaction              | Mechanism                                                        |
  | ------------------------ | ---------------------------------------------------------------- |
  | Select node              | `onNodeClick` → highlight node                                   |
  | Deselect                 | `onPaneClick` → clear selection                                  |
  | Add feature from repo    | RepositoryNode (+) button → `handleAddFeatureToRepo(repoNodeId)` |
  | Add feature from feature | FeatureNode (+) button → `handleAddFeatureToFeature(featureNodeId)` |
  | Keyboard shortcuts       | `useKeyboard` hook for Escape (deselect)                         |

  ### Contextual Add Flow

  When a user clicks the (+) button on a **RepositoryNode**:
  1. A new FeatureNode is created with default data (name: "New Feature", state: running, progress: 0)
  2. An edge is created from the repo node to the new feature node
  3. The new node is positioned to the right of the source node
  4. The new node is auto-selected

  When a user clicks the (+) button on a **FeatureNode**:
  1. Same behavior — creates a child FeatureNode connected via edge
  2. Enables building feature hierarchies (repo → feature → sub-feature)

  ## Changes to Existing Components

  | Component        | Change                                                      |
  | ---------------- | ----------------------------------------------------------- |
  | FeaturesCanvas   | Extend props — expose onNodeClick, onPaneClick, onRepositoryAdd |
  | FeatureNode      | Add selected/highlighted visual state (ring or border glow)     |
  | RepositoryNode   | Wire onAdd callback through FeaturesCanvas props                |
  | ControlCenter    | New — wraps everything                                      |
  | EmptyState       | New — CTA for initial repository selection                  |

  ## Success Criteria

  - [x] `ControlCenter` component in `features/control-center/`
  - [x] `useControlCenterState` hook managing all interactive state
  - [x] Empty state CTA for initial repository selection (replaced toolbar)
  - [x] Node selection: click to select, click canvas to deselect
  - [x] Selected node visual highlight (ring/glow on FeatureNode)
  - [x] RepositoryNode (+) creates connected FeatureNode
  - [x] FeatureNode (+) creates connected child FeatureNode
  - [x] New nodes positioned to the right and auto-selected
  - [x] FeaturesCanvas props extended with onNodeClick, onPaneClick, onRepositoryAdd
  - [x] Keyboard shortcut: Escape to deselect
  - [x] Storybook stories: Empty, WithFeatures, WithNodeActions
  - [x] `pnpm build:storybook` passes
  - [x] `pnpm build:web` passes
  - [x] Components follow tier import rules (013-ui-arch)
  - [ ] @shepai/core workspace package created in packages/core/ with pre-compiled JS output
  - [ ] domain/, application/, infrastructure/ moved to packages/core/src/
  - [ ] @shepai/cli and @shepai/web both depend on @shepai/core via workspace:*
  - [ ] TypeSpec output dir updated to packages/core/src/domain/generated/
  - [ ] Build pipeline: TypeSpec → core build → CLI build → web build
  - [ ] Data loaded via existing ListFeaturesUseCase through global DI bridge (no direct SQL, no new use cases)
  - [ ] FeatureNodeData extends generated Feature type from feature.tsp/output.ts
  - [ ] State and progress derived from Feature.plan.tasks inside the component (no pre-computed fields)
  - [ ] SdlcLifecycle enum used directly (no FeatureLifecyclePhase wrapper type)
  - [ ] Lifecycle display labels show human-readable names (e.g. "DEPLOY & QA", "COMPLETED" for maintain)
  - [ ] Maintain lifecycle always renders as done/completed state
  - [ ] globalThis DI bridge set up in WebServerService (not CLI folder)
  - [ ] No changes to src/presentation/cli/ folder
  - [ ] Badge shows agent type icon (SVG) for each AgentType enum value (claude-code, cursor, gemini-cli, aider, continue)
  - [ ] Badge shows lifecycle-derived verb for running state (Analyzing, Researching, Implementing, Reviewing, Deploying)
  - [ ] AgentTypeValue union type mirrors TypeSpec AgentType enum
  - [ ] Web imports use @shepai/core/* instead of @cli/* path aliases
  - [ ] All @/ alias imports within core converted to relative paths
  - [ ] pnpm install links @shepai/core workspace, all builds pass

  ## Affected Areas

  | Area                                            | Impact | Reasoning                                  |
  | ----------------------------------------------- | ------ | ------------------------------------------ |
  | `packages/core/`                                | High   | New @shepai/core workspace package (domain + app + infra) |
  | `src/domain/`, `src/application/`, `src/infrastructure/` | High | Moved to packages/core/src/ |
  | `pnpm-workspace.yaml`                           | High   | Add packages/core entry |
  | `tspconfig.yaml`                                | Medium | TypeSpec output dir → packages/core/src/domain/generated |
  | `package.json` (root)                           | Medium | Add @shepai/core dep, remove moved deps |
  | `tsconfig.json`, `tsconfig.build.json` (root)   | Medium | Update paths and includes |
  | `vitest.config.ts`                              | Medium | Add @shepai/core alias |
  | `src/presentation/web/package.json`             | Medium | Add @shepai/core dependency |
  | `src/presentation/web/tsconfig.json`            | Medium | Replace @cli/* with @shepai/core paths |
  | `src/presentation/web/components/features/`     | High   | New control-center component directory |
  | `src/presentation/web/components/common/feature-node/` | Low | Add selected visual state |
  | `src/presentation/web/app/page.tsx`             | Medium | Control Center homepage, Feature data flow |
  | `~20 CLI command files`                         | Medium | Relative imports → @shepai/core/* |
  | `~30 infrastructure files`                      | Medium | @/ aliases → relative paths within core |

  ## Dependencies

  - **015-feature-flow-canvas** (Complete): FeaturesCanvas and node components
  - **013-ui-arch** (Complete): Four-tier component hierarchy
  - **014-ui-sidebar** (Complete): Sidebar navigation context

  ## Scope Boundaries

  **In scope:**
  - Extract @shepai/core workspace package (domain, application, infrastructure layers)
  - Pre-compiled package with tsc build step → packages/core/dist/
  - ControlCenter orchestrator wrapping FeaturesCanvas
  - State management hook (useControlCenterState)
  - Empty state CTA and contextual node actions (toolbar removed for cleaner UX)
  - Node selection with visual highlight
  - Contextual add via RepositoryNode (+) → creates connected FeatureNode
  - Contextual add via FeatureNode (+) → creates connected child FeatureNode
  - New node positioning (to the right of source) and auto-selection
  - Keyboard shortcut (Escape to deselect)
  - Storybook stories with mock data
  - Extending FeaturesCanvas/FeatureNode/RepositoryNode props as needed
  - Global DI bridge module (globalThis) set up in WebServerService for runtime use case access
  - Uses existing ListFeaturesUseCase returning Feature[] (no new use cases, no new repo methods)
  - FeatureNodeData extends generated Feature type — component derives state/progress from domain data
  - Control center page consumes data via existing use cases through DI bridge (no direct SQL)
  - Web imports from @shepai/core (not @cli/* path aliases)
  - No modifications to src/presentation/cli/ folder
  - Update build pipeline: TypeSpec → core → CLI → web

  **Out of scope:**
  - Real-time updates or WebSocket integration
  - Drag-and-drop node creation (nodes added via (+) buttons, not drag)
  - Auto-layout algorithm implementation (button placeholder only)
  - Node context menu (stretch goal for future)
  - Filter/search in toolbar (stretch goal for future)

  ## Size Estimate

  **M** - Creates a new orchestrator component with 3 files (component, hook,
  toolbar), modifies 2 existing components (FeaturesCanvas props, FeatureNode
  selected state), and requires comprehensive Storybook stories. Moderate
  complexity from React Flow Panel integration and state management.

  ---

  _Generated by `/shep-kit:new-feature` — proceed with `/shep-kit:research`_
