# Implementation Plan (YAML)
# This is the source of truth. Markdown is auto-generated from this file.

name: control-center
summary: Implementation plan for 016-control-center

# Relationships
relatedFeatures:
  - '015-feature-flow-canvas'
  - '013-ui-arch'
  - '014-ui-sidebar'
technologies:
  - '@xyflow/react ^12.10.0'
  - React 19
  - Tailwind CSS v4
  - shadcn/ui
  - Storybook 8
  - Lucide React
relatedLinks:
  - https://reactflow.dev/api-reference/components/panel
  - https://reactflow.dev/api-reference/hooks/use-on-selection-change

# Structured implementation phases
phases:
  - id: phase-1
    name: 'Foundation'
    parallel: false
    taskIds:
      - task-1
  - id: phase-2
    name: 'Existing Component Updates'
    parallel: true
    taskIds:
      - task-2
      - task-3
  - id: phase-3
    name: 'State Management Hook'
    parallel: false
    taskIds:
      - task-4
  - id: phase-4
    name: 'Sub-components'
    parallel: true
    taskIds:
      - task-5
      - task-6
      - task-7
  - id: phase-5
    name: 'Orchestrator Integration'
    parallel: false
    taskIds:
      - task-8
  - id: phase-6
    name: 'Build Validation'
    parallel: false
    taskIds:
      - task-9

# File change tracking
filesToCreate:
  - src/presentation/web/components/features/control-center/control-center.tsx
  - src/presentation/web/components/features/control-center/use-control-center-state.ts
  - src/presentation/web/components/features/control-center/control-center-toolbar.tsx
  - src/presentation/web/components/features/control-center/control-center-detail-panel.tsx
  - src/presentation/web/components/features/control-center/control-center-status-bar.tsx
  - src/presentation/web/components/features/control-center/control-center.stories.tsx
  - src/presentation/web/components/features/control-center/index.ts
  - tests/unit/presentation/web/components/features/control-center/use-control-center-state.test.ts
  - tests/unit/presentation/web/components/features/control-center/control-center-toolbar.test.tsx
  - tests/unit/presentation/web/components/features/control-center/control-center-detail-panel.test.tsx
  - tests/unit/presentation/web/components/features/control-center/control-center-status-bar.test.tsx
  - tests/unit/presentation/web/components/features/control-center/control-center.test.tsx

filesToModify:
  - src/presentation/web/components/common/feature-node/feature-node.tsx
  - src/presentation/web/components/common/feature-node/feature-node.stories.tsx
  - src/presentation/web/components/features/features-canvas/features-canvas.tsx
  - src/presentation/web/components/features/features-canvas/features-canvas.stories.tsx

# Open questions
openQuestions: []

# Status
status:
  phase: planning
  updatedAt: '2026-02-12'

# Markdown content (the full plan document)
content: |
  ## Status

  - **Phase:** Planning
  - **Updated:** 2026-02-12

  ## Architecture Overview

  ```
  ┌──────────────────────────────────────────────────────────────┐
  │  ControlCenter (Tier 3 orchestrator)                         │
  │  ┌────────────────────────────────────────────────────────┐  │
  │  │  <Panel position="top-left">                          │  │
  │  │    ControlCenterToolbar                                │  │
  │  │    [Add Feature] [Auto-Layout]                         │  │
  │  └────────────────────────────────────────────────────────┘  │
  │  ┌──────────────────────────────┬─────────────────────────┐  │
  │  │                              │ <Panel position=         │  │
  │  │  FeaturesCanvas              │  "top-right">            │  │
  │  │  (existing, stays pure)      │  ControlCenterDetail     │  │
  │  │                              │  Panel                   │  │
  │  │  ┌──────────┐ ┌──────────┐  │  - Feature name          │  │
  │  │  │FeatureNode│→│FeatureNode│ │  - Lifecycle phase       │  │
  │  │  │(selected) │ │          │  │  - Progress              │  │
  │  │  │ ring-2    │ │          │  │  - Description           │  │
  │  │  └──────────┘ └──────────┘  │  - State info             │  │
  │  │       ↑                     │                           │  │
  │  │  RepositoryNode             │  [Close] button           │  │
  │  └──────────────────────────────┴─────────────────────────┘  │
  │  ┌────────────────────────────────────────────────────────┐  │
  │  │  <Panel position="bottom-left">                       │  │
  │  │    ControlCenterStatusBar                              │  │
  │  │    "5 features: 2 running, 1 done, 2 blocked"         │  │
  │  └────────────────────────────────────────────────────────┘  │
  │                                                              │
  │  useControlCenterState (custom hook)                         │
  │  - Selection tracking (useOnSelectionChange)                 │
  │  - Panel open/close state                                    │
  │  - Keyboard shortcuts (Escape)                               │
  │  - Node/edge state pass-through                              │
  └──────────────────────────────────────────────────────────────┘
  ```

  ### Component Hierarchy

  ```
  Tier 3: features/control-center/     ← NEW orchestrator
              ├── composes FeaturesCanvas (Tier 3)
              ├── adds panels/toolbars via React Flow <Panel>
              └── manages state via useControlCenterState hook

  Tier 3: features/features-canvas/    ← EXISTING (stays pure/dumb)
  Tier 1: common/feature-node/         ← EXISTING (add selected ring)
  Tier 1: common/repository-node/      ← UNCHANGED
  ```

  ### Data Flow

  ```
  Props (nodes, edges, callbacks)
       │
       ▼
  ControlCenter
       │
       ├──► useControlCenterState(nodes, edges)
       │         │
       │         ├── selectedNode (from useOnSelectionChange)
       │         ├── isDetailPanelOpen (derived from selection)
       │         └── featureSummary (computed from nodes)
       │
       ├──► FeaturesCanvas (nodes, edges, onNodeClick, onPaneClick)
       │
       ├──► ControlCenterToolbar (onAddFeature, onAutoLayout)
       │
       ├──► ControlCenterDetailPanel (selectedNode, onClose)
       │
       └──► ControlCenterStatusBar (featureSummary)
  ```

  ## Implementation Strategy

  **MANDATORY TDD**: All implementation phases with executable code follow RED-GREEN-REFACTOR cycles.

  ### Phase 1: Foundation (No Tests)

  **Goal:** Scaffold the control-center directory structure with empty component shells and barrel exports.

  **Steps:**

  1. Create `features/control-center/` directory with all component files
  2. Add minimal type-safe placeholder exports for each component
  3. Set up `index.ts` barrel file with all exports

  **Deliverables:** Empty scaffolded directory, compilable with `pnpm typecheck:web`

  ### Phase 2: Existing Component Updates (TDD Cycles 1-2) [P]

  **Goal:** Update FeatureNode with selection visual and extend FeaturesCanvas with interaction callbacks. These two tasks are parallelizable.

  #### 2A: FeatureNode Selected Highlight

  **TDD Workflow:**

  1. **RED:** Write test that FeatureNode renders `ring-2 ring-primary` classes when `selected` prop is true, and does NOT render them when false
  2. **GREEN:** Add conditional `ring-2 ring-primary` class to FeatureNode card wrapper using `cn()`, keyed on the `selected` prop from React Flow
  3. **REFACTOR:** Ensure ring classes integrate cleanly with existing border styles; update Storybook stories to include Selected variant

  #### 2B: FeaturesCanvas Interaction Callbacks

  **TDD Workflow:**

  1. **RED:** Write test that FeaturesCanvas passes `onNodeClick` and `onPaneClick` through to the underlying ReactFlow component
  2. **GREEN:** Add `onNodeClick` and `onPaneClick` to `FeaturesCanvasProps`, pass them to `<ReactFlow>`
  3. **REFACTOR:** Update type exports, verify stories still render correctly

  **Deliverables:** FeatureNode with selection ring, FeaturesCanvas with interaction callbacks

  ### Phase 3: State Management Hook (TDD Cycle 3)

  **Goal:** Implement `useControlCenterState` — the central state hook for the control center.

  **TDD Workflow:**

  1. **RED:** Write tests for:
     - Returns selectedNode when a node is selected via useOnSelectionChange
     - Returns null selectedNode when selection is cleared
     - isDetailPanelOpen is true when a FeatureNode is selected, false otherwise
     - featureSummary computes correct counts by state
     - Escape keypress clears selection and closes panel
  2. **GREEN:** Implement hook composing:
     - `useOnSelectionChange` for selection tracking
     - `useState` for panel visibility (derived from selection of FeatureNode type)
     - `useMemo` for feature summary computation
     - `useEffect` + `keydown` listener for Escape shortcut
     - `useCallback` for memoized event handlers
  3. **REFACTOR:** Extract feature summary computation into a pure helper function for testability

  **Deliverables:** Fully tested `useControlCenterState` hook

  ### Phase 4: Sub-components (TDD Cycles 4-6) [P]

  **Goal:** Build the three panel sub-components independently. All three are parallelizable.

  #### 4A: ControlCenterToolbar

  **TDD Workflow:**

  1. **RED:** Write tests that:
     - Renders "Add Feature" button
     - Renders "Auto-Layout" button (disabled placeholder)
     - Calls `onAddFeature` callback when Add Feature clicked
  2. **GREEN:** Implement toolbar as horizontal button bar with Lucide icons (Plus, LayoutGrid), using shadcn/ui Button components inside `<Panel position="top-left">`
  3. **REFACTOR:** Extract button configs for extensibility; add Storybook story

  #### 4B: ControlCenterDetailPanel

  **TDD Workflow:**

  1. **RED:** Write tests that:
     - Renders feature name, lifecycle, state, progress when open
     - Does not render content when closed (isOpen=false)
     - Calls onClose callback when close button clicked
     - Renders description when available
  2. **GREEN:** Implement panel inside `<Panel position="top-right">` with:
     - Feature info display (name, lifecycle badge, state, progress bar, description)
     - Close button (X icon)
     - Tailwind transition classes: `translate-x-0`/`translate-x-full`, `opacity-0`/`opacity-100`
     - `transition-all duration-300 ease-in-out`
  3. **REFACTOR:** Extract info rows into a clean layout; add Storybook story

  #### 4C: ControlCenterStatusBar

  **TDD Workflow:**

  1. **RED:** Write tests that:
     - Renders total feature count
     - Renders count breakdown by state (running, done, blocked, etc.)
     - Renders "No features" when empty
  2. **GREEN:** Implement status bar inside `<Panel position="bottom-left">` with feature summary text and state-colored badges
  3. **REFACTOR:** Reuse state color config from `feature-node-state-config.ts`; add Storybook story

  **Deliverables:** Three independently tested and storied sub-components

  ### Phase 5: Orchestrator Integration (TDD Cycle 7)

  **Goal:** Wire everything together in the `ControlCenter` component.

  **TDD Workflow:**

  1. **RED:** Write tests that:
     - Renders FeaturesCanvas with provided nodes and edges
     - Renders toolbar panel
     - Renders status bar panel
     - Shows detail panel when a FeatureNode is selected
     - Hides detail panel when selection is cleared
     - Passes onAddFeature through to toolbar
  2. **GREEN:** Implement ControlCenter composing:
     - `FeaturesCanvas` with nodes, edges, and interaction callbacks
     - `ControlCenterToolbar` with action handlers
     - `ControlCenterDetailPanel` with selected node data and visibility
     - `ControlCenterStatusBar` with computed summary
     - All wired through `useControlCenterState`
  3. **REFACTOR:** Clean up prop threading; ensure minimal re-renders

  **Deliverables:** Full ControlCenter component with Storybook stories (Empty, WithFeatures, SelectedNode, WithToolbar)

  ### Phase 6: Build Validation (No Tests)

  **Goal:** Ensure everything compiles and passes quality gates.

  **Steps:**

  1. `pnpm lint:web` — ESLint passes
  2. `pnpm typecheck:web` — TypeScript compiles
  3. `pnpm build:storybook` — Storybook builds
  4. `pnpm build:web` — Next.js production build passes

  **Deliverables:** All builds green

  ## Files to Create/Modify

  ### New Files

  | File | Purpose |
  | ---- | ------- |
  | `features/control-center/control-center.tsx` | Main orchestrator component |
  | `features/control-center/use-control-center-state.ts` | Custom hook: selection, panels, summary |
  | `features/control-center/control-center-toolbar.tsx` | Top toolbar (add feature, auto-layout) |
  | `features/control-center/control-center-detail-panel.tsx` | Right panel for selected feature info |
  | `features/control-center/control-center-status-bar.tsx` | Bottom status summary bar |
  | `features/control-center/control-center.stories.tsx` | Storybook stories for orchestrator |
  | `features/control-center/index.ts` | Barrel exports |
  | `tests/.../use-control-center-state.test.ts` | Hook unit tests |
  | `tests/.../control-center-toolbar.test.tsx` | Toolbar unit tests |
  | `tests/.../control-center-detail-panel.test.tsx` | Detail panel unit tests |
  | `tests/.../control-center-status-bar.test.tsx` | Status bar unit tests |
  | `tests/.../control-center.test.tsx` | Orchestrator integration tests |

  ### Modified Files

  | File | Changes |
  | ---- | ------- |
  | `common/feature-node/feature-node.tsx` | Add conditional `ring-2 ring-primary` when `selected` |
  | `common/feature-node/feature-node.stories.tsx` | Add Selected story variant |
  | `features/features-canvas/features-canvas.tsx` | Add `onNodeClick`, `onPaneClick` props, pass to ReactFlow |
  | `features/features-canvas/features-canvas.stories.tsx` | Add Interactive story with callbacks |

  ## Testing Strategy (TDD: Tests FIRST)

  **CRITICAL:** Tests are written FIRST in each TDD cycle.

  ### Unit Tests (RED -> GREEN -> REFACTOR)

  Write FIRST for:
  - `useControlCenterState` hook — selection tracking, panel visibility, summary computation, keyboard shortcuts
  - `ControlCenterToolbar` — button rendering, callback invocation
  - `ControlCenterDetailPanel` — feature info display, open/close state, close callback
  - `ControlCenterStatusBar` — count rendering, empty state
  - `FeatureNode` — selected ring visual (addition to existing tests)
  - `FeaturesCanvas` — callback prop pass-through (addition to existing tests)

  ### Storybook Stories (Visual Verification)

  Every component has colocated stories:
  - `FeatureNode` — add Selected variant to existing stories
  - `FeaturesCanvas` — add Interactive variant with callbacks
  - `ControlCenterToolbar` — Default, WithCallbacks
  - `ControlCenterDetailPanel` — Open, Closed, WithDescription, RunningState, ErrorState
  - `ControlCenterStatusBar` — Empty, WithFeatures, MixedStates
  - `ControlCenter` — Empty, WithFeatures, SelectedNode, WithToolbar

  ### E2E Tests (Stretch)

  Not required for initial implementation. Canvas interaction testing can be added post-merge.

  ## Risk Mitigation

  | Risk | Mitigation |
  | ---- | ---------- |
  | React Flow Panel conflicts with existing Controls/MiniMap | Test with Background and Controls present in stories |
  | useOnSelectionChange callback not memoized causing re-subscriptions | Wrap in useCallback per React Flow docs |
  | Detail panel blocks canvas pan/zoom | Panel is inside React Flow Panel (no overlay/backdrop) |
  | FeatureNode ring conflicts with existing left border | Test ring + border combination visually in Storybook |
  | CSS transitions not GPU-accelerated | Use transform/opacity only (no layout-triggering properties) |

  ## Rollback Plan

  Feature is purely additive UI. Rollback by reverting the feature branch merge. No data migrations, no backend changes, no breaking API changes.

  ---

  _Updated by `/shep-kit:plan` — see tasks.md for detailed breakdown_
