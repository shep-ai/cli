# Task Breakdown (YAML)
# This is the source of truth. Markdown is auto-generated from this file.

name: control-center
summary: Task breakdown for 016-control-center

# Relationships
relatedFeatures:
  - '015-feature-flow-canvas'
  - '013-ui-arch'
technologies:
  - '@xyflow/react ^12.10.0'
  - React 19
  - Tailwind CSS v4
  - shadcn/ui
  - Storybook 8
  - Lucide React
relatedLinks:
  - https://reactflow.dev/api-reference/components/panel
  - https://reactflow.dev/api-reference/hooks/use-on-selection-change

# Structured task list
tasks:
  - id: task-1
    title: 'Scaffold control-center directory structure'
    description: >
      Create the features/control-center/ directory with empty component shells,
      TypeScript interfaces, and barrel exports. All files should compile with
      pnpm typecheck:web.
    state: Done
    dependencies: []
    acceptanceCriteria:
      - 'Directory features/control-center/ exists with all 5 files'
      - 'index.ts barrel exports all components and types'
      - 'pnpm typecheck:web passes with placeholder implementations'
    tdd: null
    estimatedEffort: S

  - id: task-2
    title: 'Add selected visual highlight to FeatureNode [P]'
    description: >
      Add a ring-2 ring-primary highlight to FeatureNode when the selected prop
      is true. React Flow passes selected as a prop to all custom nodes. Update
      Storybook stories with a Selected variant.
    state: Done
    dependencies:
      - task-1
    acceptanceCriteria:
      - 'FeatureNode renders ring-2 ring-primary when selected=true'
      - 'FeatureNode does NOT render ring classes when selected=false'
      - 'Ring does not conflict with existing left border styling'
      - 'Storybook has Selected variant for each state'
      - 'Unit test verifies conditional ring class application'
    tdd:
      red:
        - 'Write test: FeatureNode renders ring-2 ring-primary when selected=true'
        - 'Write test: FeatureNode does NOT render ring classes when selected=false'
      green:
        - 'Add conditional cn() class: ring-2 ring-primary when selected prop is true'
      refactor:
        - 'Verify ring integrates cleanly with existing border-l-4 styles'
        - 'Add Selected story variant to feature-node.stories.tsx'
    estimatedEffort: S

  - id: task-3
    title: 'Extend FeaturesCanvas with interaction and contextual add callbacks [P]'
    description: >
      Add onNodeClick, onPaneClick, onRepositoryAdd, and onNodeAction callback props
      to FeaturesCanvasProps. Pass onNodeClick/onPaneClick to ReactFlow. Wire
      onRepositoryAdd to RepositoryNode's onAdd and onNodeAction to FeatureNode's
      onAction during node enrichment. Update stories.
    state: Done
    dependencies:
      - task-1
    acceptanceCriteria:
      - 'FeaturesCanvasProps includes onNodeClick, onPaneClick, onRepositoryAdd, onNodeAction'
      - 'onNodeClick and onPaneClick passed through to ReactFlow component'
      - 'onRepositoryAdd wired to RepositoryNode onAdd during node enrichment'
      - 'onNodeAction wired to FeatureNode onAction during node enrichment'
      - 'Existing stories still render correctly'
      - 'New Interactive story demonstrates callback usage'
      - 'Unit tests verify callback prop pass-through and node enrichment wiring'
    tdd:
      red:
        - 'Write test: FeaturesCanvas accepts onNodeClick prop'
        - 'Write test: FeaturesCanvas accepts onPaneClick prop'
        - 'Write test: FeaturesCanvas wires onRepositoryAdd to RepositoryNode onAdd'
        - 'Write test: FeaturesCanvas wires onNodeAction to FeatureNode onAction'
      green:
        - 'Add all four callback props to FeaturesCanvasProps interface'
        - 'Pass onNodeClick/onPaneClick to <ReactFlow> component'
        - 'Wire onRepositoryAdd/onNodeAction to nodes in enrichment useMemo'
      refactor:
        - 'Update type exports in index.ts'
        - 'Add Interactive story variant to features-canvas.stories.tsx'
    estimatedEffort: S

  - id: task-4
    title: 'Implement useControlCenterState hook (selection + contextual add)'
    description: >
      Build the central state management hook that composes React Flow hooks
      (useOnSelectionChange, useReactFlow) with local state for selection tracking,
      Escape keyboard shortcut, and contextual add handlers for creating new
      FeatureNodes from repo and feature (+) buttons.
    state: Done
    dependencies:
      - task-2
      - task-3
    acceptanceCriteria:
      - 'Hook returns selectedNode (FeatureNodeData | null)'
      - 'Hook returns clearSelection function'
      - 'Escape key clears selection'
      - 'useOnSelectionChange callback is memoized with useCallback'
      - 'handleAddFeatureToRepo(repoNodeId) adds FeatureNode + edge'
      - 'handleAddFeatureToFeature(featureNodeId) adds FeatureNode + edge'
      - 'handleAddFeature() adds unconnected FeatureNode'
      - 'New nodes positioned to the right of source (x + 350)'
      - 'New nodes are auto-selected after creation'
      - 'All tests pass'
    tdd:
      red:
        - 'Write test: returns selectedNode when FeatureNode selected'
        - 'Write test: returns null selectedNode when no selection'
        - 'Write test: Escape key clears selection'
        - 'Write test: handleAddFeatureToRepo adds node + edge'
        - 'Write test: handleAddFeatureToFeature adds node + edge'
        - 'Write test: handleAddFeature adds unconnected node'
        - 'Write test: new node positioned at source.x + 350'
        - 'Write test: new node is auto-selected'
      green:
        - 'Implement useOnSelectionChange to track selected node'
        - 'Add useEffect with keydown listener for Escape'
        - 'Implement add handlers using useReactFlow (addNodes, addEdges, getNode)'
        - 'Calculate position from source node via getNode()'
      refactor:
        - 'Ensure all callbacks are properly memoized'
        - 'Extract createDefaultFeatureNode factory helper'
        - 'Deduplicate add logic between repo/feature handlers'
    estimatedEffort: M

  - id: task-5
    title: 'Implement ControlCenterToolbar component'
    description: >
      Originally planned as a top toolbar panel with Add Feature and Auto-Layout
      buttons. Implemented initially but REMOVED in refactor (commit 0c9afbe) —
      toolbar was replaced by contextual (+) buttons on nodes and empty state CTA,
      providing a cleaner canvas-first UX.
    state: Removed
    dependencies:
      - task-1
    acceptanceCriteria:
      - 'REMOVED — toolbar replaced by contextual node actions and empty state CTA'
    tdd: null
    estimatedEffort: S
    removedReason: >
      Toolbar was removed post-implementation in favor of contextual (+) buttons
      on repository/feature nodes and an empty-state CTA for initial repo selection.
      This provides a cleaner canvas-first experience without overlay chrome.

  - id: task-6
    title: 'Implement ControlCenter orchestrator component'
    description: >
      Wire all sub-components together in the main ControlCenter component.
      Composes FeaturesCanvas via useControlCenterState hook with
      ControlCenterInner wrapper. Wires contextual add handlers
      (onRepositoryAdd, onNodeAction) to canvas. Shows empty state CTA
      when no nodes present. Toolbar was removed in favor of contextual actions.
    state: Done
    dependencies:
      - task-4
    acceptanceCriteria:
      - 'Renders FeaturesCanvas with nodes and edges'
      - 'Wires handleAddFeatureToRepo to FeaturesCanvas onRepositoryAdd'
      - 'Wires handleAddFeatureToFeature to FeaturesCanvas onNodeAction'
      - 'Shows empty state with "Add Repository" CTA when no nodes'
      - 'Escape key deselects node'
      - 'Storybook stories: Empty, WithFeatures, WithNodeActions'
      - 'ControlCenter props: initialNodes, initialEdges'
      - 'pnpm test passes for all control-center tests'
    tdd:
      red:
        - 'Write test: renders FeaturesCanvas with nodes and edges'
        - 'Write test: shows empty state when no nodes provided'
        - 'Write test: wires onRepositoryAdd to FeaturesCanvas'
        - 'Write test: wires onNodeAction to FeaturesCanvas'
      green:
        - 'Compose all sub-components inside ControlCenter'
        - 'Wire useControlCenterState for state management'
        - 'Pass interaction callbacks and contextual add handlers to FeaturesCanvas'
      refactor:
        - 'Add comprehensive Storybook stories (including WithNodeActions)'
        - 'Verify no unnecessary re-renders with React DevTools'
    estimatedEffort: M

  - id: task-7
    title: 'Build validation and final cleanup'
    description: >
      Run all build validation commands to ensure the feature compiles,
      lints, and builds correctly across all targets.
    state: Done
    dependencies:
      - task-6
    acceptanceCriteria:
      - 'pnpm lint:web passes'
      - 'pnpm typecheck:web passes'
      - 'pnpm build:storybook passes'
      - 'pnpm build:web passes'
      - 'All unit tests pass (pnpm test:unit)'
      - 'Components follow tier import rules (013-ui-arch)'
    tdd: null
    estimatedEffort: S

  - id: task-8
    title: 'Set up DI bridge with existing ListFeaturesUseCase and Feature type props'
    description: >
      SUPERSEDED by tasks 15-22 (@shepai/core extraction plan). The original approach
      of patching imports with @cli/* path aliases is replaced by extracting a proper
      @shepai/core workspace package.
    state: Superseded
    dependencies:
      - task-6
    acceptanceCriteria:
      - 'SUPERSEDED — see tasks 15-22'
    tdd: null
    estimatedEffort: L
    supersededBy: 'tasks 15-22 (@shepai/core extraction)'

  - id: task-9
    title: 'Align FeatureLifecyclePhase with domain SdlcLifecycle'
    description: >
      Update FeatureLifecyclePhase type to match domain SdlcLifecycle 1:1.
      Replace invented UI phases ('plan', 'test', 'maintenance') with domain
      values ('research', 'review', 'maintain'). Add lifecycleDisplayLabels
      map for human-readable names (maintain→'COMPLETED', deploy→'DEPLOY & QA').
      Update feature-node.tsx to use display labels. Fix lifecycleMap in page.tsx.
    state: Done
    dependencies:
      - task-7
    acceptanceCriteria:
      - "FeatureLifecyclePhase type is 'requirements'|'research'|'implementation'|'review'|'deploy'|'maintain'"
      - 'lifecycleDisplayLabels map exported from feature-node index.ts'
      - 'feature-node.tsx uses lifecycleDisplayLabels[data.lifecycle] instead of .toUpperCase()'
      - 'lifecycleMap in page.tsx maps domain values 1:1'
      - 'pnpm typecheck:web passes'
    tdd:
      red:
        - 'Write test: lifecycleDisplayLabels maps maintain to COMPLETED'
        - 'Write test: lifecycleDisplayLabels maps deploy to DEPLOY & QA'
      green:
        - 'Update FeatureLifecyclePhase type union'
        - 'Add lifecycleDisplayLabels const'
        - 'Update feature-node.tsx to use display labels'
        - 'Fix lifecycleMap in page.tsx'
      refactor:
        - 'Export lifecycleDisplayLabels from index.ts'
    estimatedEffort: S

  - id: task-10
    title: 'Update stories and tests for Feature type props'
    description: >
      SUPERSEDED by task-20 (control center data layer). Story/test updates
      are now part of the @shepai/core extraction plan.
    state: Superseded
    dependencies:
      - task-8
      - task-9
    acceptanceCriteria:
      - 'SUPERSEDED — see task-20'
    tdd: null
    estimatedEffort: M
    supersededBy: 'task-20 (control center data layer)'

  - id: task-11
    title: 'Update stories with new lifecycle values'
    description: >
      Update all Storybook stories in feature-node.stories.tsx to use new
      lifecycle phase values. Replace 'plan' with 'research', 'test' with
      'review', 'maintenance' with 'maintain'. Update allLifecycles array.
      Verify AllLifecycles story renders correct display labels.
    state: Done
    dependencies:
      - task-9
    acceptanceCriteria:
      - 'No old lifecycle values (plan, test, maintenance) in stories'
      - 'allLifecycles array uses new values'
      - 'AllLifecycles story shows REQUIREMENTS, RESEARCH, IMPLEMENTATION, REVIEW, DEPLOY & QA, COMPLETED'
      - 'pnpm build:storybook passes'
    tdd: null
    estimatedEffort: S

  - id: task-12
    title: 'Create agent type icons with agentType as optional FeatureNodeData field'
    description: >
      Create agent-type-icons.tsx with an AgentTypeValue union type mirroring
      the TypeSpec AgentType enum (claude-code, cursor, gemini-cli, aider,
      continue). Implement inline SVG icon components for each agent type
      plus a DefaultAgentIcon fallback. Export a getAgentTypeIcon() resolver.
      agentType is an optional UI override field on FeatureNodeData (not from
      the Feature domain model). Currently shows DefaultAgentIcon when not set.
    state: Done
    dependencies:
      - task-10
    acceptanceCriteria:
      - 'agent-type-icons.tsx exports AgentTypeValue union type'
      - 'SVG components exist for all 5 AgentType enum values plus DefaultAgentIcon'
      - 'getAgentTypeIcon() resolves agent type string to icon component'
      - 'FeatureNodeData includes agentType?: AgentTypeValue as optional override'
      - 'pnpm typecheck:web passes'
    tdd:
      red:
        - 'Write test: getAgentTypeIcon returns ClaudeCodeIcon for claude-code'
        - 'Write test: getAgentTypeIcon returns DefaultAgentIcon for undefined'
      green:
        - 'Create agent-type-icons.tsx with SVG components and resolver'
        - 'Add agentType to FeatureNodeData'
        - 'Pass agentType in page.tsx nodeData from bridge'
      refactor:
        - 'Ensure all SVGs use currentColor and accept className'
    estimatedEffort: M

  - id: task-13
    title: 'Update feature node badge (hide featureId, agent icon, lifecycle verbs)'
    description: >
      Remove featureId rendering from both the progress-bar and non-progress
      views in feature-node.tsx. Add lifecycleRunningVerbs map to
      feature-node-state-config.ts mapping lifecycle phases to present-participle
      verbs (Analyzing, Researching, Implementing, Reviewing, Deploying,
      Maintaining). Update getBadgeText running case to use lifecycle verb.
      In running badge: show CometSpinner + AgentTypeIcon + lifecycle verb text.
      For non-running states: show agent icon (if agentType available) before
      state icon. Remove agentName from FeatureNodeData (replaced by agentType).
    state: Done
    dependencies:
      - task-12
    acceptanceCriteria:
      - 'featureId not rendered in the feature node card'
      - 'Running badge shows CometSpinner + agent type icon + lifecycle verb'
      - 'lifecycleRunningVerbs maps all 6 phases to verbs'
      - 'getBadgeText running case returns lifecycle verb (e.g. Analyzing)'
      - 'Non-running states show agent icon before state icon when agentType set'
      - 'agentName removed from FeatureNodeData'
      - 'pnpm typecheck:web passes'
    tdd:
      red:
        - 'Write test: featureId is NOT rendered in the card'
        - 'Write test: running badge shows lifecycle verb for each phase'
        - 'Write test: running badge does not show featureId in text'
      green:
        - 'Remove featureId spans from both views'
        - 'Add lifecycleRunningVerbs map'
        - 'Update getBadgeText running case'
        - 'Update badge icon rendering with agent type icon + CometSpinner'
        - 'Remove agentName from FeatureNodeData'
      refactor:
        - 'Remove unused agentName imports'
        - 'Verify badge sizing and spacing'
    estimatedEffort: M

  - id: task-14
    title: 'Update tests and Storybook stories for badge improvements'
    description: >
      Fix broken tests that assert featureId rendering and old badge text.
      Add tests for lifecycle running verbs across all 6 phases. Update all
      Storybook story data to replace agentName with agentType. Add
      AllAgentTypes story showcasing all 5 agent types plus fallback.
      Export lifecycleRunningVerbs and getAgentTypeIcon from index.ts.
    state: Done
    dependencies:
      - task-13
    acceptanceCriteria:
      - 'Test "renders featureId" updated to assert featureId NOT rendered'
      - 'Test "agent name and featureId in badge text" updated for lifecycle verb'
      - 'Test "defaults to Agent" updated for lifecycle verb'
      - 'Tests for all 6 lifecycle running verbs pass'
      - 'All story data uses agentType instead of agentName'
      - 'AllAgentTypes story exists showing all 5 types + fallback'
      - 'lifecycleRunningVerbs and getAgentTypeIcon exported from index.ts'
      - 'pnpm build:storybook passes'
      - 'All unit tests pass'
    tdd:
      red:
        - 'Write test: each lifecycle phase shows correct running verb'
        - 'Write test: agent icon renders for known agent type'
        - 'Write test: fallback icon renders for unknown agent type'
      green:
        - 'Fix existing broken tests'
        - 'Add lifecycle verb tests'
        - 'Update stories with agentType'
        - 'Add AllAgentTypes story'
        - 'Export new symbols from index.ts'
      refactor:
        - 'Remove all agentName references from stories'
    estimatedEffort: S

  - id: task-15
    title: 'Scaffold @shepai/core workspace package'
    description: >
      Create packages/core/ with package.json (@shepai/core, private, type: module,
      subpath exports for domain/application/infrastructure), tsconfig.json (noEmit),
      tsconfig.build.json (compilation to dist/), and empty src/index.ts. Update
      pnpm-workspace.yaml to add packages/core. Run pnpm install to link workspace.
      Verify existing build still works.
    state: Done
    dependencies:
      - task-14
    acceptanceCriteria:
      - 'packages/core/package.json exists with subpath exports'
      - 'packages/core/tsconfig.json and tsconfig.build.json configured'
      - 'packages/core/src/index.ts exists (empty barrel)'
      - 'pnpm-workspace.yaml includes packages/core'
      - 'pnpm install succeeds with workspace link'
      - 'Existing pnpm build still passes'
    tdd: null
    estimatedEffort: S

  - id: task-16
    title: 'Move domain layer to @shepai/core'
    description: >
      Move src/domain/ → packages/core/src/domain/. Create barrel export.
      Update tspconfig.yaml emitter output dir to packages/core/src/domain/generated.
      Update tsp:codegen script prettier path. Update all domain imports across
      CLI, web, infrastructure, and tests.
    state: Done
    dependencies:
      - task-15
    acceptanceCriteria:
      - 'src/domain/ contents moved to packages/core/src/domain/'
      - 'packages/core/src/domain/index.ts barrel export exists'
      - 'tspconfig.yaml output dir points to packages/core/src/domain/generated'
      - 'pnpm tsp:compile generates to new location'
      - 'All domain type imports updated across codebase'
      - 'pnpm typecheck passes'
    tdd: null
    estimatedEffort: M

  - id: task-17
    title: 'Move application layer to @shepai/core'
    description: >
      Move src/application/ → packages/core/src/application/. Create barrel export.
      Delete ListDashboardFeaturesUseCase (policy violation). Remove DashboardFeature
      interface and listWithAgentRuns() from IFeatureRepository. Update all application
      imports across infrastructure, CLI, web, and tests.
    state: Done
    dependencies:
      - task-16
    acceptanceCriteria:
      - 'src/application/ contents moved to packages/core/src/application/'
      - 'packages/core/src/application/index.ts barrel export exists'
      - 'ListDashboardFeaturesUseCase deleted'
      - 'DashboardFeature removed from IFeatureRepository'
      - 'listWithAgentRuns() removed from interface and SQLite repo'
      - 'All application imports updated across codebase'
      - 'pnpm typecheck passes'
    tdd: null
    estimatedEffort: M

  - id: task-18
    title: 'Move infrastructure layer to @shepai/core'
    description: >
      Move src/infrastructure/ → packages/core/src/infrastructure/. Create barrel
      export. Convert all @/ alias imports within core to relative paths (~30 files).
      Remove ListDashboardFeaturesUseCase from DI container. Update CLI imports to
      @shepai/core/infrastructure/di. Update web imports from @cli/* to @shepai/core/*.
      Add @shepai/core dependency to @shepai/web package.json. Remove @cli/* path
      from web tsconfig.json.
    state: Done
    dependencies:
      - task-17
    acceptanceCriteria:
      - 'src/infrastructure/ contents moved to packages/core/src/infrastructure/'
      - 'packages/core/src/infrastructure/index.ts barrel export exists'
      - 'All @/ aliases within core converted to relative paths'
      - 'ListDashboardFeaturesUseCase removed from DI container'
      - 'CLI imports use @shepai/core/*'
      - 'Web imports use @shepai/core/* instead of @cli/*'
      - '@shepai/core: workspace:* in web package.json'
      - '@cli/* path removed from web tsconfig.json'
      - 'pnpm typecheck and pnpm typecheck:web pass'
    tdd: null
    estimatedEffort: L

  - id: task-19
    title: 'Clean up root package'
    description: >
      Remove moved dependencies from root package.json (keep commander, @inquirer/prompts,
      cli-table3, picocolors + all React/UI deps). Update root tsconfig.build.json
      to include only src/presentation/**/* and src/index.ts. Add @shepai/core path
      mapping to root tsconfig.json. Add @shepai/core alias to vitest.config.ts.
      Remove tsc-alias entries no longer needed.
    state: Done
    dependencies:
      - task-18
    acceptanceCriteria:
      - 'Moved dependencies removed from root package.json'
      - 'Root tsconfig.build.json includes only presentation + index'
      - '@shepai/core path mapping in root tsconfig.json'
      - '@shepai/core alias in vitest.config.ts'
      - 'Unused tsc-alias entries removed'
      - 'pnpm install, pnpm typecheck, pnpm build all pass'
    tdd: null
    estimatedEffort: M

  - id: task-20
    title: 'Control center data layer — FeatureNodeData extends Feature'
    description: >
      Wire FeatureNodeData to extend the generated Feature type from @shepai/core.
      Import Feature, SdlcLifecycle, TaskState from @shepai/core/domain/generated.
      Add deriveNodeState() and deriveProgress() utilities. Update page.tsx to
      spread Feature directly into node data. Delete derive-state.ts. Create
      createMockFeature() helper for stories/tests. Update all story data with
      Feature-compatible shapes.
    state: Done
    dependencies:
      - task-19
    acceptanceCriteria:
      - 'FeatureNodeData extends Feature from @shepai/core/domain/generated'
      - 'SdlcLifecycle used directly (no FeatureLifecyclePhase wrapper)'
      - 'deriveNodeState() returns correct state for each lifecycle/task combo'
      - 'deriveProgress() returns correct percentage from plan tasks'
      - 'page.tsx spreads Feature directly into node data'
      - 'derive-state.ts deleted'
      - 'createMockFeature() helper exists for stories/tests'
      - 'All story data uses Feature-compatible shapes'
      - 'pnpm test:unit passes'
      - 'pnpm build:storybook passes'
    tdd:
      red:
        - 'Write test: deriveNodeState returns done for Maintain lifecycle'
        - 'Write test: deriveNodeState returns running when tasks have WIP state'
        - 'Write test: deriveNodeState returns done when all tasks Done'
        - 'Write test: deriveNodeState returns action-required for Review tasks'
        - 'Write test: deriveProgress returns correct percentage from plan tasks'
      green:
        - 'Import Feature type from @shepai/core/domain/generated'
        - 'Update FeatureNodeData to extend Feature'
        - 'Add deriveNodeState() and deriveProgress() utilities'
        - 'Simplify page.tsx to spread Feature'
        - 'Delete derive-state.ts'
        - 'Create createMockFeature() helper'
        - 'Update all story data'
      refactor:
        - 'Remove all old FeatureLifecyclePhase string literal references'
        - 'Verify all stories render correctly'
    estimatedEffort: L

  - id: task-21
    title: 'globalThis bridge in WebServerService'
    description: >
      Update globalThis DI bridge to use ListFeaturesUseCase instead of
      ListDashboardFeaturesUseCase. Update CLI index.ts and dev-server.ts.
      Rewrite web/lib/use-cases.ts to import Feature type from
      @shepai/core/domain/generated and export getFeatures() returning Feature[].
    state: Done
    dependencies:
      - task-20
    acceptanceCriteria:
      - 'WebServerService.start() resolves ListFeaturesUseCase and sets globalThis.__shepUseCases'
      - 'CLI index.ts has no globalThis bridge setup'
      - 'Web dev-server.ts imports from @shepai/core'
      - 'web/lib/use-cases.ts imports Feature from @shepai/core/domain/generated'
      - 'getFeatures() returns Feature[] via globalThis bridge'
      - 'No changes to src/presentation/cli/ folder'
      - 'pnpm typecheck and pnpm typecheck:web pass'
    tdd: null
    estimatedEffort: M

  - id: task-22
    title: 'Final build validation'
    description: >
      Run all build, test, lint, and typecheck commands to verify the entire
      @shepai/core extraction and control center data layer work end-to-end.
    state: Done
    dependencies:
      - task-21
    acceptanceCriteria:
      - 'pnpm install succeeds with workspace links'
      - 'pnpm generate compiles TypeSpec to packages/core/'
      - 'pnpm --filter @shepai/core build compiles to dist/'
      - 'pnpm typecheck passes'
      - 'pnpm typecheck:web passes'
      - 'pnpm test:unit passes'
      - 'pnpm lint passes'
      - 'pnpm lint:web passes'
      - 'pnpm build:web passes'
      - 'pnpm build:storybook passes'
      - 'pnpm build passes (full pipeline)'
    tdd: null
    estimatedEffort: S

# Total effort estimate
totalEstimate: XL

# Open questions
openQuestions: []

# Markdown content (the full tasks document)
content: |
  ## Status

  - **Phase:** In Progress — @shepai/core extraction (tasks 15-22)
  - **Updated:** 2026-02-16

  ## Task List

  ### Phase 1: Foundation

  - [x] **task-1**: Scaffold control-center directory structure
    - Create `features/control-center/` with 5 files (component, hook, toolbar, stories, index)
    - Add minimal type-safe placeholder exports
    - Verify `pnpm typecheck:web` passes

  ### Phase 2: Existing Component Updates [P]

  #### 2A: FeatureNode Selected Highlight

  **RED (Write Failing Tests First):**

  - [x] Write test: FeatureNode renders `ring-2 ring-primary` when `selected=true`
  - [x] Write test: FeatureNode does NOT render ring classes when `selected=false`

  **GREEN (Implement to Pass Tests):**

  - [x] Add conditional `cn()` class for ring highlight keyed on `selected` prop

  **REFACTOR (Clean Up):**

  - [x] Verify ring integrates with existing `border-l-4` styles
  - [x] Add Selected story variant to `feature-node.stories.tsx`

  #### 2B: FeaturesCanvas Interaction and Contextual Add Callbacks

  **RED (Write Failing Tests First):**

  - [x]Write test: FeaturesCanvas accepts and passes `onNodeClick` prop
  - [x]Write test: FeaturesCanvas accepts and passes `onPaneClick` prop
  - [x]Write test: FeaturesCanvas wires `onRepositoryAdd` to RepositoryNode `onAdd`
  - [x]Write test: FeaturesCanvas wires `onNodeAction` to FeatureNode `onAction`

  **GREEN (Implement to Pass Tests):**

  - [x]Add `onNodeClick`, `onPaneClick`, `onRepositoryAdd`, `onNodeAction` to `FeaturesCanvasProps`
  - [x]Pass `onNodeClick`/`onPaneClick` through to `<ReactFlow>` component
  - [x]Wire `onRepositoryAdd`/`onNodeAction` to nodes in enrichment `useMemo`

  **REFACTOR (Clean Up):**

  - [x]Update type exports in index.ts
  - [x]Add Interactive story variant

  ### Phase 3: State Management Hook (Selection + Contextual Add)

  **RED — Selection & Keyboard (Write Failing Tests First):**

  - [x]Write test: returns selectedNode when FeatureNode selected
  - [x]Write test: returns null when no selection
  - [x]Write test: Escape key clears selection

  **GREEN — Selection & Keyboard:**

  - [x]Implement `useOnSelectionChange` for selection tracking
  - [x]Add `useEffect` with keydown listener for Escape

  **RED — Contextual Add Handlers (Write Failing Tests First):**

  - [x]Write test: `handleAddFeatureToRepo` adds node + edge
  - [x]Write test: `handleAddFeatureToFeature` adds node + edge
  - [x]Write test: `handleAddFeature` adds unconnected node
  - [x]Write test: new node positioned at source.x + 350
  - [x]Write test: new node is auto-selected

  **GREEN — Contextual Add Handlers:**

  - [x]Implement add handlers using `useReactFlow` (`addNodes`, `addEdges`, `getNode`)
  - [x]Calculate position from source node position

  **REFACTOR (Clean Up):**

  - [x]Ensure all callbacks properly memoized
  - [x]Extract `createDefaultFeatureNode` factory helper
  - [x]Deduplicate add logic between repo/feature handlers

  ### Phase 4: Toolbar — REMOVED

  ~~Toolbar was removed in favor of contextual (+) node actions and empty state CTA
  for a cleaner canvas-first UX (task-5 removed).~~

  ### Phase 5: Orchestrator Integration

  **RED:**

  - [x]Write test: renders FeaturesCanvas with nodes and edges
  - [x]Write test: shows empty state when no nodes provided
  - [x]Write test: wires onRepositoryAdd to FeaturesCanvas
  - [x]Write test: wires onNodeAction to FeaturesCanvas

  **GREEN:**

  - [x]Compose all sub-components in ControlCenter
  - [x]Wire useControlCenterState hook
  - [x]Connect callbacks, contextual add handlers, and state

  **REFACTOR:**

  - [x]Add comprehensive Storybook stories (Empty, WithFeatures, WithToolbar, WithNodeActions)
  - [x]Verify no unnecessary re-renders

  ### Phase 6: DI Bridge + Feature Type Props — SUPERSEDED

  ~~Superseded by tasks 15-22 (@shepai/core extraction plan).
  Original task-8 replaced by phases 12-18.~~

  ### Phase 7: Build Validation

  - [x]`pnpm lint:web` passes
  - [x]`pnpm typecheck:web` passes
  - [x]`pnpm build:storybook` passes
  - [x]`pnpm build:web` passes
  - [x]All unit tests pass (`pnpm test:unit`)

  ### Phase 8: Lifecycle Alignment

  **RED:**

  - [x]Write test: lifecycleDisplayLabels maps maintain to COMPLETED
  - [x]Write test: lifecycleDisplayLabels maps deploy to DEPLOY & QA

  **GREEN:**

  - [x]Update FeatureLifecyclePhase type union (plan→research, test→review, maintenance→maintain)
  - [x]Add lifecycleDisplayLabels const in feature-node-state-config.ts
  - [x]Update feature-node.tsx to use lifecycleDisplayLabels[data.lifecycle]
  - [x]Fix lifecycleMap in page.tsx to 1:1 domain mapping

  **REFACTOR:**

  - [x]Export lifecycleDisplayLabels from index.ts

  ### Phase 9: Feature State Derivation from Domain Model — SUPERSEDED

  ~~Superseded by task-20 (control center data layer).
  Original task-10 replaced by phase 17.~~

  ### Phase 10: Story Updates

  - [x]Replace old lifecycle values in all story data (plan→research, test→review, maintenance→maintain)
  - [x]Update allLifecycles array
  - [x]Verify AllLifecycles story shows correct display labels
  - [x]pnpm build:storybook passes

  ### Phase 11: Feature Node Badge Improvements (Done)

  - [x] Agent type icons created with AgentTypeValue union type
  - [x] Badge shows lifecycle verb + agent icon + CometSpinner
  - [x] featureId hidden, agentName replaced with agentType
  - [x] All tests and stories updated

  ### Phase 12: Scaffold @shepai/core Package (task-15)

  - [ ] Create `packages/core/package.json` with subpath exports
  - [ ] Create `tsconfig.json` (noEmit) and `tsconfig.build.json` (dist/)
  - [ ] Create empty `src/index.ts` barrel
  - [ ] Update `pnpm-workspace.yaml`: add `packages/core`
  - [ ] `pnpm install` to link workspace
  - [ ] Verify existing `pnpm build` still passes

  ### Phase 13: Move Domain Layer (task-16)

  - [ ] Move `src/domain/` → `packages/core/src/domain/`
  - [ ] Create `packages/core/src/domain/index.ts` barrel
  - [ ] Update `tspconfig.yaml` output dir → `packages/core/src/domain/generated`
  - [ ] Update `tsp:codegen` script prettier path
  - [ ] Update all domain imports across codebase

  ### Phase 14: Move Application Layer (task-17)

  - [ ] Move `src/application/` → `packages/core/src/application/`
  - [ ] Create `packages/core/src/application/index.ts` barrel
  - [ ] **Delete** `ListDashboardFeaturesUseCase` (policy violation)
  - [ ] **Remove** `DashboardFeature` and `listWithAgentRuns()` from `IFeatureRepository`
  - [ ] Update all application imports

  ### Phase 15: Move Infrastructure Layer (task-18)

  - [ ] Move `src/infrastructure/` → `packages/core/src/infrastructure/`
  - [ ] Create `packages/core/src/infrastructure/index.ts` barrel
  - [ ] Convert `@/` alias imports within core to relative paths (~30 files)
  - [ ] Remove `ListDashboardFeaturesUseCase` from DI container
  - [ ] Update CLI imports → `@shepai/core/infrastructure/di`
  - [ ] Update web imports → `@shepai/core/*`
  - [ ] Add `@shepai/core: workspace:*` to web `package.json`
  - [ ] Remove `@cli/*` path from web `tsconfig.json`

  ### Phase 16: Clean Up Root Package (task-19)

  - [ ] Remove moved dependencies from root `package.json`
  - [ ] Update root `tsconfig.build.json`: include only `src/presentation/**/*`
  - [ ] Add `@shepai/core` path mapping to root `tsconfig.json`
  - [ ] Add `@shepai/core` alias to `vitest.config.ts`
  - [ ] Remove unused `tsc-alias` entries

  ### Phase 17: Control Center Data Layer (task-20)

  **RED:**

  - [ ] Write test: deriveNodeState returns done for Maintain lifecycle
  - [ ] Write test: deriveNodeState returns running when tasks have WIP state
  - [ ] Write test: deriveNodeState returns done when all tasks Done
  - [ ] Write test: deriveNodeState returns action-required for Review tasks
  - [ ] Write test: deriveProgress returns correct percentage from plan tasks

  **GREEN:**

  - [ ] Import Feature from `@shepai/core/domain/generated`
  - [ ] `FeatureNodeData extends Feature` with UI callbacks
  - [ ] Add `deriveNodeState()` and `deriveProgress()` utilities
  - [ ] Simplify `page.tsx` — spread Feature directly into node data
  - [ ] Delete `derive-state.ts`
  - [ ] Create `createMockFeature()` helper

  **REFACTOR:**

  - [ ] Update all story data with Feature-compatible shapes
  - [ ] Remove all old FeatureLifecyclePhase references

  ### Phase 18: globalThis Bridge in WebServerService (task-21)

  - [ ] `WebServerService.start()` resolves `ListFeaturesUseCase`, sets `globalThis.__shepUseCases`
  - [ ] CLI `index.ts` — remove globalThis bridge setup
  - [ ] Web `dev-server.ts` — import from `@shepai/core`
  - [ ] Rewrite `web/lib/use-cases.ts` — import Feature from `@shepai/core/domain/generated`

  ### Phase 19: Final Build Validation (task-22)

  - [ ] `pnpm install` — workspace links
  - [ ] `pnpm generate` — TypeSpec to packages/core/
  - [ ] `pnpm --filter @shepai/core build` — core compiles
  - [ ] `pnpm typecheck` + `pnpm typecheck:web` — all types valid
  - [ ] `pnpm test:unit` — all tests pass
  - [ ] `pnpm lint` + `pnpm lint:web` — clean
  - [ ] `pnpm build:web` + `pnpm build:storybook` — build passes
  - [ ] `pnpm build` — full pipeline

  ## TDD Notes

  - **MANDATORY**: All phases with code follow RED -> GREEN -> REFACTOR
  - **RED**: Write failing tests FIRST (never skip this!)
  - **GREEN**: Write minimal code to pass tests
  - **REFACTOR**: Improve code while keeping tests green

  ## Progress Tracking (CRITICAL)

  - **Update checkboxes FREQUENTLY** - as soon as each item is complete!
  - **Don't batch updates** - check off items immediately, not at the end
  - **Commit task.md updates** along with code changes to show progress

  ## Acceptance Checklist

  Before marking feature complete:

  - [ ] All 22 tasks completed (12 done, 2 superseded, 8 new)
  - [ ] @shepai/core package exists with domain, application, infrastructure layers
  - [ ] No domain/application/infrastructure code remains in root src/
  - [ ] Web imports use @shepai/core/* (no @cli/* path aliases)
  - [ ] FeatureNodeData extends generated Feature type
  - [ ] globalThis bridge in WebServerService (not CLI)
  - [ ] Tests passing (`pnpm test`)
  - [ ] Linting clean (`pnpm lint` + `pnpm lint:web`)
  - [ ] Types valid (`pnpm typecheck` + `pnpm typecheck:web`)
  - [ ] Storybook builds (`pnpm build:storybook`)
  - [ ] Web builds (`pnpm build:web`)
  - [ ] Full build pipeline (`pnpm build`)
  - [ ] Components follow tier import rules (013-ui-arch)
  - [ ] PR updated and reviewed

  ---

  _Task breakdown for implementation tracking_
