# Task Breakdown (YAML)
# This is the source of truth. Markdown is auto-generated from this file.

name: feature-drawer
summary: >
  8 tasks across 3 phases. Phase 1 (2 tasks): install vaul and create Tier 0 Drawer primitive
  with stories. Phase 2 (4 tasks): create FeatureDrawer component with TDD tests, Storybook
  stories, and barrel exports. Phase 3 (2 tasks): integrate into ControlCenterInner and
  run final validation.

# Relationships
relatedFeatures: []
technologies:
  - vaul
  - React 19
  - Tailwind CSS v4
  - Storybook
  - Vitest
relatedLinks: []

# Structured task list
tasks:
  - id: task-1
    phaseId: phase-1
    title: 'Install vaul dependency'
    description: >
      Add vaul as a dependency to @shepai/web package.json and install it. Verify the installed
      version is compatible with React 19 by checking peer dependencies. Run pnpm install to
      update the lockfile.
    state: Todo
    dependencies: []
    acceptanceCriteria:
      - 'vaul appears in src/presentation/web/package.json dependencies'
      - 'pnpm install completes without peer dependency warnings for React 19'
      - 'pnpm typecheck:web passes (no type errors from new dependency)'
    tdd: null
    estimatedEffort: '10min'

  - id: task-2
    phaseId: phase-1
    title: 'Create Tier 0 Drawer UI primitive and Storybook stories'
    description: >
      Create drawer.tsx in components/ui/ wrapping Vaul with styled sub-components following the
      sheet.tsx pattern. Export: Drawer, DrawerPortal, DrawerOverlay, DrawerClose, DrawerTrigger,
      DrawerContent, DrawerHeader, DrawerFooter, DrawerTitle, DrawerDescription. Support all four
      directions via a direction prop on DrawerContent. Use data-slot attributes, cn() utility,
      and the same naming conventions as sheet.tsx. Create colocated drawer.stories.tsx with stories
      covering right-side drawer (primary use case), all four directions, and non-modal mode.
    state: Todo
    dependencies:
      - task-1
    acceptanceCriteria:
      - 'drawer.tsx exists in components/ui/ with all sub-components exported'
      - 'DrawerContent accepts direction prop (top/right/bottom/left) with correct positioning classes'
      - 'Non-modal mode works (modal={false} passed through to Vaul Root)'
      - 'Close button renders with XIcon and sr-only label, positioned absolute top-right'
      - 'All sub-components use data-slot attributes matching the sheet.tsx convention'
      - 'drawer.stories.tsx exists with stories for right-side drawer, all directions, and non-modal variant'
      - 'Storybook renders without errors'
      - 'pnpm typecheck:web passes'
    tdd:
      red:
        - 'Write Storybook stories first: Default (right-side, modal), RightNonModal, AllDirections, WithContent'
        - 'Stories will fail to render because drawer.tsx does not exist yet'
      green:
        - 'Create drawer.tsx wrapping Vaul primitives with styled sub-components'
        - 'Apply direction-specific positioning classes on DrawerContent (inset-y-0 right-0 for right, etc.)'
        - 'Set --initial-transform CSS variable based on direction for Vaul animation'
        - 'Add close button with XIcon matching sheet.tsx pattern'
        - 'Stories render correctly in Storybook'
      refactor:
        - 'Verify className merging works correctly with cn() for all direction variants'
        - 'Ensure prop spreading and TypeScript types are clean'
    estimatedEffort: '1.5h'

  - id: task-3
    phaseId: phase-2
    title: 'Write unit tests for FeatureDrawer content rendering (RED)'
    description: >
      Write Vitest unit tests for the FeatureDrawer component BEFORE implementing it. Tests
      should cover: (1) drawer renders nothing when selectedNode is null, (2) header section
      displays name and featureId, (3) status section shows lifecycle label from
      lifecycleDisplayLabels, (4) status section shows state badge with correct icon and label
      from featureNodeStateConfig, (5) progress bar renders when progress > 0, (6) details
      section shows/hides optional fields (description, agentName, runtime, blockedBy,
      errorMessage), (7) onClose callback is invoked. Use React Testing Library with data-slot
      or data-testid selectors.
    state: Todo
    dependencies:
      - task-2
    acceptanceCriteria:
      - 'Test file exists at tests/unit/presentation/web/components/common/feature-drawer/feature-drawer.test.tsx'
      - 'Tests cover all 5 feature states (running, action-required, done, blocked, error)'
      - 'Tests cover optional field visibility (description, agentName, runtime, blockedBy, errorMessage)'
      - 'Tests verify header displays name and featureId'
      - 'Tests verify lifecycle label renders from lifecycleDisplayLabels mapping'
      - 'Tests verify state badge icon and label from featureNodeStateConfig'
      - 'Tests verify progress bar renders conditionally'
      - 'Tests verify onClose callback is called when close button is clicked'
      - 'Tests verify nothing renders when selectedNode is null (drawer closed)'
      - 'All tests FAIL (RED phase — component does not exist yet)'
    tdd:
      red:
        - 'Create test file with describe blocks for each section: Header, Status, Details, Close behavior'
        - 'Write test: renders nothing when selectedNode is null'
        - 'Write test: displays feature name and featureId in header'
        - 'Write test: displays lifecycle label from lifecycleDisplayLabels'
        - 'Write test: displays state badge with correct label for each of 5 states'
        - 'Write test: shows progress bar when progress > 0'
        - 'Write test: hides progress bar when progress is 0'
        - 'Write test: shows description when provided, hides when undefined'
        - 'Write test: shows agentName when provided'
        - 'Write test: shows runtime when provided'
        - 'Write test: shows blockedBy when state is blocked'
        - 'Write test: shows errorMessage when state is error'
        - 'Write test: calls onClose when close action triggers'
        - 'Run pnpm test:single <path> — all tests should fail'
      green: []
      refactor: []
    estimatedEffort: '1h'

  - id: task-4
    phaseId: phase-2
    title: 'Implement FeatureDrawer component (GREEN)'
    description: >
      Create feature-drawer.tsx in components/common/feature-drawer/ implementing the minimal
      code to pass all tests from task-3. Component accepts selectedNode (FeatureNodeData | null)
      and onClose (() => void) as props. Uses Drawer primitive from task-2 with direction="right"
      and modal={false}. Three sections separated by Separator: (1) Header — feature name as
      title, featureId as subtitle, (2) Status — lifecycle phase label, state badge with
      icon/color from featureNodeStateConfig, progress bar when progress > 0, (3) Details —
      description, agentName, runtime, blockedBy, errorMessage. Undefined/null fields are hidden.
    state: Todo
    dependencies:
      - task-3
    acceptanceCriteria:
      - 'feature-drawer.tsx exists in components/common/feature-drawer/'
      - 'Component renders Drawer with direction="right" and modal={false}'
      - 'Drawer open state is derived from selectedNode !== null'
      - 'Header section shows name and featureId'
      - 'Status section shows lifecycle label, state badge with icon, and progress bar'
      - 'Details section shows available optional fields and hides undefined ones'
      - 'Close button invokes onClose callback'
      - 'Drawer width is w-96 (384px)'
      - 'All tests from task-3 PASS (GREEN phase)'
      - 'pnpm typecheck:web passes'
    tdd:
      red: []
      green:
        - 'Create feature-drawer.tsx with FeatureDrawerProps interface'
        - 'Implement Drawer.Root with direction="right", modal={false}, open={!!selectedNode}'
        - 'Implement onOpenChange to call onClose when drawer closes'
        - 'Render Header section with feature name and featureId using DrawerHeader/DrawerTitle'
        - 'Render Status section with lifecycle label, state badge (icon + label + colors from config), and progress bar'
        - 'Render Details section with conditional fields using short-circuit rendering'
        - 'Add data-slot attributes to key sections for test selectors (header, status, details)'
        - 'Use Separator between sections, Badge for state, cn() for conditional classes'
        - 'Run pnpm test:single <path> — all tests should pass'
      refactor:
        - 'Extract badge text helper if getBadgeText logic duplicates feature-node.tsx'
        - 'Verify semantic HTML: use heading for title, appropriate ARIA on sections'
        - 'Verify all Tailwind classes use semantic tokens (bg-background, text-foreground, etc.) for dark mode'
    estimatedEffort: '1.5h'

  - id: task-5
    phaseId: phase-2
    title: 'Create FeatureDrawer Storybook stories'
    description: >
      Create feature-drawer.stories.tsx colocated with the component. Stories cover: all 5
      feature states (running, action-required, done, blocked, error), all 6 lifecycle phases,
      with/without optional fields, and a composite AllStates story. Follow the same pattern as
      feature-node.stories.tsx — define data arrays and render each variant.
    state: Todo
    dependencies:
      - task-4
    acceptanceCriteria:
      - 'feature-drawer.stories.tsx exists in components/common/feature-drawer/'
      - 'Stories category is "Composed/FeatureDrawer" matching existing convention'
      - 'Default story shows a running feature with all fields populated'
      - 'AllStates story renders all 5 feature states'
      - 'AllLifecycles story renders all 6 lifecycle phases'
      - 'MinimalFields story renders feature with only required fields (no description, no agent, etc.)'
      - 'Storybook renders without errors'
    tdd:
      red:
        - 'Create stories file with meta, Default, AllStates, AllLifecycles, MinimalFields stories'
        - 'Stories initially fail to render if import path is wrong or component has issues'
      green:
        - 'Wire stories to import FeatureDrawer from the barrel index'
        - 'Define allStatesData array matching feature-node.stories.tsx pattern'
        - 'Define allLifecycles array for lifecycle phase stories'
        - 'Set default args with complete FeatureNodeData for Default story'
        - 'All stories render correctly in Storybook'
      refactor:
        - 'Ensure story data is consistent with feature-node.stories.tsx mock data for visual comparison'
    estimatedEffort: '45min'

  - id: task-6
    phaseId: phase-2
    title: 'Create barrel exports for FeatureDrawer'
    description: >
      Create index.ts in components/common/feature-drawer/ exporting the component and its props
      type. Add the FeatureDrawer export to components/common/index.ts following the existing
      barrel pattern (see FeatureNode, EmptyState, etc.).
    state: Todo
    dependencies:
      - task-4
    acceptanceCriteria:
      - 'index.ts exists in components/common/feature-drawer/ exporting FeatureDrawer and FeatureDrawerProps'
      - 'components/common/index.ts re-exports FeatureDrawer and FeatureDrawerProps'
      - 'Import from "@/components/common" resolves FeatureDrawer correctly'
      - 'pnpm typecheck:web passes'
    tdd: null
    estimatedEffort: '10min'

  - id: task-7
    phaseId: phase-3
    title: 'Integrate FeatureDrawer into ControlCenterInner'
    description: >
      Modify control-center-inner.tsx to render FeatureDrawer as a sibling to FeaturesCanvas.
      Destructure selectedNode from useControlCenterState (already returned but not used in JSX).
      Pass selectedNode and clearSelection (as onClose) to FeatureDrawer. Wrap the return value
      in a Fragment (<>) to render both FeaturesCanvas and FeatureDrawer as siblings.
    state: Todo
    dependencies:
      - task-6
    acceptanceCriteria:
      - 'ControlCenterInner renders FeatureDrawer alongside FeaturesCanvas'
      - 'FeatureDrawer receives selectedNode from useControlCenterState'
      - 'FeatureDrawer receives clearSelection as onClose prop'
      - 'Clicking a feature node on the canvas opens the drawer'
      - 'Clicking the canvas pane closes the drawer'
      - 'Pressing Escape closes the drawer'
      - 'Clicking a different feature node updates drawer content in-place'
      - 'Canvas remains interactive (pan, zoom, drag) while drawer is open'
      - 'pnpm typecheck:web passes'
      - 'pnpm lint:web passes'
    tdd:
      red:
        - 'Write integration test: ControlCenterInner renders FeatureDrawer when selectedNode is set'
        - 'Write integration test: drawer closes when clearSelection is called'
      green:
        - 'Import FeatureDrawer from @/components/common'
        - 'Destructure selectedNode from useControlCenterState return value'
        - 'Wrap JSX return in Fragment, add <FeatureDrawer selectedNode={selectedNode} onClose={clearSelection} />'
        - 'Integration tests pass'
      refactor:
        - 'Verify no unnecessary re-renders of FeaturesCanvas by checking that it does not receive selectedNode as prop'
    estimatedEffort: '30min'

  - id: task-8
    phaseId: phase-3
    title: 'Final validation and cleanup'
    description: >
      Run the full validation suite: typecheck, lint, format, and all tests. Verify Storybook
      builds without errors. Test dark mode rendering. Verify keyboard accessibility (Escape
      closes, Tab navigates drawer content). Fix any issues found during validation.
    state: Todo
    dependencies:
      - task-7
    acceptanceCriteria:
      - 'pnpm typecheck:web passes'
      - 'pnpm lint:web passes with 0 warnings'
      - 'pnpm test passes (all unit tests green)'
      - 'pnpm build:storybook completes without errors'
      - 'Drawer renders correctly in dark mode (no hardcoded colors)'
      - 'Escape key closes the drawer'
      - 'Tab key navigates through drawer content'
      - 'Close button is focusable and has accessible label'
      - 'No console warnings or errors in development mode'
    tdd: null
    estimatedEffort: '30min'

# Total effort estimate
totalEstimate: '6h'

# Open questions
openQuestions: []

# Markdown content (the full tasks document)
content: |
  ## Summary

  8 tasks across 3 phases, estimated at ~6 hours total.

  **Phase 1 (Tier 0 Drawer Primitive)** establishes the foundation: install vaul and create
  the generic Drawer UI component following the sheet.tsx pattern. This produces a reusable
  primitive that any future drawer use case can consume.

  **Phase 2 (Tier 1 FeatureDrawer)** is the core work: TDD-first unit tests covering all 5
  feature states and optional field visibility, followed by the minimal implementation to pass
  those tests, then Storybook stories for visual coverage and barrel exports for clean imports.

  **Phase 3 (Integration)** wires the FeatureDrawer into the actual page by modifying
  ControlCenterInner to pass selectedNode and clearSelection. This is a small change because
  the state management already exists in useControlCenterState — the drawer just needs to
  consume it. Final validation ensures typecheck, lint, tests, and Storybook all pass.

  The TDD cycle is concentrated in Phase 2 tasks 3-4: task-3 writes all failing tests (RED),
  task-4 implements the component to pass them (GREEN) with refactoring. Phase 3 task-7 adds
  lightweight integration tests for the wiring.
