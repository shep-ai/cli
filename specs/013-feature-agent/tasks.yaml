# Task Breakdown (YAML)
# This is the source of truth. Markdown is auto-generated from this file.

name: feature-agent
summary: Task breakdown for 013-feature-agent with 36 tasks across 15 phases (tasks 34-36 out of scope)

# Relationships
relatedFeatures:
  - '008-agent-configuration'
technologies:
  - TypeScript
  - Commander.js
  - LangGraph
  - SQLite
  - Node.js
relatedLinks:
  - file://./specs/013-feature-agent/spec.yaml
  - file://./specs/013-feature-agent/research.yaml
  - file://./specs/013-feature-agent/plan.yaml

# Structured task list
tasks:
  # Phase 1: Foundation & Domain Setup
  - id: task-1
    title: Install LangGraph dependencies
    description: Install @langchain/langgraph, @langchain/core, @langchain/langgraph-checkpoint-sqlite packages
    state: Todo
    dependencies: []
    acceptanceCriteria:
      - Packages installed via pnpm add
      - package.json updated with correct versions
      - pnpm install completes without errors
    tdd: null
    estimatedEffort: 15min

  - id: task-2
    title: Update TypeSpec models for cross-references
    description: Add featureId/repositoryPath to AgentRun, add agentRunId to Feature, compile TypeSpec
    state: Todo
    dependencies:
      - task-1
    acceptanceCriteria:
      - tsp/agents/agent-run.tsp has featureId and repositoryPath optional fields
      - tsp/domain/entities/feature.tsp has agentRunId optional field
      - pnpm tsp:compile passes
      - Generated types in src/domain/generated/output.ts include new fields
    tdd: null
    estimatedEffort: 30min

  # Phase 2: Repository Layer (TDD)
  - id: task-3
    title: Define IFeatureRepository interface
    description: Create application port interface with CRUD methods (create, findById, findBySlug, list, update, delete)
    state: Todo
    dependencies:
      - task-2
    acceptanceCriteria:
      - src/application/ports/output/feature-repository.interface.ts created
      - Interface extends Clean Architecture port pattern
      - All methods properly typed with Feature domain model
      - JSDoc comments explain each method
    tdd:
      red:
        - Write test mocks for IFeatureRepository interface
      green:
        - Define IFeatureRepository with all CRUD methods
      refactor:
        - Add JSDoc, ensure consistent naming with existing ports
    estimatedEffort: 45min

  - id: task-4
    title: Implement SQLiteFeatureRepository with migration
    description: Create SQLite implementation with features table migration (v4), feature mapper, and all CRUD operations
    state: Todo
    dependencies:
      - task-3
    acceptanceCriteria:
      - src/infrastructure/repositories/sqlite-feature.repository.ts created
      - src/infrastructure/persistence/sqlite/mappers/feature.mapper.ts created
      - Migration v4 creates features table with proper indexes
      - All IFeatureRepository methods implemented
      - Unit tests pass for all operations
    tdd:
      red:
        - Write unit tests for create, findById, findBySlug, list with filters, update, delete
        - Write mapper tests for domain <-> SQLite conversion
      green:
        - Implement SQLiteFeatureRepository with all methods
        - Implement feature mapper with JSON serialization for nested fields
        - Add migration v4 with features table schema
      refactor:
        - Extract common query patterns, add error handling, optimize indexes
    estimatedEffort: 2h

  # Phase 3: Git Worktree Service (TDD)
  - id: task-5
    title: Define IWorktreeService interface
    description: Create service port interface with worktree operations (create, remove, list, exists, getWorktreePath)
    state: Todo
    dependencies:
      - task-2
    acceptanceCriteria:
      - src/application/ports/output/worktree-service.interface.ts created
      - WorktreeInfo type defined (path, head, branch, isMain)
      - WorktreeError typed error with codes
      - All methods properly typed
    tdd:
      red:
        - Write test mocks for IWorktreeService
      green:
        - Define IWorktreeService with all operations
      refactor:
        - Add JSDoc, define error codes enum
    estimatedEffort: 30min

  - id: task-6
    title: Implement WorktreeService with execFile
    description: Implement git worktree operations using native execFile with error parsing
    state: Todo
    dependencies:
      - task-5
    acceptanceCriteria:
      - src/infrastructure/services/git/worktree.service.ts created
      - All IWorktreeService methods implemented
      - Typed errors with proper codes (ALREADY_EXISTS, BRANCH_IN_USE, etc.)
      - Unit tests pass for all operations
    tdd:
      red:
        - Write unit tests for create, remove, list, exists operations
        - Write tests for error scenarios (already exists, dirty worktree)
      green:
        - Implement WorktreeService using execFile
        - Parse git stderr patterns into WorktreeError
      refactor:
        - Extract error parsing logic, improve git command construction
    estimatedEffort: 2h

  # Phase 4: Use Cases (TDD)
  - id: task-7
    title: Implement CreateFeatureUseCase
    description: Create use case that creates feature, git branch, worktree, and spawns background agent
    state: Todo
    dependencies:
      - task-4
      - task-6
    acceptanceCriteria:
      - src/application/use-cases/features/create-feature.use-case.ts created
      - Generates slug from description
      - Creates Feature entity in database
      - Creates git branch and worktree
      - Unit tests pass
    tdd:
      red:
        - Write unit tests with mocked repository and worktree service
        - Test slug generation, validation, error handling
      green:
        - Implement CreateFeatureUseCase with feature creation + worktree
      refactor:
        - Extract slug generation utility, improve validation
    estimatedEffort: 1.5h

  - id: task-8
    title: Implement ListFeaturesUseCase
    description: Create use case that lists features with optional repositoryPath and lifecycle filtering
    state: Todo
    dependencies:
      - task-4
    acceptanceCriteria:
      - src/application/use-cases/features/list-features.use-case.ts created
      - Supports filtering by repositoryPath and lifecycle
      - Returns sorted by updatedAt DESC
      - Unit tests pass
    tdd:
      red:
        - Write unit tests with mocked repository
        - Test filtering and sorting
      green:
        - Implement ListFeaturesUseCase with repository.list()
      refactor:
        - Add default sorting, improve filter validation
    estimatedEffort: 45min

  - id: task-9
    title: Implement ShowFeatureUseCase
    description: Create use case that retrieves feature by ID with full details
    state: Todo
    dependencies:
      - task-4
    acceptanceCriteria:
      - src/application/use-cases/features/show-feature.use-case.ts created
      - Retrieves feature by ID
      - Throws error if not found
      - Unit tests pass
    tdd:
      red:
        - Write unit tests with mocked repository
        - Test not found scenario
      green:
        - Implement ShowFeatureUseCase with repository.findById()
      refactor:
        - Improve error messages
    estimatedEffort: 30min

  # Phase 5: LangGraph Agent Foundation (TDD)
  - id: task-10
    title: Create FeatureAgent StateGraph structure
    description: Define FeatureAgentState interface, create StateGraph with node placeholders, set up SQLite checkpointing
    state: Todo
    dependencies:
      - task-1
      - task-2
    acceptanceCriteria:
      - src/infrastructure/services/agents/langgraph/feature-agent-graph.ts created
      - FeatureAgentState interface defined (minimal orchestration fields)
      - StateGraph created with 5 node placeholders
      - SQLite checkpointer configured per-feature
      - Integration test passes for graph initialization
    tdd:
      red:
        - Write integration test for graph creation and checkpointing
      green:
        - Define FeatureAgentState with required fields
        - Create StateGraph with addNode() for analyze/requirements/research/plan/implement
        - Configure SqliteSaver checkpointer
      refactor:
        - Extract state type definitions, improve checkpoint configuration
    estimatedEffort: 1.5h

  - id: task-11
    title: Implement analyze node
    description: Implement first LangGraph node that reads spec, calls IAgentExecutor, writes analysis results
    state: Todo
    dependencies:
      - task-10
    acceptanceCriteria:
      - Analyze node implementation in feature-agent-graph.ts
      - Reads spec.yaml from disk
      - Calls IAgentExecutor.execute() with prompt
      - Writes analysis to spec directory
      - Updates feature.yaml status
      - Integration test passes
    tdd:
      red:
        - Write integration test with mock executor and filesystem
      green:
        - Implement analyze node with file I/O and executor call
      refactor:
        - Extract prompt template, improve error handling
    estimatedEffort: 2h

  # Phase 6: CLI Commands (TDD)
  - id: task-12
    title: Implement feat new command
    description: Create CLI command that creates feature and spawns background agent
    state: Todo
    dependencies:
      - task-7
    acceptanceCriteria:
      - src/presentation/cli/commands/feat/new.command.ts created
      - Parses description argument and options
      - Calls CreateFeatureUseCase
      - Displays success message with feature ID
      - E2E test passes
    tdd:
      red:
        - Write E2E test for feat new command
      green:
        - Implement new.command.ts with Commander API
        - Integrate with CreateFeatureUseCase
      refactor:
        - Extract UI formatting, improve help text
    estimatedEffort: 1.5h

  - id: task-13
    title: Implement feat ls command
    description: Create CLI command that lists features in table format
    state: Todo
    dependencies:
      - task-8
    acceptanceCriteria:
      - src/presentation/cli/commands/feat/ls.command.ts created
      - Supports --repo option for filtering
      - Displays table with ID, Name, Status columns
      - E2E test passes
    tdd:
      red:
        - Write E2E test for feat ls command
      green:
        - Implement ls.command.ts with table formatting
        - Integrate with ListFeaturesUseCase
      refactor:
        - Extract table formatter, add status indicators
    estimatedEffort: 1h

  - id: task-14
    title: Implement feat show command
    description: Create CLI command that shows detailed feature information
    state: Todo
    dependencies:
      - task-9
    acceptanceCriteria:
      - src/presentation/cli/commands/feat/show.command.ts created
      - Displays feature overview, plan, and tasks sections
      - Handles not found error gracefully
      - E2E test passes
    tdd:
      red:
        - Write E2E test for feat show command
      green:
        - Implement show.command.ts with section-based display
        - Integrate with ShowFeatureUseCase
      refactor:
        - Extract section formatters, improve layout
    estimatedEffort: 1h

  # Phase 7: Agent Nodes (TDD)
  - id: task-15
    title: Implement requirements node
    description: Implement LangGraph node for interactive requirements gathering
    state: Todo
    dependencies:
      - task-11
    acceptanceCriteria:
      - Requirements node implementation in feature-agent-graph.ts
      - Reads spec.yaml, calls executor, writes requirements
      - Supports human-in-the-loop with interrupt()
      - Updates feature.yaml status
      - Integration test passes
    tdd:
      red:
        - Write integration test with mock executor and interrupt scenario
      green:
        - Implement requirements node with interrupt() for interactive mode
      refactor:
        - Extract approval logic, improve prompt template
    estimatedEffort: 2h

  - id: task-16
    title: Implement research node
    description: Implement LangGraph node for technical research and decision-making
    state: Todo
    dependencies:
      - task-15
    acceptanceCriteria:
      - Research node implementation in feature-agent-graph.ts
      - Reads requirements, calls executor, writes research.yaml
      - Updates feature.yaml status
      - Integration test passes
    tdd:
      red:
        - Write integration test with research output validation
      green:
        - Implement research node with decision tracking
      refactor:
        - Extract research templates, improve decision formatting
    estimatedEffort: 1.5h

  - id: task-17
    title: Implement plan node
    description: Implement LangGraph node for plan generation with task decomposition
    state: Todo
    dependencies:
      - task-16
    acceptanceCriteria:
      - Plan node implementation in feature-agent-graph.ts
      - Reads research, calls executor, writes plan.yaml and tasks.yaml
      - Updates feature.yaml status
      - Integration test passes
    tdd:
      red:
        - Write integration test with plan validation
      green:
        - Implement plan node with TDD phase generation
      refactor:
        - Extract plan templates, validate task structure
    estimatedEffort: 2h

  - id: task-18
    title: Implement implement node
    description: Implement LangGraph node for autonomous code execution following TDD
    state: Todo
    dependencies:
      - task-17
    acceptanceCriteria:
      - Implement node in feature-agent-graph.ts
      - Reads tasks.yaml, executes tasks with TDD cycles
      - Updates feature.yaml progress tracking
      - Integration test passes
    tdd:
      red:
        - Write integration test with task execution validation
      green:
        - Implement implement node with TDD enforcement
      refactor:
        - Extract task execution logic, improve progress tracking
    estimatedEffort: 2.5h

  # Phase 8: Background Execution (TDD)
  - id: task-19
    title: Implement background worker with fork()
    description: Create worker entry point that runs LangGraph agent in detached process
    state: Todo
    dependencies:
      - task-18
    acceptanceCriteria:
      - src/infrastructure/services/agents/feature-agent-worker.ts created
      - Accepts --feature-id, --run-id, --repo CLI args
      - Initializes DI container and database connections
      - Executes FeatureAgent graph
      - Sends IPC handshake on startup
      - Integration test passes
    tdd:
      red:
        - Write integration test for worker spawn and IPC
      green:
        - Implement worker with fork() + detached + unref()
        - Add IPC handshake message
      refactor:
        - Extract worker initialization, improve logging
    estimatedEffort: 2h

  - id: task-20
    title: Implement process management and crash recovery
    description: Add PID tracking, liveness check, and resume capability
    state: Todo
    dependencies:
      - task-19
    acceptanceCriteria:
      - CreateFeatureUseCase stores PID in AgentRun
      - ShowFeatureUseCase checks process liveness
      - Crashed processes detected and marked "interrupted"
      - Resume command skeleton created
      - Integration test passes
    tdd:
      red:
        - Write integration tests for PID tracking and crash detection
      green:
        - Add PID storage and liveness check with process.kill(pid, 0)
        - Mark crashed agents as interrupted
      refactor:
        - Extract process management utilities, improve error messages
    estimatedEffort: 1.5h

  # Phase 9: Agent Run CLI Commands (TDD)
  - id: task-21
    title: Implement ListAgentRunsUseCase
    description: Create use case that lists agent runs with optional filtering by status, agent name, or feature ID
    state: Todo
    dependencies:
      - task-20
    acceptanceCriteria:
      - src/application/use-cases/agents/list-agent-runs.use-case.ts created
      - Returns all runs from IAgentRunRepository.list()
      - Unit tests pass
    tdd:
      red:
        - Write unit tests with mocked IAgentRunRepository
        - Test empty list, multiple runs
      green:
        - Implement ListAgentRunsUseCase with repository.list()
      refactor:
        - Add sorting by startedAt DESC
    estimatedEffort: 30min

  - id: task-22
    title: Implement ShowAgentRunUseCase
    description: Create use case that retrieves an agent run by ID with process liveness check
    state: Todo
    dependencies:
      - task-21
    acceptanceCriteria:
      - src/application/use-cases/agents/show-agent-run.use-case.ts created
      - Retrieves run by ID, supports ID prefix matching
      - Checks process liveness via IFeatureAgentProcessService.isAlive()
      - Returns run with live status indicator
      - Unit tests pass
    tdd:
      red:
        - Write unit tests with mocked repository and process service
        - Test not found, prefix match, liveness check
      green:
        - Implement ShowAgentRunUseCase
      refactor:
        - Improve error messages
    estimatedEffort: 45min

  - id: task-23
    title: Implement agent ls and agent show CLI commands
    description: Create shep agent ls (table format) and shep agent show <id> (detail view) commands
    state: Todo
    dependencies:
      - task-22
    acceptanceCriteria:
      - src/presentation/cli/commands/agent/index.ts created (command group)
      - src/presentation/cli/commands/agent/ls.command.ts created
      - src/presentation/cli/commands/agent/show.command.ts created
      - agent ls shows table with ID (8-char), agent name, status (colored), feature ID, started time
      - agent show displays full run details including PID, live status, error, timestamps
      - Commands registered in CLI index
      - Unit tests pass
    tdd:
      red:
        - Write unit tests for agent ls and agent show commands
      green:
        - Implement commands with use case integration and table formatting
      refactor:
        - Extract status color formatting, improve table layout
    estimatedEffort: 1.5h

  # Phase 10: Feature Deletion (TDD)
  - id: task-24
    title: Implement DeleteFeatureUseCase
    description: Create use case that deletes a feature, removes its worktree, and cancels any running agent
    state: Todo
    dependencies:
      - task-9
    acceptanceCriteria:
      - src/application/use-cases/features/delete-feature.use-case.ts created
      - Resolves feature by ID or prefix (reuses ShowFeatureUseCase pattern)
      - Cancels running agent run if present (marks as cancelled)
      - Removes git worktree via IWorktreeService.remove()
      - Deletes feature from IFeatureRepository
      - Unit tests pass for all scenarios (with agent, without, missing worktree)
    tdd:
      red:
        - Write unit tests with mocked repo, worktree service, agent process service, run repo
        - Test deletion with running agent, without agent, with missing worktree
      green:
        - Implement DeleteFeatureUseCase with cleanup orchestration
      refactor:
        - Improve error handling for partial cleanup failures
    estimatedEffort: 1h

  - id: task-25
    title: Implement feat del CLI command
    description: Create shep feat del <id> with interactive confirmation and --force flag
    state: Todo
    dependencies:
      - task-24
    acceptanceCriteria:
      - src/presentation/cli/commands/feat/del.command.ts created
      - Shows feature name and asks confirm("Delete feature X?") by default
      - --force flag skips confirmation
      - Displays success message with deleted feature info
      - Handles errors gracefully (not found, cleanup failures)
      - Command registered in feat index
      - Unit tests pass
    tdd:
      red:
        - Write unit tests for del command (confirm flow, force flag, error handling)
      green:
        - Implement del.command.ts with @inquirer/prompts confirm
      refactor:
        - Extract confirmation UI pattern
    estimatedEffort: 1h

  # Phase 11: Integration & Polish
  - id: task-26
    title: Write E2E tests for complete workflow
    description: Write comprehensive E2E test for feat new -> agent runs -> feat show -> feat del lifecycle
    state: Todo
    dependencies:
      - task-25
      - task-23
    acceptanceCriteria:
      - tests/e2e/cli/feat.test.ts with full workflow test
      - Tests feat new creates feature and starts agent
      - Tests feat ls shows running feature
      - Tests feat show displays details
      - Tests agent ls shows agent runs
      - Tests feat del removes feature and cleans up
      - All E2E tests pass
    tdd:
      red:
        - Write E2E test for complete feature lifecycle
      green:
        - Ensure all CLI commands work end-to-end
      refactor:
        - Extract test utilities, improve test isolation
    estimatedEffort: 2h

  - id: task-27
    title: Update documentation
    description: Update AGENTS.md, add CLI reference for feat and agent commands, validate all tests pass
    state: Todo
    dependencies:
      - task-26
    acceptanceCriteria:
      - AGENTS.md updated with FeatureAgent implementation details
      - docs/cli/feat-commands.md created with feat new/ls/show/del reference
      - docs/cli/agent-commands.md created with agent ls/show reference
      - pnpm test passes (all unit + integration + E2E)
      - pnpm build passes
      - pnpm typecheck passes
      - pnpm lint passes
    tdd: null
    estimatedEffort: 1h

  # === Phase 12: Human-in-the-Loop — Domain & State (TDD) ===
  - id: task-28
    title: Extend TypeSpec models and DB migration for approval workflow
    description: >
      Add waiting_approval to AgentRunStatus enum. Add approvalMode and approvalStatus
      optional fields to AgentRun model. Create migration v6 to add columns to agent_runs
      table. Compile TypeSpec and verify generated types.
    state: Todo
    dependencies:
      - task-27
    acceptanceCriteria:
      - tsp/agents/enums/agent-run-status.tsp includes waiting_approval value
      - tsp/agents/agent-run.tsp includes approvalMode (string, optional) and approvalStatus (string, optional) fields
      - pnpm tsp:compile passes and generated output.ts has new fields
      - Migration v6 adds approval_mode TEXT and approval_status TEXT columns to agent_runs table
      - Agent run repository updateStatus() handles new approval fields
      - Unit tests verify migration creates columns and repository handles approval fields
    tdd:
      red:
        - Write unit test asserting migration v6 creates approval_mode and approval_status columns
        - Write unit test asserting updateStatus() accepts and persists approvalMode and approvalStatus
      green:
        - Update TypeSpec enum and model, run tsp:compile
        - Add migration v6 with ALTER TABLE for new columns
        - Update SQLiteAgentRunRepository.updateStatus() to handle approval fields in the dynamic SET builder
      refactor:
        - Verify all existing tests still pass after migration change
        - Ensure backward compatibility (new columns are nullable)
    estimatedEffort: 1.5h

  - id: task-29
    title: Extend FeatureAgentState with approvalMode field
    description: >
      Add approvalMode optional field to FeatureAgentAnnotation in state.ts. Update
      createFeatureAgentGraph to thread approvalMode through to nodes. Write unit test
      verifying state includes and preserves the field.
    state: Todo
    dependencies:
      - task-28
    acceptanceCriteria:
      - state.ts FeatureAgentAnnotation includes approvalMode as Annotation<string | undefined>
      - approvalMode value is 'interactive' | 'allow-prd' | 'allow-plan' | 'allow-all' | undefined
      - Graph invoke accepts approvalMode in initial state
      - Unit test verifies state propagation through graph
    tdd:
      red:
        - Write unit test creating graph with approvalMode='interactive' in initial state
        - Assert approvalMode is accessible in node function via state parameter
      green:
        - Add approvalMode Annotation to state.ts with reducer that preserves value
      refactor:
        - Add type alias for ApprovalMode union type for reuse
    estimatedEffort: 30min

  # === Phase 13: Human-in-the-Loop — Interrupt Logic & Worker (TDD) ===
  - id: task-30
    title: Add interrupt logic to executeNode helper and all 5 nodes
    description: >
      Add shouldInterrupt() helper function to node-helpers.ts. Modify executeNode() to
      call interrupt() after successful executor completion when approval is required for
      current node. If user rejects, set error state. Import interrupt and Command from
      @langchain/langgraph.
    state: Todo
    dependencies:
      - task-29
    acceptanceCriteria:
      - node-helpers.ts exports shouldInterrupt(approvalMode, nodeName) function
      - shouldInterrupt returns true/false based on approval mode rules
      - executeNode() calls interrupt() after executor.execute() when shouldInterrupt() is true
      - 'interrupt payload includes { node, summary, specDir }'
      - On rejection (decision.approved === false), node returns error state
      - On approval (decision.approved === true), node continues normally
      - All 5 nodes inherit interrupt behavior through executeNode() (no per-node changes needed)
      - Integration test with MemorySaver verifies interrupt pauses graph
      - 'Integration test verifies Command({ resume }) continues graph'
    tdd:
      red:
        - Write shouldInterrupt() unit tests for all 4 modes x 5 nodes (20 cases)
        - Write integration test creating graph with approvalMode='interactive' and MemorySaver
        - Assert graph.invoke() returns after first node with interrupt metadata
        - 'Write test resuming with Command({ resume: { approved: true } }) continues to next node'
        - 'Write test resuming with Command({ resume: { approved: false } }) sets error'
      green:
        - Implement shouldInterrupt(approvalMode, nodeName) with mode-to-node mapping
        - Modify executeNode() to check shouldInterrupt() after executor completes
        - Call interrupt() with payload when approval needed
        - Handle resume value (approved/rejected) and return appropriate state
      refactor:
        - Extract approval mode constants, ensure consistent interrupt payload shape
    estimatedEffort: 3h

  - id: task-31
    title: Update worker to handle interrupt result and support resume mode
    description: >
      Modify feature-agent-worker.ts to detect when graph returns due to interrupt (vs
      completion). On interrupt, update AgentRun status to waiting_approval and exit cleanly.
      Add --approval-mode and --resume CLI args. In resume mode, invoke graph with
      "Command({ resume })" instead of initial state.
    state: Todo
    dependencies:
      - task-30
    acceptanceCriteria:
      - Worker parseWorkerArgs() accepts --approval-mode <mode> and --resume optional flags
      - Worker passes approvalMode to graph initial state
      - Worker detects interrupt result from graph.invoke() return value
      - "On interrupt, worker calls updateStatus(runId, 'waiting_approval', { approvalStatus: 'pending' })"
      - Worker exits with code 0 after interrupt (not an error)
      - 'In resume mode (--resume flag), worker invokes graph.invoke(new Command({ resume: { approved: true } }), config)'
      - Resume mode reuses existing threadId from args for checkpoint lookup
      - FeatureAgentProcessService.spawn() accepts optional approvalMode and resume parameters
      - Integration test verifies worker interrupt → exit → resume cycle
    tdd:
      red:
        - Write unit test for parseWorkerArgs with --approval-mode interactive
        - Write unit test for parseWorkerArgs with --resume flag
        - Write integration test simulating interrupt detection in worker
      green:
        - Add --approval-mode and --resume to parseWorkerArgs()
        - Add interrupt detection logic after graph.invoke() returns
        - Implement resume mode branch in worker main()
        - Update FeatureAgentProcessService.spawn() signature with optional params
      refactor:
        - Extract interrupt detection into helper function
        - Ensure heartbeat stops cleanly on interrupt exit
    estimatedEffort: 2h

  # === Phase 14: Human-in-the-Loop — Approve/Reject CLI (TDD) ===
  - id: task-32
    title: Implement ApproveAgentRunUseCase and RejectAgentRunUseCase
    description: >
      Create use cases for approving and rejecting agent runs waiting for approval.
      Approve: validates status is waiting_approval, updates to approved, spawns resume
      worker. Reject: validates status, updates to failed with rejection reason.
    state: Todo
    dependencies:
      - task-31
    acceptanceCriteria:
      - src/application/use-cases/agents/approve-agent-run.use-case.ts created
      - ApproveAgentRunUseCase validates run status is waiting_approval
      - ApproveAgentRunUseCase updates approvalStatus to approved, creates new AgentRun for resume
      - ApproveAgentRunUseCase calls FeatureAgentProcessService.spawn() with --resume flag
      - src/application/use-cases/agents/reject-agent-run.use-case.ts created
      - RejectAgentRunUseCase validates run status is waiting_approval
      - RejectAgentRunUseCase updates status to failed, approvalStatus to rejected, stores reason in error
      - Both throw clear error if run is not in waiting_approval status
      - Unit tests pass for approve (happy path, wrong status), reject (happy path, wrong status, with reason)
    tdd:
      red:
        - Write unit tests for ApproveAgentRunUseCase with mocked repository, process service
        - Test happy path: waiting_approval → approved → new run spawned
        - Test error: run is 'running' → throws 'Run is not waiting for approval'
        - Write unit tests for RejectAgentRunUseCase with mocked repository
        - Test happy path: waiting_approval → failed with reason
        - Test error: run is 'completed' → throws
      green:
        - Implement ApproveAgentRunUseCase with status validation + spawn
        - Implement RejectAgentRunUseCase with status validation + error recording
      refactor:
        - Extract shared status validation helper
    estimatedEffort: 1.5h

  - id: task-33
    title: Implement approve/reject CLI commands and feat new approval flags
    description: >
      Create shep agent approve <id> and shep agent reject <id> [--reason <text>] commands.
      Add --interactive, --allow-prd, --allow-plan, --allow-all flags to feat new command.
      Register commands and use cases in DI container.
    state: Todo
    dependencies:
      - task-32
    acceptanceCriteria:
      - src/presentation/cli/commands/agent/approve.command.ts created
      - approve command resolves run by ID prefix, calls ApproveAgentRunUseCase, displays success with resume info
      - src/presentation/cli/commands/agent/reject.command.ts created
      - reject command takes optional --reason, resolves run, calls RejectAgentRunUseCase
      - feat new command accepts -i/--interactive, --allow-prd, --allow-plan, --allow-all flags
      - Only one approval mode flag can be active (mutually exclusive validation)
      - Default approval mode is allow-all (current autonomous behavior)
      - CreateFeatureUseCase receives approvalMode and passes to spawn()
      - agent show command displays approval mode and approval status when present
      - Both commands registered in agent/index.ts
      - Both use cases registered in DI container
      - Unit tests pass for CLI commands
    tdd:
      red:
        - Write tests for approve command (happy path, not found, wrong status)
        - Write tests for reject command (with reason, without reason)
        - Write tests for feat new with --interactive flag
        - Write test asserting mutual exclusivity of approval flags
      green:
        - Implement approve.command.ts and reject.command.ts using resolveAgentRun() pattern
        - Add approval mode options to new.command.ts with mutual exclusivity check
        - Update CreateFeatureUseCase.execute() to accept and pass approvalMode
        - Register use cases in container.ts, commands in agent/index.ts
        - Update agent show to display approval fields
      refactor:
        - Extract approval mode validation helper, improve help text
    estimatedEffort: 2h

  # === Phase 15: External Tool Integration — OUT OF SCOPE ===
  # Tasks 34-36 (GitHub/Jira integration) deferred to future work.

  # === Phase 16: Resume Command & Final Integration (TDD) ===
  - id: task-37
    title: Implement ResumeFeatureUseCase
    description: >
      Create use case for resuming interrupted/failed features. Loads feature + last AgentRun,
      validates resumable status, creates new AgentRun record, spawns worker with --resume flag.
    state: Todo
    dependencies:
      - task-31
    acceptanceCriteria:
      - src/application/use-cases/features/resume-feature.use-case.ts created
      - Accepts featureId, resolves feature by ID or prefix match
      - Loads most recent AgentRun for feature (by featureId)
      - Validates run status is interrupted, failed, or waiting_approval
      - Creates new AgentRun record with status=pending, same threadId as original
      - Calls FeatureAgentProcessService.spawn() with --resume and original threadId
      - 'Returns { feature, newRun } on success'
      - Throws if feature not found, no prior run, or run is not resumable
      - Unit tests pass for all scenarios
    tdd:
      red:
        - Write test for happy path: interrupted run → new run spawned
        - Write test for failed run → new run spawned
        - Write test for waiting_approval run → new run spawned
        - Write test for running run → throws 'Agent is still running'
        - Write test for completed run → throws 'Agent already completed'
        - Write test for feature not found → throws
      green:
        - Implement ResumeFeatureUseCase with status validation and spawn
      refactor:
        - Extract resumable status check into predicate function
    estimatedEffort: 1h

  - id: task-38
    title: Implement feat resume CLI command
    description: >
      Create shep feat resume <id> command that resumes a stopped/failed feature's agent.
      Register command in feat/index.ts and use case in DI container.
    state: Todo
    dependencies:
      - task-37
    acceptanceCriteria:
      - src/presentation/cli/commands/feat/resume.command.ts created
      - Command takes <id> argument (supports prefix matching)
      - Calls ResumeFeatureUseCase.execute(featureId)
      - Displays success message with new agent run ID
      - Handles errors gracefully (not found, not resumable)
      - Command registered in feat/index.ts
      - ResumeFeatureUseCase registered in DI container
      - feat show displays suggestion to run resume when feature is interrupted/failed
      - Unit test passes for CLI command
    tdd:
      red:
        - Write test for feat resume <id> happy path
        - Write test for not found error display
        - Write test for not resumable error display
      green:
        - Implement resume.command.ts with Commander API
        - Register in feat/index.ts and container.ts
        - Update feat show to suggest resume
      refactor:
        - Extract ID resolution pattern (shared with del/show)
    estimatedEffort: 1h

  - id: task-39
    title: End-to-end validation and documentation update
    description: >
      Write integration test for full interrupt/resume lifecycle. Validate all tests pass.
      Update AGENTS.md with approval workflow documentation. Update CLI reference docs.
    state: Todo
    dependencies:
      - task-33
      - task-38
    acceptanceCriteria:
      - Integration test for full lifecycle passes (feat new --interactive → pause → approve → complete)
      - AGENTS.md updated with approval workflow section, external tools section, resume section
      - All unit tests pass (pnpm test:unit)
      - All integration tests pass (pnpm test:int)
      - Build passes (pnpm build)
      - Typecheck passes (pnpm typecheck)
      - Lint passes (pnpm lint)
      - TypeSpec compiles (pnpm tsp:compile)
    tdd:
      red:
        - Write integration test creating feature with --interactive approval mode
        - Assert graph pauses after first node
        - Assert agent approve resumes execution
        - Assert full workflow completes
      green:
        - Fix any test failures found during integration
        - Update AGENTS.md with new sections
      refactor:
        - Ensure test isolation, clean up test fixtures
    estimatedEffort: 2h

# Total effort estimate
totalEstimate: 49-53 hours total (35-40h phases 1-11 complete + 13.5h phases 12-16 remaining, tasks 34-36 out of scope)

# Open questions
openQuestions: []

# Markdown content (the full tasks document)
content: |
  ## Status

  - **Phase:** Implementation (gaps phase)
  - **Updated:** 2026-02-12
  - **Total Tasks:** 36 across 15 phases (tasks 34-36 external tools out of scope)

  ## Task List

  ### Phase 1: Foundation & Domain Setup (No TDD)

  - [ ] **Task 1:** Install LangGraph dependencies (15min)
  - [ ] **Task 2:** Update TypeSpec models for cross-references (30min)

  ### Phase 2: Repository Layer (TDD Cycle 1)

  **RED:**
  - [ ] Write unit tests for IFeatureRepository interface
  - [ ] Write unit tests for SQLiteFeatureRepository CRUD operations

  **GREEN:**
  - [ ] **Task 3:** Define IFeatureRepository interface (45min)
  - [ ] **Task 4:** Implement SQLiteFeatureRepository with migration (2h)

  **REFACTOR:**
  - [ ] Extract query patterns, optimize indexes

  ### Phase 3: Git Worktree Service (TDD Cycle 2)

  **RED:**
  - [ ] Write unit tests for IWorktreeService operations
  - [ ] Write tests for error scenarios

  **GREEN:**
  - [ ] **Task 5:** Define IWorktreeService interface (30min)
  - [ ] **Task 6:** Implement WorktreeService with execFile (2h)

  **REFACTOR:**
  - [ ] Extract error parsing, improve error messages

  ### Phase 4: Use Cases (TDD Cycle 3)

  **RED:**
  - [ ] Write unit tests for CreateFeatureUseCase
  - [ ] Write unit tests for ListFeaturesUseCase
  - [ ] Write unit tests for ShowFeatureUseCase

  **GREEN:**
  - [ ] **Task 7:** Implement CreateFeatureUseCase (1.5h)
  - [ ] **Task 8:** Implement ListFeaturesUseCase (45min)
  - [ ] **Task 9:** Implement ShowFeatureUseCase (30min)

  **REFACTOR:**
  - [ ] Extract validation utilities, improve error handling

  ### Phase 5: LangGraph Agent Foundation (TDD Cycle 4)

  **RED:**
  - [ ] Write integration test for graph initialization
  - [ ] Write integration test for analyze node

  **GREEN:**
  - [ ] **Task 10:** Create FeatureAgent StateGraph structure (1.5h)
  - [ ] **Task 11:** Implement analyze node (2h)

  **REFACTOR:**
  - [ ] Extract node factory pattern, improve state transitions

  ### Phase 6: CLI Commands (TDD Cycle 5)

  **RED:**
  - [ ] Write E2E tests for feat new command
  - [ ] Write E2E tests for feat ls command
  - [ ] Write E2E tests for feat show command

  **GREEN:**
  - [ ] **Task 12:** Implement feat new command (1.5h)
  - [ ] **Task 13:** Implement feat ls command (1h)
  - [ ] **Task 14:** Implement feat show command (1h)

  **REFACTOR:**
  - [ ] Extract UI formatters, improve help text

  ### Phase 7: Agent Nodes (TDD Cycle 6)

  **RED:**
  - [ ] Write integration tests for requirements node with interrupt
  - [ ] Write integration tests for research node
  - [ ] Write integration tests for plan node
  - [ ] Write integration tests for implement node

  **GREEN:**
  - [ ] **Task 15:** Implement requirements node (2h)
  - [ ] **Task 16:** Implement research node (1.5h)
  - [ ] **Task 17:** Implement plan node (2h)
  - [ ] **Task 18:** Implement implement node (2.5h)

  **REFACTOR:**
  - [ ] Extract prompt templates, improve error handling

  ### Phase 8: Background Execution (TDD Cycle 7)

  **RED:**
  - [ ] Write integration tests for worker spawn and IPC
  - [ ] Write integration tests for PID tracking and crash detection

  **GREEN:**
  - [ ] **Task 19:** Implement background worker with fork() (2h)
  - [ ] **Task 20:** Implement process management and crash recovery (1.5h)

  **REFACTOR:**
  - [ ] Extract process management utilities, improve logging

  ### Phase 9: Agent Run CLI Commands (TDD Cycle 8)

  **RED:**
  - [ ] Write unit tests for ListAgentRunsUseCase
  - [ ] Write unit tests for ShowAgentRunUseCase
  - [ ] Write unit tests for agent ls/show commands

  **GREEN:**
  - [ ] **Task 21:** Implement ListAgentRunsUseCase (30min)
  - [ ] **Task 22:** Implement ShowAgentRunUseCase (45min)
  - [ ] **Task 23:** Implement agent ls and agent show CLI commands (1.5h)

  **REFACTOR:**
  - [ ] Extract status formatters, improve table layout

  ### Phase 10: Feature Deletion (TDD Cycle 9)

  **RED:**
  - [ ] Write unit tests for DeleteFeatureUseCase
  - [ ] Write unit tests for feat del command

  **GREEN:**
  - [ ] **Task 24:** Implement DeleteFeatureUseCase (1h)
  - [ ] **Task 25:** Implement feat del CLI command (1h)

  **REFACTOR:**
  - [ ] Improve error handling for partial cleanup failures

  ### Phase 11: Integration & Polish

  - [ ] **Task 26:** Write E2E tests for complete workflow (2h)
  - [ ] **Task 27:** Update documentation (1h)

  ---

  ### Phase 12: Human-in-the-Loop — Domain & State (TDD Cycle 10)

  **RED:**
  - [ ] Write tests for migration v6 (approval columns)
  - [ ] Write tests for updateStatus() with approval fields
  - [ ] Write tests for FeatureAgentState approvalMode field

  **GREEN:**
  - [ ] **Task 28:** Extend TypeSpec models and DB migration for approval workflow (1.5h)
  - [ ] **Task 29:** Extend FeatureAgentState with approvalMode field (30min)

  **REFACTOR:**
  - [ ] Verify backward compatibility, existing tests still pass

  ### Phase 13: Human-in-the-Loop — Interrupt Logic & Worker (TDD Cycle 11)

  **RED:**
  - [ ] Write shouldInterrupt() unit tests (4 modes × 5 nodes)
  - [ ] Write integration test for graph interrupt with MemorySaver
  - "[ ] Write integration test for Command({ resume }) continuation"
  - [ ] Write worker interrupt detection test
  - [ ] Write worker resume mode test

  **GREEN:**
  - [ ] **Task 30:** Add interrupt logic to executeNode helper and all 5 nodes (3h)
  - [ ] **Task 31:** Update worker to handle interrupt result and support resume mode (2h)

  **REFACTOR:**
  - [ ] Extract interrupt constants, ensure consistent payload shape

  ### Phase 14: Human-in-the-Loop — Approve/Reject CLI (TDD Cycle 12)

  **RED:**
  - [ ] Write unit tests for ApproveAgentRunUseCase
  - [ ] Write unit tests for RejectAgentRunUseCase
  - [ ] Write CLI tests for approve/reject commands
  - [ ] Write test for feat new approval flags (mutual exclusivity)

  **GREEN:**
  - [ ] **Task 32:** Implement ApproveAgentRunUseCase and RejectAgentRunUseCase (1.5h)
  - [ ] **Task 33:** Implement approve/reject CLI commands and feat new approval flags (2h)

  **REFACTOR:**
  - [ ] Extract shared validation, improve help text

  ### Phase 15: External Tool Integration — OUT OF SCOPE

  Tasks 34-36 (GitHub/Jira integration) deferred to future work.

  ### Phase 16: Resume Command & Final Integration (TDD Cycle 13)

  **RED:**
  - [ ] Write unit tests for ResumeFeatureUseCase
  - [ ] Write CLI test for feat resume command
  - [ ] Write integration test for full interrupt/resume lifecycle

  **GREEN:**
  - [ ] **Task 37:** Implement ResumeFeatureUseCase (1h)
  - [ ] **Task 38:** Implement feat resume CLI command (1h)
  - [ ] **Task 39:** End-to-end validation and documentation update (2h)

  **REFACTOR:**
  - [ ] Clean up test fixtures, ensure isolation

  ## TDD Notes

  - **MANDATORY**: All phases with code follow RED -> GREEN -> REFACTOR
  - **RED**: Write failing tests FIRST (never skip this!)
  - **GREEN**: Write minimal code to pass tests
  - **REFACTOR**: Improve code while keeping tests green

  ## Progress Tracking (CRITICAL)

  - **Update checkboxes FREQUENTLY** - as soon as each item is complete!
  - **Don't batch updates** - check off items immediately, not at the end
  - **Commit tasks.md updates** along with code changes to show progress

  ## Acceptance Checklist

  Before marking feature complete:

  - [ ] All 36 tasks completed (27 + 9 new, tasks 34-36 out of scope)
  - [ ] Tests passing (`pnpm test`)
  - [ ] Linting clean (`pnpm lint`)
  - [ ] Types valid (`pnpm typecheck`)
  - [ ] TypeSpec compiles (`pnpm tsp:compile`)
  - [ ] Documentation updated (AGENTS.md, CLI reference)
  - [ ] Human-in-the-loop workflow functional (interrupt → approve → resume)
  - [x] External tool integration — OUT OF SCOPE (deferred to future work)
  - [ ] Resume command functional (shep feat resume <id>)
  - [ ] PR created and reviewed

  ---

  _Task breakdown updated 2026-02-12 with deferred gap tasks (28-39)_
