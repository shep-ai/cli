# Task Breakdown (YAML)
# This is the source of truth. Markdown is auto-generated from this file.

name: cursor-support
summary: >
  10 tasks across 3 phases implementing Cursor CLI agent support. Phase 1 extracts shared types
  (2 tasks). Phase 2 builds the CursorExecutorService with comprehensive tests (5 tasks).
  Phase 3 wires the executor into factory, validator, TUI, TypeSpec, and validates (3 tasks).

# Relationships
relatedFeatures:
  - 008-agent-configuration

technologies:
  - TypeScript
  - "Cursor CLI (agent binary)"
  - "tsyringe (dependency injection)"
  - "Vitest (testing)"
  - "Node.js child_process (spawn)"
  - "Commander.js (CLI)"
  - "@inquirer/prompts (TUI)"
  - "TypeSpec (domain models)"

relatedLinks: []

# Structured task list
tasks:
  # ── Phase 1: Shared Type Extraction ──────────────────────────────────────

  - id: task-1
    phaseId: phase-1
    title: "Create shared types file with SpawnFunction and ExecFunction"
    description: >
      Create src/infrastructure/services/agents/common/types.ts containing the SpawnFunction
      type (currently in claude-code-executor.service.ts line 26) and ExecFunction type
      (currently in agent-validator.service.ts lines 25-28). Both types are infrastructure
      concerns representing child_process function signatures used by executors and the validator.
    state: Todo
    dependencies: []
    acceptanceCriteria:
      - "types.ts exists at src/infrastructure/services/agents/common/types.ts"
      - "SpawnFunction type is exported with signature: (command: string, args: string[], options?: object) => ChildProcess"
      - "ExecFunction type is exported with signature: (file: string, args: string[]) => Promise<{ stdout: string; stderr: string }>"
      - "File includes JSDoc comments for both types"
      - "File imports ChildProcess from node:child_process"
    tdd:
      red:
        - "Write a type-level test that imports SpawnFunction and ExecFunction from the new types.ts location and asserts they are assignable to the expected signatures"
      green:
        - "Create types.ts with both type exports moved from their current files"
      refactor:
        - "Ensure JSDoc comments are clear and match the originals"

    estimatedEffort: "20min"

  - id: task-2
    phaseId: phase-1
    title: "Update existing imports to use shared types"
    description: >
      Update all files that currently import SpawnFunction from claude-code-executor.service.ts
      and ExecFunction from agent-validator.service.ts to import from the new common/types.ts.
      Remove the type definitions from their original files. Affected files:
      claude-code-executor.service.ts (remove SpawnFunction export, add import),
      agent-executor-factory.service.ts (change import source),
      agent-validator.service.ts (remove ExecFunction export, add import),
      agent-executor-factory.test.ts (change import source).
    state: Todo
    dependencies:
      - task-1
    acceptanceCriteria:
      - "SpawnFunction definition removed from claude-code-executor.service.ts, replaced with import from ../types.js"
      - "ExecFunction definition removed from agent-validator.service.ts, replaced with import from ./types.js"
      - "agent-executor-factory.service.ts imports SpawnFunction from ./types.js instead of executors/claude-code-executor.service.js"
      - "agent-executor-factory.test.ts imports SpawnFunction from common/types.ts path"
      - "All existing tests pass with no behavioral changes (pnpm test:unit)"
      - "TypeScript compilation succeeds (pnpm typecheck)"
    tdd:
      red:
        - "Run existing unit tests — they should pass before the refactor (baseline verification)"
        - "Verify TypeScript compiles with current code (pnpm typecheck)"
      green:
        - "Move SpawnFunction definition from claude-code-executor.service.ts to types.ts, add import"
        - "Move ExecFunction definition from agent-validator.service.ts to types.ts, add import"
        - "Update import in agent-executor-factory.service.ts to reference types.ts"
        - "Update import in agent-executor-factory.test.ts to reference types.ts"
      refactor:
        - "Verify no other files import SpawnFunction or ExecFunction from old locations (grep search)"
        - "Run full test suite to confirm no regressions"
    estimatedEffort: "30min"

  # ── Phase 2: Cursor Executor Implementation ─────────────────────────────

  - id: task-3
    phaseId: phase-2
    title: "Write CursorExecutorService core structure and feature support tests"
    description: >
      Create the test file and initial CursorExecutorService with agentType, constructor,
      SUPPORTED_FEATURES set (streaming, session-resume), and supportsFeature() method.
      This establishes the test infrastructure (createMockChildProcess, buildCursorStreamResult,
      emitStreamData helpers) and verifies the executor's identity and feature declarations.
    state: Todo
    dependencies:
      - task-2
    acceptanceCriteria:
      - "cursor-executor.test.ts exists with describe blocks for agentType and supportsFeature"
      - "CursorExecutorService class exists implementing IAgentExecutor"
      - "agentType returns AgentType.Cursor ('cursor')"
      - "supportsFeature returns true for streaming and session-resume"
      - "supportsFeature returns false for system-prompt, structured-output, and tool-scoping"
      - "Test helpers (createMockChildProcess, emitStreamData) are defined"
    tdd:
      red:
        - "Write test: agentType should be AgentType.Cursor"
        - "Write tests: supportsFeature should return true for streaming, session-resume"
        - "Write tests: supportsFeature should return false for system-prompt, structured-output, tool-scoping"
      green:
        - "Create cursor-executor.service.ts with class skeleton"
        - "Set readonly agentType = 'cursor' as AgentType"
        - "Define SUPPORTED_FEATURES = new Set(['streaming', 'session-resume'])"
        - "Implement supportsFeature() checking the Set"
        - "Accept SpawnFunction via constructor"
      refactor:
        - "Ensure structural parity with ClaudeCodeExecutorService (same field/method ordering)"
        - "Add JSDoc comments matching Claude Code executor style"
    estimatedEffort: "45min"

  - id: task-4
    phaseId: phase-2
    title: "Implement CLI argument building"
    description: >
      Implement buildArgs() and buildStreamArgs() private methods that translate
      AgentExecutionOptions into Cursor CLI flags. Implement buildSpawnOptions() for cwd.
      Add the log() method. Cursor-specific mappings: -p for prompt, -m for model,
      --output-format stream-json, --force for auto-approve, --resume for session resume.
      Unsupported options (systemPrompt, allowedTools, maxTurns, outputSchema) are silently
      omitted. No auth credentials are passed — the binary handles its own auth (matching
      the Claude Code executor pattern).
    state: Todo
    dependencies:
      - task-3
    acceptanceCriteria:
      - "buildArgs() produces correct flags: -p <prompt>, --output-format json, --force"
      - "buildArgs() includes -m <model> when model option is set"
      - "buildArgs() includes --resume <id> when resumeSession option is set"
      - "buildArgs() does NOT include --append-system-prompt, --allowedTools, --max-turns, or --json-schema"
      - "buildArgs() does NOT include any auth flags (no --api-key, no env var forwarding)"
      - "buildStreamArgs() changes output-format from json to stream-json"
      - "buildSpawnOptions() sets cwd when provided"
    tdd:
      red:
        - "Write test: should pass -p flag with prompt text"
        - "Write test: should pass -m flag when model option is set"
        - "Write test: should pass --resume flag when resumeSession option is set"
        - "Write test: should pass --force for auto-approve"
        - "Write test: should pass cwd option to spawn"
        - "Write test: should NOT include --append-system-prompt even when systemPrompt is set"
        - "Write test: should NOT include --allowedTools even when allowedTools is set"
        - "Write test: should NOT include --max-turns even when maxTurns is set"
        - "Write test: should NOT include any auth flags"
      green:
        - "Implement buildArgs() with Cursor-specific flag mapping"
        - "Implement buildStreamArgs() modifying output-format to stream-json"
        - "Implement buildSpawnOptions() with cwd handling"
        - "Implement log() method"
      refactor:
        - "Verify flag order consistency with Claude Code executor"
        - "Ensure all private methods follow single-responsibility"
    estimatedEffort: "1h"

  - id: task-5
    phaseId: phase-2
    title: "Implement execute() with Cursor stream-json parsing"
    description: >
      Implement the execute() method that spawns agent, parses stream-json NDJSON
      lines, accumulates text from assistant events, extracts session_id and duration_ms
      from the result event, and returns an AgentExecutionResult. Key difference from
      Claude Code: the result text comes from assistant events, not the result event.
      Include timeout handling, error cases, and empty result handling.
    state: Todo
    dependencies:
      - task-4
    acceptanceCriteria:
      - "execute() spawns agent with correct arguments"
      - "Result text is accumulated from assistant event message.content[].text fields"
      - "session_id is extracted from the result event"
      - "duration_ms is stored in metadata from the result event"
      - "Token usage is conditionally populated (only if present in result event)"
      - "Non-zero exit codes reject with stderr or generic error message"
      - "Spawn ENOENT errors reject with descriptive message"
      - "Timeout kills the process and rejects with 'timed out' message"
      - "Empty result (no assistant events) returns empty string without crashing"
      - "Malformed JSON lines in stream are skipped gracefully"
      - "user events (echoed input) are skipped"
      - "tool_call events are logged but do not affect result text"
    tdd:
      red:
        - "Write test: should execute prompt and return accumulated result from assistant events"
        - "Write test: should parse session_id from result event"
        - "Write test: should store duration_ms in metadata"
        - "Write test: should handle subprocess errors gracefully (non-zero exit)"
        - "Write test: should handle spawn error event (ENOENT)"
        - "Write test: should apply timeout and kill subprocess"
        - "Write test: should handle empty result gracefully"
        - "Write test: should skip user events (echoed input)"
        - "Write test: should accumulate text from multiple assistant events"
        - "Write test: should log tool_call events without affecting result"
      green:
        - "Implement execute() with line-based NDJSON parsing"
        - "Accumulate text from assistant events in processLine()"
        - "Extract session_id and duration_ms from result event"
        - "Implement timeout logic with setTimeout + proc.kill()"
        - "Implement error handling for close/error events"
      refactor:
        - "Extract logStreamEvent() for Cursor-specific event logging"
        - "Verify structural parity with ClaudeCodeExecutorService.execute()"
    estimatedEffort: "1.5h"

  - id: task-6
    phaseId: phase-2
    title: "Implement executeStream() async generator"
    description: >
      Implement the executeStream() method that returns an AsyncIterable<AgentExecutionStreamEvent>
      yielding events in real time as agent emits NDJSON lines. Implement
      parseStreamLine() that maps Cursor event types to the standard event format:
      assistant -> progress (text from message.content[].text), tool_call completed -> progress
      (tool name summary), result -> result, errors -> error. Uses the same async queue
      pattern as ClaudeCodeExecutorService.
    state: Todo
    dependencies:
      - task-5
    acceptanceCriteria:
      - "executeStream() returns AsyncIterable that yields AgentExecutionStreamEvent items"
      - "assistant events yield progress events with text content"
      - "tool_call events with subtype completed yield progress events with tool summary"
      - "tool_call events with subtype started optionally yield progress events"
      - "result events yield result events with session_id in content"
      - "user events are skipped (not yielded)"
      - "Subprocess failure yields error events with stderr content"
      - "spawn error events yield error events"
      - "All events include timestamp as Date"
      - "Malformed JSON lines yield progress events with raw text (graceful fallback)"
    tdd:
      red:
        - "Write test: should stream execution events (assistant -> progress, result -> result)"
        - "Write test: should yield error events on subprocess failure"
        - "Write test: should include timestamps on all events"
        - "Write test: should map tool_call completed to progress event"
        - "Write test: should skip user events"
        - "Write test: should handle malformed JSON lines as progress"
      green:
        - "Implement parseStreamLine() with Cursor event type mapping"
        - "Implement executeStream() with async queue pattern (enqueue/waitForItem)"
        - "Wire up stdout line-buffer parsing and stderr collection"
        - "Handle close event with remaining buffer flush"
      refactor:
        - "Verify parseStreamLine() handles all Cursor event type/subtype combinations"
        - "Ensure queue pattern matches ClaudeCodeExecutorService structure"
    estimatedEffort: "1.5h"

  - id: task-7
    phaseId: phase-2
    title: "Achieve test coverage target and edge cases"
    description: >
      Review and fill coverage gaps in the CursorExecutorService test suite. Add tests for
      edge cases: multiple assistant events accumulation, tool_call with various tool types
      (shellToolCall, readToolCall, writeToolCall, editToolCall), partial line buffering,
      concurrent stream events, stderr logging, and authentication passthrough verification.
      Target: >=90% branch coverage for cursor-executor.service.ts.
    state: Todo
    dependencies:
      - task-6
    acceptanceCriteria:
      - ">=90% branch coverage for cursor-executor.service.ts"
      - "Test for no auth credentials passed to subprocess (matching Claude Code pattern)"
      - "Test for multiple assistant events producing concatenated result"
      - "Test for tool_call with shellToolCall, readToolCall subtypes"
      - "Test for partial line buffering (data arriving in chunks mid-JSON-line)"
      - "Test for silent mode suppressing log output"
      - "All tests pass (pnpm test:single <path>)"
    tdd:
      red:
        - "Write test: should NOT pass any auth flags or env vars to subprocess"
        - "Write test: should concatenate text from multiple assistant events"
        - "Write test: should parse tool_call events with various tool types"
        - "Write test: should handle partial JSON lines split across data events"
        - "Write test: should suppress logging when silent option is set"
      green:
        - "Verify all tests pass — no new implementation code should be needed if execute/executeStream are correct"
        - "Fix any implementation gaps exposed by edge case tests"
      refactor:
        - "Organize test file with clear describe blocks matching Claude Code test structure"
        - "Extract shared test fixtures if any patterns are repeated"
    estimatedEffort: "1h"

  # ── Phase 3: Integration & Wiring ───────────────────────────────────────

  - id: task-8
    phaseId: phase-3
    title: "Wire Cursor into factory, validator, and TUI"
    description: >
      Add cursor case to AgentExecutorFactory.createExecutor() switch statement (instantiate
      CursorExecutorService with this.spawn). Update getSupportedAgents() to return both
      claude-code and cursor. Add 'cursor': 'agent' to AGENT_BINARY_MAP in
      AgentValidatorService. Update agent-select.prompt.ts to remove disabled property from
      Cursor option and add description string.
    state: Todo
    dependencies:
      - task-7
    acceptanceCriteria:
      - "factory.createExecutor(AgentType.Cursor, config) returns a CursorExecutorService instance"
      - "factory.getSupportedAgents() returns ['claude-code', 'cursor']"
      - "AGENT_BINARY_MAP includes 'cursor': 'agent'"
      - "TUI agent-select prompt shows Cursor as enabled with description 'Cursor AI coding agent'"
      - "Cursor option in TUI does NOT have disabled property"
    tdd:
      red:
        - "Write test: factory should create CursorExecutor for cursor type"
        - "Write test: factory getSupportedAgents should include cursor"
        - "Write test: validator binary map should map cursor to agent"
      green:
        - "Add case 'cursor' to factory switch statement with CursorExecutorService instantiation"
        - "Update getSupportedAgents() to include AgentType.Cursor"
        - "Add 'cursor': 'agent' entry to AGENT_BINARY_MAP"
        - "Remove disabled from Cursor TUI option, add description"
      refactor:
        - "Ensure factory import of CursorExecutorService follows same pattern as ClaudeCodeExecutorService import"
        - "Verify alphabetical or logical ordering consistency"
    estimatedEffort: "45min"

  - id: task-9
    phaseId: phase-3
    title: "Update existing tests and TypeSpec doc comments"
    description: >
      Update agent-executor-factory.test.ts to expect Cursor as a supported agent instead of
      an unsupported one. Update the test that throws for cursor type to verify it creates
      a valid executor instead. Update getSupportedAgents test to expect length 2 with cursor
      included. Update tsp/common/enums/agent-config.tsp Cursor doc comment from "coming soon"
      to supported status. Regenerate TypeSpec types (pnpm tsp:compile).
    state: Todo
    dependencies:
      - task-8
    acceptanceCriteria:
      - "Factory test no longer asserts that cursor throws — asserts it creates a valid executor"
      - "Factory test getSupportedAgents asserts length 2 with both claude-code and cursor"
      - "Factory test 'should not include unsupported agents' no longer lists cursor"
      - "TypeSpec Cursor doc comment reads 'Cursor AI coding agent' (not 'coming soon')"
      - "TypeSpec module-level doc updated to list cursor as supported"
      - "pnpm tsp:compile succeeds and regenerates output.ts"
      - "All unit tests pass (pnpm test:unit)"
    tdd:
      red:
        - "Run existing factory tests — they should fail after task-8 changes (cursor is now supported)"
      green:
        - "Update factory test: change cursor throw assertion to create-executor assertion"
        - "Update factory test: getSupportedAgents expects ['claude-code', 'cursor'] (length 2)"
        - "Update factory test: remove cursor from 'should not include unsupported agents'"
        - "Update TypeSpec enum doc comment for Cursor"
        - "Run pnpm tsp:compile to regenerate types"
      refactor:
        - "Verify test descriptions accurately reflect what they now test"
        - "Ensure no stale comments reference cursor as 'coming soon'"
    estimatedEffort: "45min"

  - id: task-10
    phaseId: phase-3
    title: "Run full validation suite"
    description: >
      Run pnpm validate (lint, format, typecheck, tsp) and pnpm test to verify no regressions.
      Fix any lint, formatting, or type errors introduced by the new code. Verify all success
      criteria from the spec are met.
    state: Todo
    dependencies:
      - task-9
    acceptanceCriteria:
      - "pnpm lint passes with no errors"
      - "pnpm format:check passes"
      - "pnpm typecheck passes"
      - "pnpm typecheck:web passes (no cross-package impact)"
      - "pnpm tsp:compile passes"
      - "pnpm test:unit passes with all tests green"
      - "No regressions in existing Claude Code executor tests"
      - "CursorExecutorService test coverage >=90% branches"
    tdd: null
    estimatedEffort: "30min"

# Total effort estimate
totalEstimate: "8h"

# Open questions
openQuestions: []

# Markdown content (the full tasks document)
content: |
  ## Summary

  The implementation is broken into 10 tasks across 3 phases, following TDD throughout.

  **Phase 1 (Shared Type Extraction)** performs a small prerequisite refactor — extracting
  SpawnFunction and ExecFunction types to a shared file, then updating all imports. This
  decouples executor implementations and unblocks Phase 2.

  **Phase 2 (Cursor Executor Implementation)** is the core work — building the
  CursorExecutorService with its unique stream-json parsing logic, CLI argument mapping,
  authentication handling, and comprehensive unit tests. The work is split into incremental
  slices: core structure/features first, then argument building, then execute(), then
  executeStream(), then edge-case coverage.

  **Phase 3 (Integration & Wiring)** connects the new executor to the existing infrastructure
  with minimal changes to the factory, validator, TUI prompt, and TypeSpec definitions. Existing
  tests are updated to reflect Cursor as a supported agent, and a final validation run ensures
  everything passes.

  Key architectural decision: the CursorExecutorService is a standalone class (not a subclass)
  that mirrors the ClaudeCodeExecutorService pattern. The Cursor stream-json format is different
  enough that shared parsing logic would add complexity rather than reduce it.

  Total estimated effort: ~8 hours of implementation time.
