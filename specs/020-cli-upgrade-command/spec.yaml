# Feature Specification (YAML)
# This is the source of truth. Markdown is auto-generated from this file.

name: cli-upgrade-command
number: 020
branch: feat/020-cli-upgrade-command
oneLiner: Add 'shep upgrade' CLI command that runs npm i -g @shepai/cli to self-upgrade
summary: >
  Add a new top-level CLI command 'shep upgrade' that executes 'npm i -g @shepai/cli@latest'
  as a child process, streams its output to the terminal, and reports success or failure.
  Compares current vs latest version before running. Purely presentation-layer addition
  following existing command patterns.
phase: Requirements
sizeEstimate: S

relatedFeatures: []

technologies:
  - Commander.js
  - Node.js child_process (spawn for streaming output)
  - Vitest

relatedLinks: []

openQuestions:
  - question: 'Should the command check the current version against latest before upgrading?'
    resolved: true
    answer: >
      Recommend yes — display current version and confirm an upgrade is available before
      running npm install. This avoids a no-op install when already on latest and gives
      the user useful feedback. Use the existing IVersionService to get the current version
      and a simple `npm view @shepai/cli version` call to get the latest. If already on
      latest, print a message and exit successfully without running install.

  - question: 'Should the command support upgrading to a specific version (e.g., shep upgrade 1.5.0)?'
    resolved: true
    answer: >
      Recommend no for v1. Keep the command simple — always upgrade to @latest. A version
      argument adds complexity (validation, error messages for invalid versions) with little
      benefit since users can always run `npm i -g @shepai/cli@<version>` directly. Can be
      added in a future iteration if requested.

  - question: 'Should the command use npm, pnpm, or detect the package manager?'
    resolved: true
    answer: >
      Recommend always using npm. The package is published to npm registry and `npm i -g`
      is the canonical global install command. Detecting the user's package manager adds
      complexity and pnpm/yarn global installs have different semantics. npm is universally
      available on any Node.js installation.

  - question: 'Should the command require confirmation before upgrading?'
    resolved: true
    answer: >
      Recommend no interactive confirmation. CLI tools should be scriptable by default.
      The user explicitly typed `shep upgrade` — that is the confirmation. Adding a
      prompt would break non-interactive usage (CI, scripts). The command will display
      what it is about to do before executing, which is sufficient.

  - question: 'Should the command show a spinner or stream npm output directly?'
    resolved: true
    answer: >
      Recommend streaming npm stdout/stderr directly to the terminal (inherit stdio).
      npm install already provides progress output. Wrapping it in a spinner would hide
      useful information (download progress, warnings). Streaming is also simpler to
      implement with spawn and matches user expectations for install commands.

content: |
  ## Problem Statement

  Users currently have no built-in way to upgrade the Shep CLI to the latest version from within
  the tool itself. They must manually run `npm i -g @shepai/cli` in their terminal. A `shep upgrade`
  command provides a convenient self-upgrade mechanism that also shows whether an upgrade is available.

  ## Success Criteria

  - [ ] `shep upgrade` command is registered and appears in `shep --help` output
  - [ ] Running `shep upgrade` when behind latest version executes `npm i -g @shepai/cli@latest` and streams output
  - [ ] Running `shep upgrade` when already on latest version prints an "already up to date" message and exits 0
  - [ ] Command exits with code 0 on success, non-zero on failure
  - [ ] npm spawn failure (e.g., npm not found) is caught and reported with `messages.error()`
  - [ ] Unit tests cover: success path, already-up-to-date path, npm failure path, version check failure path
  - [ ] Command follows existing codebase patterns (factory function, UI utilities, error handling)

  ## Functional Requirements

  - **FR-1**: The CLI SHALL register a top-level `upgrade` command accessible via `shep upgrade`
  - **FR-2**: The command SHALL resolve the current installed version using `IVersionService` from the DI container
  - **FR-3**: The command SHALL check the latest published version by spawning `npm view @shepai/cli version`
  - **FR-4**: If the current version matches the latest version, the command SHALL print an "already up to date" message including the version number and exit with code 0
  - **FR-5**: If a newer version is available, the command SHALL print the current and target versions, then spawn `npm i -g @shepai/cli@latest` with stdout and stderr piped to the terminal
  - **FR-6**: On successful npm install (exit code 0), the command SHALL print a success message
  - **FR-7**: On failed npm install (non-zero exit code), the command SHALL print an error message and set `process.exitCode = 1`
  - **FR-8**: If the version check itself fails (e.g., network error, npm not found), the command SHALL print a warning and proceed with the upgrade anyway (fail-open for version check)
  - **FR-9**: The command description SHALL be `'Upgrade Shep CLI to the latest version'`

  ## Non-Functional Requirements

  - **NFR-1**: The command SHALL use the existing CLI UI utilities (`messages`, `fmt`, `colors`) for all output to maintain visual consistency
  - **NFR-2**: The command SHALL use `child_process.spawn` (not `exec`) to stream output in real-time rather than buffering
  - **NFR-3**: The command file SHALL follow the `createXxxCommand(): Command` factory pattern used by all other commands
  - **NFR-4**: The command SHALL NOT require DI container initialization beyond what already exists (IVersionService is already registered)
  - **NFR-5**: The command SHALL be testable with mocked `child_process.spawn` — no real npm calls in unit tests
  - **NFR-6**: The version check (`npm view`) SHALL have a reasonable timeout (10 seconds) so the command does not hang on network issues

  ## Product Questions & AI Recommendations

  | # | Question | AI Recommendation | Rationale |
  | - | -------- | ----------------- | --------- |
  | 1 | Pre-upgrade version check? | Yes — compare current vs latest | Avoids no-op installs, gives useful UX feedback |
  | 2 | Support specific version arg? | No — always @latest | Keep simple; `npm i -g @shepai/cli@x.y.z` works for advanced users |
  | 3 | Which package manager? | Always npm | Canonical, universal, simple — no detection logic needed |
  | 4 | Interactive confirmation? | No | CLI tools should be scriptable; typing the command is the confirmation |
  | 5 | Spinner vs streaming output? | Stream npm output directly | More informative, simpler to implement, matches install UX expectations |

  ## Affected Areas

  | Area | Impact | Reasoning |
  | ---- | ------ | --------- |
  | `src/presentation/cli/commands/upgrade.command.ts` | High | New file — the upgrade command implementation |
  | `src/presentation/cli/index.ts` | Low | Add one `program.addCommand(createUpgradeCommand())` line and import |
  | `tests/unit/presentation/cli/commands/upgrade.command.test.ts` | High | New file — unit tests for the command |

  ## Dependencies

  - `commander` (already a project dependency)
  - `node:child_process` (Node.js built-in, `spawn` for streaming output)
  - `IVersionService` (already registered in DI container)
  - CLI UI utilities (`messages`, `fmt`, `colors` from `src/presentation/cli/ui/`)

  ## Size Estimate

  **S** — This is a single new command file (~50-60 lines including version check logic),
  one import+registration line in index.ts, and a unit test file. No domain logic, no new
  ports or use cases needed. Purely presentation layer. The version check adds minor
  complexity over a bare spawn but stays well within S scope.
